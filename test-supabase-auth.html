<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Authentication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #0a0a0a;
            color: #e5e5e5;
        }
        h1 {
            color: #8b5cf6;
            margin-bottom: 30px;
        }
        .test-section {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #7c3aed;
        }
        button:disabled {
            background: #525252;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { 
            background: #10b98120; 
            color: #10b981;
            border: 1px solid #10b981;
        }
        .error { 
            background: #ef444420; 
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        .info { 
            background: #3b82f620; 
            color: #60a5fa;
            border: 1px solid #3b82f6;
        }
        .response {
            background: #0a0a0a;
            border: 1px solid #262626;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            color: #a3a3a3;
            max-height: 400px;
            overflow-y: auto;
        }
        h2 {
            color: #a78bfa;
            font-size: 18px;
            margin-bottom: 15px;
        }
        h3 {
            color: #60a5fa;
            font-size: 14px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        input {
            background: #0a0a0a;
            border: 1px solid #404040;
            color: #e5e5e5;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 200px;
        }
        label {
            display: inline-block;
            width: 100px;
            color: #737373;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîê Supabase Authentication Test Suite</h1>

    <!-- Supabase Connection Test -->
    <div class="test-section">
        <h2>1. Supabase Connection</h2>
        <button onclick="testSupabaseConnection()">Test Connection</button>
        <div id="supabase-status"></div>
    </div>

    <!-- Login Test -->
    <div class="test-section">
        <h2>2. Authentication Test</h2>
        <div>
            <label>Email:</label>
            <input type="email" id="email" value="admin@signaldesk.com" />
        </div>
        <div>
            <label>Password:</label>
            <input type="password" id="password" value="admin123" />
        </div>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="testCurrentUser()">Check Current User</button>
        <button onclick="testLogout()">Test Logout</button>
        <div id="auth-status"></div>
    </div>

    <!-- Frontend Login Test -->
    <div class="test-section">
        <h2>3. Frontend Login Flow</h2>
        <button onclick="testFrontendLogin()">Test Frontend Login</button>
        <div id="frontend-status"></div>
    </div>

    <!-- Real-time Monitoring Test -->
    <div class="test-section">
        <h2>4. Real-time Monitoring Access</h2>
        <button onclick="testMonitoringAccess()">Test Monitoring Component</button>
        <div id="monitoring-status"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        window.supabase = supabase;

        // Test Supabase Connection
        window.testSupabaseConnection = async function() {
            const statusDiv = document.getElementById('supabase-status');
            statusDiv.innerHTML = '<div class="status info">Testing connection...</div>';
            
            try {
                // Test database connection
                const { data, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .limit(1);
                
                if (error) throw error;
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Supabase Connected!</div>
                    <div class="response">Connected to: ${supabaseUrl}
Database accessible: Yes
Test query successful</div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Connection Failed</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Test Login
        window.testLogin = async function() {
            const statusDiv = document.getElementById('auth-status');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            statusDiv.innerHTML = '<div class="status info">Logging in...</div>';
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                // Get user profile
                const { data: profile } = await supabase
                    .from('users')
                    .select('*, organization:organizations(*)')
                    .eq('id', data.user.id)
                    .single();
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Login Successful!</div>
                    <div class="response">User: ${data.user.email}
ID: ${data.user.id}
Profile: ${JSON.stringify(profile, null, 2)}
Session Token: ${data.session.access_token.substring(0, 50)}...</div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Login Failed</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Check Current User
        window.testCurrentUser = async function() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status info">Checking current user...</div>';
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    const { data: profile } = await supabase
                        .from('users')
                        .select('*, organization:organizations(*)')
                        .eq('id', user.id)
                        .single();
                    
                    statusDiv.innerHTML = `
                        <div class="status success">‚úÖ User Authenticated</div>
                        <div class="response">Email: ${user.email}
ID: ${user.id}
Profile: ${JSON.stringify(profile, null, 2)}</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status info">No user logged in</div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Error checking user</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Test Logout
        window.testLogout = async function() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.innerHTML = '<div class="status info">Logging out...</div>';
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) throw error;
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Logged out successfully</div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Logout failed</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Test Frontend Login
        window.testFrontendLogin = async function() {
            const statusDiv = document.getElementById('frontend-status');
            statusDiv.innerHTML = '<div class="status info">Testing frontend login flow...</div>';
            
            try {
                // Navigate to frontend
                statusDiv.innerHTML = `
                    <div class="status info">Frontend is running at: http://localhost:3000</div>
                    <div class="response">
1. Open http://localhost:3000 in your browser
2. You should see the login page
3. Login with:
   Email: admin@signaldesk.com
   Password: admin123
4. You should be redirected to the dashboard
5. Real-time monitoring should be accessible</div>
                `;
                
                // Open in new tab
                window.open('http://localhost:3000', '_blank');
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Error</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Test Monitoring Access
        window.testMonitoringAccess = async function() {
            const statusDiv = document.getElementById('monitoring-status');
            statusDiv.innerHTML = '<div class="status info">Testing monitoring access...</div>';
            
            try {
                // First ensure user is logged in
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    statusDiv.innerHTML = `
                        <div class="status error">‚ùå Please login first</div>
                    `;
                    return;
                }
                
                // Test monitoring data access
                const { data: findings, error: findingsError } = await supabase
                    .from('intelligence_findings')
                    .select(`
                        *,
                        target:intelligence_targets(name, type)
                    `)
                    .eq('organization_id', 'demo-org')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (findingsError) throw findingsError;
                
                // Test monitoring runs
                const { data: runs, error: runsError } = await supabase
                    .from('monitoring_runs')
                    .select('*')
                    .eq('organization_id', 'demo-org')
                    .order('started_at', { ascending: false })
                    .limit(5);
                
                if (runsError) throw runsError;
                
                statusDiv.innerHTML = `
                    <div class="status success">‚úÖ Monitoring Access Confirmed</div>
                    <div class="response">Findings: ${findings?.length || 0} found
Monitoring Runs: ${runs?.length || 0} found

Latest findings:
${findings?.map(f => `- ${f.title} (${f.sentiment})`).join('\n') || 'No findings yet'}

To see real-time updates:
1. Go to the dashboard
2. Click on "Real-time Intelligence Monitoring"
3. Click "Run Monitor Now" to trigger monitoring</div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">‚ùå Monitoring access failed</div>
                    <div class="response">Error: ${error.message}</div>
                `;
            }
        };

        // Auto-test connection on load
        window.addEventListener('load', () => {
            setTimeout(testSupabaseConnection, 500);
        });
    </script>
</body>
</html>