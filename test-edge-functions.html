<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Edge Functions</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #5a67d8;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0050b3;
        }
        input {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Supabase Edge Functions</h1>
        
        <div class="test-section">
            <h2>ü§ñ Claude Chat Function</h2>
            <input type="text" id="claude-prompt" placeholder="Enter a message for Claude..." value="Hello Claude, are you working?">
            <br>
            <button onclick="testClaude()">Test Claude Chat</button>
            <button onclick="testClaudeAnalysis()">Test Claude Analysis</button>
            <div id="claude-result"></div>
        </div>

        <div class="test-section">
            <h2>üìä Monitoring Intelligence Function</h2>
            <button onclick="testMonitoringStatus()">Get Monitoring Status</button>
            <button onclick="startMonitoring()">Start Monitoring</button>
            <button onclick="stopMonitoring()">Stop Monitoring</button>
            <div id="monitoring-result"></div>
        </div>

        <div class="test-section">
            <h2>üîç Direct Database Check</h2>
            <button onclick="checkIntelligenceFindings()">Check Intelligence Findings</button>
            <button onclick="checkMonitoringConfig()">Check Monitoring Config</button>
            <div id="database-result"></div>
        </div>

        <div class="test-section">
            <h2>üöÄ Full Integration Test</h2>
            <button onclick="runFullTest()">Run Complete Test Suite</button>
            <div id="full-test-result"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        const ORG_ID = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${content}</div>`;
        }

        async function testClaude() {
            const prompt = document.getElementById('claude-prompt').value;
            showResult('claude-result', 'Testing Claude Chat function...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/claude-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 200
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('claude-result', 
                        `‚úÖ Claude is working!\n\nResponse: ${data.content}\n\nModel: ${data.model}`, 
                        'success'
                    );
                } else {
                    showResult('claude-result', 
                        `‚ùå Claude Error:\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('claude-result', `‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        async function testClaudeAnalysis() {
            showResult('claude-result', 'Testing Claude Analysis...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/claude-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        prompt: 'Analyze this for PR opportunities: "Apple announces new AI features for iPhone"',
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 300
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('claude-result', 
                        `‚úÖ Claude Analysis Working!\n\n${data.content}`, 
                        'success'
                    );
                } else {
                    showResult('claude-result', 
                        `‚ùå Analysis Error:\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('claude-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testMonitoringStatus() {
            showResult('monitoring-result', 'Checking monitoring status...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'getStatus',
                        organizationId: ORG_ID
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('monitoring-result', 
                        `‚úÖ Monitoring Status:\n\nActive: ${data.isActive}\nSources: ${JSON.stringify(data.sources, null, 2)}\nLast Updated: ${data.lastUpdated || 'Never'}`, 
                        'success'
                    );
                } else {
                    showResult('monitoring-result', 
                        `Status Check Result:\n${JSON.stringify(data, null, 2)}`, 
                        data.error ? 'error' : 'info'
                    );
                }
            } catch (error) {
                showResult('monitoring-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function startMonitoring() {
            showResult('monitoring-result', 'Starting monitoring...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'startMonitoring',
                        organizationId: ORG_ID,
                        sources: [
                            { type: 'rss', url: 'https://techcrunch.com/feed/' },
                            { type: 'google_news', query: 'technology AI' }
                        ]
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('monitoring-result', 
                        `‚úÖ Monitoring Started!\n\nStatus: ${data.status}\nMessage: ${data.message}`, 
                        'success'
                    );
                } else {
                    showResult('monitoring-result', 
                        `‚ùå Failed to start:\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('monitoring-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function stopMonitoring() {
            showResult('monitoring-result', 'Stopping monitoring...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'stopMonitoring',
                        organizationId: ORG_ID
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    showResult('monitoring-result', 
                        `‚úÖ Monitoring Stopped!\n\nStatus: ${data.status}`, 
                        'success'
                    );
                } else {
                    showResult('monitoring-result', 
                        `‚ùå Failed to stop:\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('monitoring-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkIntelligenceFindings() {
            showResult('database-result', 'Checking intelligence findings...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/intelligence_findings?limit=5&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (data.length > 0) {
                        showResult('database-result', 
                            `‚úÖ Found ${data.length} findings:\n\n${JSON.stringify(data, null, 2)}`, 
                            'success'
                        );
                    } else {
                        showResult('database-result', 
                            `üìù No findings yet. Start monitoring to generate findings.`, 
                            'info'
                        );
                    }
                } else {
                    showResult('database-result', 
                        `‚ùå Database Error:\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('database-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function checkMonitoringConfig() {
            showResult('database-result', 'Checking monitoring config...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/monitoring_config?organization_id=eq.${ORG_ID}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    if (data.length > 0) {
                        showResult('database-result', 
                            `‚úÖ Monitoring Config:\n\n${JSON.stringify(data[0], null, 2)}`, 
                            'success'
                        );
                    } else {
                        showResult('database-result', 
                            `üìù No config found. Start monitoring to create config.`, 
                            'info'
                        );
                    }
                } else {
                    showResult('database-result', 
                        `Database Response:\n${JSON.stringify(data, null, 2)}`, 
                        'info'
                    );
                }
            } catch (error) {
                showResult('database-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            showResult('full-test-result', 'Running complete test suite...', 'info');
            
            const results = [];
            
            // Test Claude
            try {
                const claudeResponse = await fetch(`${SUPABASE_URL}/functions/v1/claude-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        prompt: 'Say "I am working"',
                        max_tokens: 50
                    })
                });
                const claudeData = await claudeResponse.json();
                results.push(`Claude: ${claudeResponse.ok && claudeData.success ? '‚úÖ Working' : '‚ùå Not working'}`);
            } catch (e) {
                results.push(`Claude: ‚ùå Error - ${e.message}`);
            }

            // Test Monitoring
            try {
                const monitorResponse = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'getStatus',
                        organizationId: ORG_ID
                    })
                });
                const monitorData = await monitorResponse.json();
                results.push(`Monitoring: ${monitorResponse.ok && monitorData.success ? '‚úÖ Working' : '‚ùå Not working'}`);
            } catch (e) {
                results.push(`Monitoring: ‚ùå Error - ${e.message}`);
            }

            // Check Database
            try {
                const dbResponse = await fetch(`${SUPABASE_URL}/rest/v1/organizations?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                results.push(`Database: ${dbResponse.ok ? '‚úÖ Connected' : '‚ùå Not connected'}`);
            } catch (e) {
                results.push(`Database: ‚ùå Error - ${e.message}`);
            }

            const allPassed = results.every(r => r.includes('‚úÖ'));
            showResult('full-test-result', 
                `Test Results:\n\n${results.join('\n')}\n\n${allPassed ? 'üéâ All tests passed!' : '‚ö†Ô∏è Some tests failed'}`, 
                allPassed ? 'success' : 'error'
            );
        }

        // Auto-run full test on load
        window.addEventListener('load', () => {
            setTimeout(runFullTest, 500);
        });
    </script>
</body>
</html>