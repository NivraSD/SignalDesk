<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edge Functions Test - Real Data Verification</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
        .title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .result { margin-top: 10px; padding: 10px; background: #000; overflow-x: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        button { background: #0f0; color: #000; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }
        button:hover { background: #0a0; }
    </style>
</head>
<body>
    <h1>üîç SignalDesk Edge Functions - Real Data Test</h1>
    
    <div class="test">
        <div class="title">Test Configuration</div>
        <div>Organization: Adobe</div>
        <div>Industry: technology</div>
    </div>

    <div class="test">
        <div class="title">1. Test Firecrawl API Directly</div>
        <button onclick="testFirecrawl()">Test Firecrawl</button>
        <div id="firecrawl-result" class="result"></div>
    </div>

    <div class="test">
        <div class="title">2. Test RSS Feed Edge Function</div>
        <button onclick="testRSSFeeds()">Test RSS Feeds</button>
        <div id="rss-result" class="result"></div>
    </div>

    <div class="test">
        <div class="title">3. Test Intelligence Gathering V3</div>
        <button onclick="testIntelligenceGathering()">Test Gathering</button>
        <div id="gathering-result" class="result"></div>
    </div>

    <div class="test">
        <div class="title">4. Test Opportunity Orchestrator</div>
        <button onclick="testOpportunities()">Test Opportunities</button>
        <div id="opportunity-result" class="result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        const FIRECRAWL_API_KEY = 'fc-3048810124b640eb99293880a4ab25d0';

        async function testFirecrawl() {
            const resultDiv = document.getElementById('firecrawl-result');
            resultDiv.innerHTML = 'Testing Firecrawl API...';
            
            try {
                const response = await fetch('https://api.firecrawl.dev/v1/search', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${FIRECRAWL_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'Adobe Photoshop 2024',
                        limit: 3
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Firecrawl Working!</div>
                        <div>Results: ${data.data.length}</div>
                        ${data.data.map(r => `<div>- ${r.title}</div>`).join('')}`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Firecrawl returned no data</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testRSSFeeds() {
            const resultDiv = document.getElementById('rss-result');
            resultDiv.innerHTML = 'Testing RSS Feed Edge Function...';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/source-registry?industry=technology&limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.articles) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ RSS Feeds Working!</div>
                        <div>Articles: ${data.articles.length}</div>
                        ${data.articles.slice(0, 3).map(a => `<div>- ${a.title} (${a.source})</div>`).join('')}`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå No RSS articles returned</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testIntelligenceGathering() {
            const resultDiv = document.getElementById('gathering-result');
            resultDiv.innerHTML = 'Testing Intelligence Gathering V3...';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-gathering-v3`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        discovery: {
                            entities: {
                                competitors: [
                                    { name: 'Canva', importance: 'high' },
                                    { name: 'Figma', importance: 'high' }
                                ],
                                topics: [
                                    { name: 'AI in design', category: 'technology' }
                                ]
                            },
                            topics: [
                                { topic: 'generative AI', category: 'technology' }
                            ]
                        },
                        organization: {
                            name: 'Adobe',
                            industry: 'technology'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.intelligence) {
                    const actions = data.intelligence.entity_actions?.all || [];
                    const hasFirecrawl = actions.some(a => a.data_source === 'firecrawl');
                    const hasRSS = actions.some(a => a.data_source === 'rss');
                    
                    resultDiv.innerHTML = `<div class="success">‚úÖ Intelligence Gathering Working!</div>
                        <div>Total Actions: ${actions.length}</div>
                        <div>From Firecrawl: ${hasFirecrawl ? '‚úÖ' : '‚ùå'}</div>
                        <div>From RSS: ${hasRSS ? '‚úÖ' : '‚ùå'}</div>
                        ${actions.slice(0, 3).map(a => 
                            `<div>- ${a.entity}: ${a.headline} (${a.data_source})</div>`
                        ).join('')}`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå No intelligence gathered</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testOpportunities() {
            const resultDiv = document.getElementById('opportunity-result');
            resultDiv.innerHTML = 'Testing Opportunity Orchestrator...';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/opportunity-orchestrator`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        organization: {
                            name: 'Adobe',
                            industry: 'technology'
                        },
                        config: {
                            opportunity_types: {
                                competitor_weakness: true,
                                narrative_vacuum: true,
                                cascade_effect: true
                            }
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.opportunities) {
                    const hasRealData = data.signals?.competitor_signals?.length > 0 ||
                                       data.signals?.cascade_indicators?.length > 0;
                    
                    resultDiv.innerHTML = `<div class="success">‚úÖ Opportunity Orchestrator Working!</div>
                        <div>Opportunities Found: ${data.opportunities.length}</div>
                        <div>Has Real Signals: ${hasRealData ? '‚úÖ' : '‚ùå (using fallbacks)'}</div>
                        <div>Competitor Signals: ${data.signals?.competitor_signals?.length || 0}</div>
                        <div>RSS/Firecrawl Signals: ${data.signals?.cascade_indicators?.length || 0}</div>
                        ${data.opportunities.slice(0, 3).map(o => 
                            `<div>- ${o.title} (${o.persona})</div>`
                        ).join('')}`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå No opportunities found</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
