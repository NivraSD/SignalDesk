<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignalDesk Pipeline Test with Comprehensive Monitoring</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        .stage {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
        }
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        .status.pending { background: #f0f0f0; color: #666; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
        .org-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            width: 300px;
            margin-right: 10px;
        }
        .metric {
            display: inline-block;
            margin: 5px 10px;
            padding: 8px 15px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
        }
        .metric strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SignalDesk Pipeline Test with Comprehensive Monitoring</h1>
        <p>Test the complete pipeline with enhanced monitoring that aggregates from RSS, Firecrawl, and APIs</p>
        
        <div style="margin: 20px 0;">
            <input type="text" 
                   id="orgName" 
                   class="org-input" 
                   placeholder="Enter organization name" 
                   value="OpenAI">
            <button onclick="runFullPipeline()">‚ñ∂Ô∏è Run Full Pipeline</button>
            <button onclick="testMonitoringOnly()">üì° Test Monitoring Only</button>
            <button onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>

        <!-- Stage 1: Organization Discovery -->
        <div class="stage" id="stage-discovery">
            <div class="stage-header">
                <h3>üîç Organization Discovery</h3>
                <span class="status pending" id="status-discovery">Pending</span>
            </div>
            <div class="results" id="results-discovery" style="display:none;"></div>
        </div>

        <!-- Stage 2: Comprehensive Monitoring -->
        <div class="stage" id="stage-monitoring">
            <div class="stage-header">
                <h3>üì° Comprehensive Monitoring (RSS + Firecrawl + APIs)</h3>
                <span class="status pending" id="status-monitoring">Pending</span>
            </div>
            <div id="monitoring-metrics" style="margin: 10px 0;"></div>
            <div class="results" id="results-monitoring" style="display:none;"></div>
        </div>

        <!-- Stage 3: Data Collection -->
        <div class="stage" id="stage-collection">
            <div class="stage-header">
                <h3>üìä Intelligence Collection</h3>
                <span class="status pending" id="status-collection">Pending</span>
            </div>
            <div class="results" id="results-collection" style="display:none;"></div>
        </div>

        <!-- Stage 4: 5-Stage Analysis -->
        <div class="stage" id="stage-analysis">
            <div class="stage-header">
                <h3>üß† 5-Stage Claude AI Analysis</h3>
                <span class="status pending" id="status-analysis">Pending</span>
            </div>
            <div id="analysis-stages"></div>
            <div class="results" id="results-analysis" style="display:none;"></div>
        </div>

        <!-- Stage 5: Opportunities -->
        <div class="stage" id="stage-opportunities">
            <div class="stage-header">
                <h3>üí° Opportunity Detection</h3>
                <span class="status pending" id="status-opportunities">Pending</span>
            </div>
            <div class="results" id="results-opportunities" style="display:none;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        let organizationProfile = null;
        let monitoringData = null;
        let collectionData = null;
        let stageResults = {};
        
        function updateStatus(stage, status, message) {
            const statusEl = document.getElementById(`status-${stage}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message || status;
        }
        
        function showResults(stage, data) {
            const resultsEl = document.getElementById(`results-${stage}`);
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        async function runFullPipeline() {
            const orgName = document.getElementById('orgName').value;
            if (!orgName) {
                alert('Please enter an organization name');
                return;
            }
            
            clearAll();
            
            try {
                // Stage 1: Organization Discovery
                updateStatus('discovery', 'running', 'Discovering...');
                organizationProfile = await discoverOrganization(orgName);
                updateStatus('discovery', 'success', `‚úÖ ${organizationProfile.name}`);
                showResults('discovery', {
                    name: organizationProfile.name,
                    industry: organizationProfile.industry,
                    competitors: organizationProfile.competitors?.length || 0,
                    keywords: organizationProfile.keywords?.length || 0
                });
                
                // Stage 2: Comprehensive Monitoring
                updateStatus('monitoring', 'running', 'Starting comprehensive monitoring...');
                monitoringData = await startComprehensiveMonitoring(organizationProfile);
                updateStatus('monitoring', 'success', `‚úÖ ${monitoringData.totalSources || 0} sources`);
                
                // Display monitoring metrics
                const metricsEl = document.getElementById('monitoring-metrics');
                metricsEl.innerHTML = `
                    <div class="metric"><strong>RSS:</strong> ${monitoringData.rssCount || 0}</div>
                    <div class="metric"><strong>Firecrawl:</strong> ${monitoringData.firecrawlCount || 0}</div>
                    <div class="metric"><strong>APIs:</strong> ${monitoringData.apiCount || 0}</div>
                    <div class="metric"><strong>Articles:</strong> ${monitoringData.articles?.length || 0}</div>
                `;
                showResults('monitoring', monitoringData);
                
                // Stage 3: Intelligence Collection
                updateStatus('collection', 'running', 'Collecting intelligence...');
                collectionData = await collectIntelligence(organizationProfile);
                updateStatus('collection', 'success', `‚úÖ ${collectionData.raw_signals?.length || 0} signals`);
                showResults('collection', {
                    signals: collectionData.raw_signals?.length || 0,
                    sources: collectionData.metadata?.sources || []
                });
                
                // Stage 4: 5-Stage Analysis
                updateStatus('analysis', 'running', 'Running 5-stage analysis...');
                await runIntelligenceAnalysis(organizationProfile, collectionData);
                updateStatus('analysis', 'success', '‚úÖ Complete');
                
                // Stage 5: Opportunities
                updateStatus('opportunities', 'running', 'Detecting opportunities...');
                const opportunities = await detectOpportunities(stageResults);
                updateStatus('opportunities', 'success', `‚úÖ ${opportunities.length} found`);
                showResults('opportunities', opportunities);
                
            } catch (error) {
                console.error('Pipeline error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function testMonitoringOnly() {
            const orgName = document.getElementById('orgName').value;
            if (!orgName) {
                alert('Please enter an organization name');
                return;
            }
            
            clearAll();
            
            try {
                // Create a mock organization for testing
                const mockOrg = {
                    name: orgName,
                    industry: 'technology',
                    competitors: [
                        { name: 'Microsoft' },
                        { name: 'Google' },
                        { name: 'Anthropic' }
                    ],
                    keywords: ['AI', 'artificial intelligence', 'machine learning']
                };
                
                updateStatus('monitoring', 'running', 'Testing comprehensive monitoring...');
                const result = await startComprehensiveMonitoring(mockOrg);
                updateStatus('monitoring', 'success', `‚úÖ ${result.totalSources || 0} sources monitored`);
                
                // Display metrics
                const metricsEl = document.getElementById('monitoring-metrics');
                metricsEl.innerHTML = `
                    <div class="metric"><strong>RSS Feeds:</strong> ${result.rssCount || 0}</div>
                    <div class="metric"><strong>Firecrawl:</strong> ${result.firecrawlCount || 0}</div>
                    <div class="metric"><strong>APIs:</strong> ${result.apiCount || 0}</div>
                    <div class="metric"><strong>Total Articles:</strong> ${result.articles?.length || 0}</div>
                `;
                
                showResults('monitoring', result);
            } catch (error) {
                console.error('Monitoring test error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function discoverOrganization(orgName) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/organization-discovery`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({ organizationName: orgName })
            });
            
            if (!response.ok) {
                throw new Error(`Discovery failed: ${response.status}`);
            }
            
            const result = await response.json();
            return result.organization;
        }
        
        async function startComprehensiveMonitoring(organization) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    action: 'startMonitoring',
                    organizationId: organization.name,
                    organization: organization
                })
            });
            
            if (!response.ok) {
                throw new Error(`Monitoring failed: ${response.status}`);
            }
            
            const result = await response.json();
            return result.data || result;
        }
        
        async function collectIntelligence(organization) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-collection-v1`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    organization,
                    entities: {
                        competitors: organization.competitors || [],
                        regulators: organization.stakeholders?.regulators || [],
                        media: organization.stakeholders?.media || []
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Collection failed: ${response.status}`);
            }
            
            const result = await response.json();
            return result.intelligence || result;
        }
        
        async function runIntelligenceAnalysis(organization, intelligence) {
            const stages = [
                { num: 1, name: 'competitors', label: 'Competitive Analysis' },
                { num: 2, name: 'media', label: 'Media Analysis' },
                { num: 3, name: 'regulatory', label: 'Regulatory Analysis' },
                { num: 4, name: 'trends', label: 'Trend Analysis' },
                { num: 5, name: 'synthesis', label: 'Intelligence Synthesis' }
            ];
            
            const stagesContainer = document.getElementById('analysis-stages');
            stagesContainer.innerHTML = '';
            
            for (const stage of stages) {
                const stageDiv = document.createElement('div');
                stageDiv.style.margin = '5px 0';
                stageDiv.innerHTML = `Stage ${stage.num} - ${stage.label}: <span id="stage-${stage.num}-status" class="status running">Running...</span>`;
                stagesContainer.appendChild(stageDiv);
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-stage-${stage.num}-${stage.name}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({
                            organization,
                            previousResults: stageResults,
                            intelligence: collectionData
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        stageResults[stage.name] = result;
                        document.getElementById(`stage-${stage.num}-status`).className = 'status success';
                        document.getElementById(`stage-${stage.num}-status`).textContent = '‚úÖ';
                        
                        // Show if we got Claude analysis
                        if (result.metadata?.claude_enhanced) {
                            document.getElementById(`stage-${stage.num}-status`).textContent = '‚úÖ Claude AI';
                        }
                    } else {
                        document.getElementById(`stage-${stage.num}-status`).className = 'status error';
                        document.getElementById(`stage-${stage.num}-status`).textContent = '‚ùå';
                    }
                } catch (error) {
                    document.getElementById(`stage-${stage.num}-status`).className = 'status error';
                    document.getElementById(`stage-${stage.num}-status`).textContent = `‚ùå ${error.message}`;
                }
            }
            
            showResults('analysis', stageResults);
        }
        
        async function detectOpportunities(stageResults) {
            const opportunities = [];
            
            // Extract opportunities from each stage
            Object.values(stageResults).forEach(result => {
                if (result.data?.recommendations) {
                    opportunities.push(...(result.data.recommendations.immediate_actions || []));
                }
            });
            
            return opportunities;
        }
        
        function clearAll() {
            ['discovery', 'monitoring', 'collection', 'analysis', 'opportunities'].forEach(stage => {
                updateStatus(stage, 'pending', 'Pending');
                const resultsEl = document.getElementById(`results-${stage}`);
                if (resultsEl) {
                    resultsEl.style.display = 'none';
                    resultsEl.innerHTML = '';
                }
            });
            
            document.getElementById('monitoring-metrics').innerHTML = '';
            document.getElementById('analysis-stages').innerHTML = '';
            
            organizationProfile = null;
            monitoringData = null;
            collectionData = null;
            stageResults = {};
        }
    </script>
</body>
</html>