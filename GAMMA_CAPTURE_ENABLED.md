# Gamma Capture NOW ENABLED! ✅

## What Changed

I've enabled automatic capture for all Gamma presentations created through NIV.

---

## 🔧 Changes Made

### 1. Updated NIV Orchestrator
**File:** `src/components/execute/NIVContentOrchestratorProduction.tsx`

**Lines 791-793:** Added capture parameters
```typescript
capture: true,
organization_id: organization?.id || 'f3b7f0e4-8c9d-4a1e-9b2f-5d6e7f8a9b0c',
campaign_id: null
```

**Lines 836-843:** Added capture status logging
```typescript
if (statusData.captured) {
  console.log('💾 Presentation captured to SignalDesk!')
}
```

**Lines 1756-1758:** Added user notification
```typescript
if (content?.captured) {
  successContent += '\n\n💾 **Saved to SignalDesk!** This presentation has been captured...'
}
```

### 2. Created Storage Bucket SQL
**File:** `supabase/migrations/20251020_create_presentations_bucket.sql`

Run this in Supabase SQL editor to create the storage bucket for .pptx files.

---

## 🧪 How to Test

### Step 1: Apply Database Changes
```bash
# Run the storage bucket migration in Supabase SQL Editor
cat supabase/migrations/20251020_create_presentations_bucket.sql
# Copy and paste into Supabase SQL Editor
```

### Step 2: Create a Presentation in NIV
1. Open SignalDesk
2. Go to Execute tab
3. Type: "Create a presentation about AI trends in 2024"
4. Wait for Gamma to generate

### Step 3: Check the Logs
Open browser console (F12) and look for:
```
📊 Initial Gamma response: {...}
📊 Status response: {...}
💾 Presentation captured to SignalDesk! { capturedId: '...', pptxUrl: '...' }
```

### Step 4: Verify in Database
```sql
-- Check if presentation was captured
SELECT
  id,
  title,
  gamma_url,
  pptx_url,
  slide_count,
  captured,
  created_at
FROM campaign_presentations
ORDER BY created_at DESC
LIMIT 1;
```

### Step 5: Search for Your Presentation
```typescript
import { searchPresentations } from '@/lib/gammaCapture'

const results = await searchPresentations('AI trends', orgId)
console.log(results)
```

---

## 📋 Expected Behavior

### Before (Old Behavior):
```
User: "Create a presentation about AI"
   ↓
NIV → Gamma API → Generates presentation
   ↓
Returns Gamma URL
   ↓
❌ Nothing saved to SignalDesk
```

### After (New Behavior):
```
User: "Create a presentation about AI"
   ↓
NIV → Gamma API → Generates presentation
   ↓
Edge Function:
  1. Downloads .pptx file
  2. Extracts text content
  3. Uploads to Supabase Storage
  4. Saves to campaign_presentations table
   ↓
Returns: { gammaUrl, captured: true, capturedId }
   ↓
✅ User sees: "💾 Saved to SignalDesk!"
   ↓
✅ Presentation is searchable!
```

---

## 🔍 Troubleshooting

### Issue: "captured: false" in response
**Possible causes:**
1. `organization_id` is missing or invalid
2. Database table doesn't exist (run migration)
3. Storage bucket doesn't exist (run storage migration)
4. Gamma didn't provide download URL

**Check logs for:**
```
⚠️ Presentation was not captured (capture may have failed)
```

**Solution:**
1. Verify `organization_id` exists in database
2. Check Supabase logs for errors
3. Ensure storage bucket "presentations" exists

### Issue: No .pptx URL
**Possible causes:**
1. Gamma API didn't provide `pptxDownloadUrl`
2. Download link expired before capture
3. Storage upload failed

**Check logs for:**
```
📥 Capturing presentation to SignalDesk...
⬇️ Downloading PPTX from Gamma...
📤 Uploading to Supabase Storage...
```

### Issue: Can't find captured presentations
**Possible causes:**
1. Search function not working
2. Wrong organization_id
3. RLS policies blocking access

**Test query:**
```sql
-- Bypass RLS to see all presentations
SELECT * FROM campaign_presentations;
```

---

## 🎯 What Happens Automatically Now

Every time a user creates a Gamma presentation through NIV:

1. ✅ Presentation is generated by Gamma
2. ✅ Edge Function detects `capture: true`
3. ✅ Downloads .pptx file from Gamma
4. ✅ Extracts text content
5. ✅ Uploads .pptx to Supabase Storage
6. ✅ Saves metadata to `campaign_presentations`
7. ✅ Returns `captured: true` to frontend
8. ✅ Shows "💾 Saved to SignalDesk!" message
9. ✅ Presentation is now searchable

---

## 📊 Verify Capture is Working

### Check Browser Console
Look for these messages:
```javascript
📊 Routing to Gamma for presentation
📊 Initial Gamma response: { generationId: "...", capture: true }
📊 Polling Gamma status (attempt 1/60)
✅ Gamma presentation complete!
💾 Presentation captured to SignalDesk! { capturedId: "uuid", pptxUrl: "https://..." }
```

### Check Database
```sql
SELECT
  COUNT(*) as total_captured,
  MAX(created_at) as last_capture
FROM campaign_presentations;
```

### Test Search
```javascript
import { searchPresentations } from '@/lib/gammaCapture'

// Should return results
const results = await searchPresentations('AI', orgId)
console.log(`Found ${results.length} presentations`)
```

---

## 🚀 Next Steps

Now that capture is enabled:

### 1. Deploy Edge Function
```bash
supabase functions deploy gamma-presentation
```

### 2. Create Storage Bucket
Run the SQL from `20251020_create_presentations_bucket.sql` in Supabase

### 3. Test End-to-End
Create a presentation and verify:
- ✅ Presentation appears in Gamma
- ✅ Browser console shows capture success
- ✅ Database has new row
- ✅ Storage has .pptx file
- ✅ Search function finds it

### 4. (Optional) Add UI to View Library
Create a component to display captured presentations:
- List all presentations
- Search functionality
- Download .pptx files
- Preview slides

---

## 💡 Pro Tips

1. **Check Console First**: Always check browser console for capture logs
2. **Verify Organization ID**: Make sure the org ID exists in your database
3. **Test Search**: Use the search function to verify full-text search works
4. **Monitor Storage**: Keep an eye on Supabase Storage usage

---

## ✅ Ready to Test!

Everything is now configured for automatic capture. Next time you create a Gamma presentation through NIV, it will automatically:
- Download the .pptx file
- Save all content to SignalDesk
- Make it searchable
- Show you a confirmation message

Try it now! Create a presentation and watch the magic happen. 🎉
