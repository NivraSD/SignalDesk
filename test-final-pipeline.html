<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Pipeline Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
            color: #fff;
            min-height: 100vh;
        }
        .container {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #00ffcc30;
            box-shadow: 0 0 30px #00ffcc10;
        }
        h1 { 
            color: #00ffcc; 
            text-shadow: 0 0 15px #00ffcc40;
            margin-bottom: 30px;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        input {
            padding: 12px 20px;
            background: #1a1a1a;
            border: 2px solid #00ffcc50;
            color: #fff;
            border-radius: 6px;
            font-size: 16px;
            min-width: 200px;
        }
        input:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 0 0 10px #00ffcc30;
        }
        button {
            background: linear-gradient(135deg, #00ff88, #00ffcc);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px #00ffcc50;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .stage-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .stage-box {
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        .stage-box.running {
            border-color: #ffcc00;
            background: #ffcc0010;
            animation: pulse 1s infinite;
        }
        .stage-box.success {
            border-color: #00ffcc;
            background: #00ffcc10;
        }
        .stage-box.error {
            border-color: #ff4444;
            background: #ff444410;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .results-container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        .result-section {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 6px;
        }
        .opportunity {
            background: #1a1a1a;
            border-left: 4px solid #00ffcc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            color: #00ffcc;
            font-weight: bold;
        }
        .success-banner {
            background: linear-gradient(135deg, #00ff8830, #00ffcc30);
            border: 2px solid #00ffcc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            animation: glow 2s;
        }
        @keyframes glow {
            0% { opacity: 0; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SignalDesk Pipeline Test</h1>
        
        <div class="controls">
            <input type="text" id="orgInput" placeholder="Enter organization name" value="OpenAI">
            <button id="runBtn" onclick="runPipeline()">Run Full Pipeline</button>
            <button onclick="clearAll()">Clear Results</button>
        </div>
        
        <div id="stageContainer" class="stage-container" style="display:none;"></div>
        
        <div id="successBanner" class="success-banner" style="display:none;"></div>
        
        <div id="results" class="results-container" style="display:none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        const STAGES = [
            { id: 'extraction', name: 'Extract', endpoint: 'intelligence-discovery-v3', icon: 'üîç' },
            { id: 'competitive', name: 'Compete', endpoint: 'intelligence-stage-1-competitors', icon: '‚öîÔ∏è' },
            { id: 'stakeholders', name: 'Stakeholder', endpoint: 'intelligence-stage-2-media', icon: 'üë•' },
            { id: 'media', name: 'Media', endpoint: 'intelligence-stage-2-media', icon: 'üì∞' },
            { id: 'regulatory', name: 'Regulatory', endpoint: 'intelligence-stage-3-regulatory', icon: '‚öñÔ∏è' },
            { id: 'trends', name: 'Trends', endpoint: 'intelligence-stage-4-trends', icon: 'üìà' },
            { id: 'synthesis', name: 'Synthesis', endpoint: 'intelligence-stage-5-synthesis', icon: 'üß¨' }
        ];
        
        function clearAll() {
            document.getElementById('stageContainer').innerHTML = '';
            document.getElementById('stageContainer').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('successBanner').style.display = 'none';
            document.getElementById('runBtn').disabled = false;
        }
        
        function initializeStages() {
            const container = document.getElementById('stageContainer');
            container.style.display = 'grid';
            container.innerHTML = STAGES.map(stage => `
                <div id="stage-${stage.id}" class="stage-box">
                    <div style="font-size: 24px;">${stage.icon}</div>
                    <div style="font-size: 12px; margin-top: 5px;">${stage.name}</div>
                    <div id="status-${stage.id}" style="font-size: 10px; margin-top: 5px;">Ready</div>
                </div>
            `).join('');
        }
        
        function updateStage(stageId, status) {
            const box = document.getElementById(`stage-${stageId}`);
            const statusDiv = document.getElementById(`status-${stageId}`);
            
            box.className = `stage-box ${status}`;
            statusDiv.textContent = status === 'running' ? 'Running...' : 
                                   status === 'success' ? '‚úÖ Done' : 
                                   status === 'error' ? '‚ùå Failed' : 'Ready';
        }
        
        async function runPipeline() {
            clearAll();
            document.getElementById('runBtn').disabled = true;
            initializeStages();
            
            const orgName = document.getElementById('orgInput').value || 'OpenAI';
            const organization = { name: orgName };
            const accumulatedResults = {};
            let allSuccess = true;
            
            console.log(`üöÄ Starting pipeline for ${orgName}`);
            
            for (let i = 0; i < STAGES.length; i++) {
                const stage = STAGES[i];
                updateStage(stage.id, 'running');
                
                try {
                    let response;
                    
                    if (stage.id === 'synthesis') {
                        // Synthesis needs all previous results
                        response = await fetch(`${SUPABASE_URL}/functions/v1/${stage.endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            },
                            body: JSON.stringify({
                                organization,
                                previousResults: accumulatedResults,
                                stage1: accumulatedResults.competitive?.data,
                                stage2: accumulatedResults.media?.data,
                                stage3: accumulatedResults.regulatory?.data,
                                stage4: accumulatedResults.trends?.data,
                                monitoring: accumulatedResults.extraction?.intelligence
                            })
                        });
                    } else {
                        response = await fetch(`${SUPABASE_URL}/functions/v1/${stage.endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            },
                            body: JSON.stringify({ organization })
                        });
                    }
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success !== false) {
                        accumulatedResults[stage.id] = data;
                        updateStage(stage.id, 'success');
                        console.log(`‚úÖ ${stage.name} complete`);
                    } else {
                        updateStage(stage.id, 'error');
                        console.error(`‚ùå ${stage.name} failed:`, data.error || 'Unknown error');
                        allSuccess = false;
                        break;
                    }
                } catch (error) {
                    updateStage(stage.id, 'error');
                    console.error(`‚ùå ${stage.name} error:`, error);
                    allSuccess = false;
                    break;
                }
                
                // Small delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Show results
            if (allSuccess) {
                displaySuccess(accumulatedResults, orgName);
            } else {
                displayError();
            }
            
            document.getElementById('runBtn').disabled = false;
        }
        
        function displaySuccess(results, orgName) {
            const synthesis = results.synthesis || {};
            const opportunities = synthesis.opportunities || [];
            const tabs = synthesis.tabs || {};
            
            // Show success banner
            const banner = document.getElementById('successBanner');
            banner.style.display = 'block';
            banner.innerHTML = `
                üéâ <strong>Success!</strong> Complete intelligence analysis for ${orgName} finished in ${STAGES.length} stages
            `;
            
            // Show results
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            resultsDiv.innerHTML = `
                <h2>üìä Pipeline Results</h2>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${STAGES.length}</div>
                        <div>Stages Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${opportunities.length}</div>
                        <div>Opportunities Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(tabs).length}</div>
                        <div>Intel Tabs Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${synthesis.metadata?.data_completeness || 'N/A'}%</div>
                        <div>Data Completeness</div>
                    </div>
                </div>
                
                ${opportunities.length > 0 ? `
                    <div class="result-section">
                        <h3>üí° Strategic Opportunities</h3>
                        ${opportunities.slice(0, 5).map(opp => `
                            <div class="opportunity">
                                <strong>${opp.opportunity || opp.title || 'Opportunity'}</strong>
                                ${opp.pr_angle ? `<p>PR Angle: ${opp.pr_angle}</p>` : ''}
                                ${opp.description ? `<p>${opp.description}</p>` : ''}
                                <small>Priority: ${opp.urgency || 'Medium'}</small>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="result-section">
                    <h3>üìë Intelligence Hub Tabs</h3>
                    <p>Generated ${Object.keys(tabs).length} tabs: ${Object.keys(tabs).join(', ')}</p>
                </div>
                
                <details>
                    <summary style="cursor: pointer; padding: 10px; background: #333; border-radius: 4px;">
                        üîç View Raw Data
                    </summary>
                    <pre>${JSON.stringify(synthesis, null, 2)}</pre>
                </details>
            `;
        }
        
        function displayError() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="result-section" style="border-left: 4px solid #ff4444;">
                    <h3>‚ùå Pipeline Failed</h3>
                    <p>Check the console for error details.</p>
                    <p>Try running again or use a different organization name.</p>
                </div>
            `;
        }
    </script>
</body>
</html>