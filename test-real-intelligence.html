<!DOCTYPE html>
<html>
<head>
    <title>REAL Intelligence Pipeline with ALL Sources</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #0a0a0a; color: #00ff00; }
        .container { max-width: 1400px; margin: 0 auto; }
        button { background: #00ff00; color: #000; padding: 12px 24px; margin: 10px; cursor: pointer; border: none; font-weight: bold; border-radius: 4px; }
        button:hover { background: #00dd00; }
        input { padding: 10px; width: 300px; margin: 5px; background: #1a1a1a; color: #00ff00; border: 1px solid #00ff00; }
        .status { padding: 15px; margin: 15px 0; border: 1px solid #00ff00; background: #0a0a0a; }
        .error { color: #ff0000; border-color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; border-color: #ffaa00; }
        pre { background: #000; padding: 15px; overflow: auto; border: 1px solid #333; max-height: 500px; }
        .tabs { margin: 20px 0; border-bottom: 2px solid #00ff00; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; background: #1a1a1a; margin-right: 5px; border: 1px solid #333; }
        .tab.active { background: #00ff00; color: #000; border-color: #00ff00; }
        .content-section { display: none; padding: 20px; background: #0a0a0a; border: 1px solid #333; }
        .content-section.active { display: block; }
        .data-source { margin: 10px 0; padding: 10px; background: #111; border-left: 3px solid #00ff00; }
        .article { margin: 10px 0; padding: 10px; background: #0f0f0f; border: 1px solid #222; }
        h3 { color: #00ff00; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ REAL Intelligence Pipeline - ALL Data Sources</h1>
        
        <div>
            <h3>Target Organization:</h3>
            <input type="text" id="orgName" value="Mitsui & Co." placeholder="Organization name">
            <input type="text" id="orgUrl" value="https://www.mitsui.com" placeholder="Organization URL">
            <select id="industry" style="padding: 10px; background: #1a1a1a; color: #00ff00; border: 1px solid #00ff00;">
                <option value="conglomerate">Conglomerate/Trading</option>
                <option value="technology">Technology</option>
                <option value="automotive">Automotive</option>
                <option value="finance">Finance</option>
                <option value="healthcare">Healthcare</option>
            </select>
        </div>
        
        <div>
            <button onclick="gatherAllIntelligence()">üéØ Gather ALL Intelligence</button>
            <button onclick="testIndividualSources()">üß™ Test Each Source</button>
            <button onclick="synthesizeWithClaude()">üß† Synthesize with Claude</button>
        </div>
        
        <div id="status"></div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">Overview</div>
            <div class="tab" onclick="showTab('scraper')">Scraper Data</div>
            <div class="tab" onclick="showTab('news')">News Data</div>
            <div class="tab" onclick="showTab('pr')">PR/Competitors</div>
            <div class="tab" onclick="showTab('synthesis')">Claude Analysis</div>
            <div class="tab" onclick="showTab('raw')">Raw Data</div>
        </div>
        
        <div id="overview" class="content-section active"></div>
        <div id="scraper" class="content-section"></div>
        <div id="news" class="content-section"></div>
        <div id="pr" class="content-section"></div>
        <div id="synthesis" class="content-section"></div>
        <div id="raw" class="content-section"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';
        const NEWS_API_KEY = '44466831285e41dfa4c1fb4bf6f1a92f';
        
        // Global storage for all intelligence data
        let intelligenceData = {
            scraper: null,
            news: null,
            pr: null,
            synthesis: null
        };
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        async function testIndividualSources() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="status">üß™ Testing each data source individually...</div>';
            
            const orgName = document.getElementById('orgName').value;
            const orgUrl = document.getElementById('orgUrl').value;
            
            // Test each source
            const results = [];
            
            // 1. Test Scraper
            try {
                status.innerHTML += '<div class="status">Testing scraper...</div>';
                const scraperTest = await fetch(`${SUPABASE_URL}/functions/v1/scraper-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        method: 'scrape',
                        params: { url: orgUrl }
                    })
                });
                const scraperResult = await scraperTest.json();
                results.push(`Scraper: ${scraperResult.success ? '‚úÖ' : '‚ùå'}`);
            } catch (e) {
                results.push(`Scraper: ‚ùå ${e.message}`);
            }
            
            // 2. Test NewsAPI directly
            try {
                status.innerHTML += '<div class="status">Testing NewsAPI...</div>';
                const newsTest = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(orgName)}&language=en&sortBy=publishedAt&pageSize=5&apiKey=${NEWS_API_KEY}`);
                const newsResult = await newsTest.json();
                results.push(`NewsAPI: ${newsResult.status === 'ok' ? '‚úÖ' : '‚ùå'} (${newsResult.articles?.length || 0} articles)`);
            } catch (e) {
                results.push(`NewsAPI: ‚ùå ${e.message}`);
            }
            
            // 3. Test PR Intelligence
            try {
                status.innerHTML += '<div class="status">Testing PR intelligence...</div>';
                const prTest = await fetch(`${SUPABASE_URL}/functions/v1/pr-intelligence`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'gather',
                        params: {
                            organization: { name: orgName, industry: 'conglomerate' },
                            timeframe: '24h'
                        }
                    })
                });
                const prResult = await prTest.json();
                results.push(`PR Intelligence: ${prResult.success ? '‚úÖ' : '‚ùå'}`);
            } catch (e) {
                results.push(`PR Intelligence: ‚ùå ${e.message}`);
            }
            
            // 4. Test Claude
            try {
                status.innerHTML += '<div class="status">Testing Claude synthesizer...</div>';
                const claudeTest = await fetch(`${SUPABASE_URL}/functions/v1/claude-intelligence-synthesizer-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organization: { name: orgName },
                        intelligence_type: 'executive_summary',
                        mcp_data: { test: true }
                    })
                });
                const claudeResult = await claudeTest.json();
                results.push(`Claude: ${claudeResult.success ? '‚úÖ' : '‚ùå'}`);
            } catch (e) {
                results.push(`Claude: ‚ùå ${e.message}`);
            }
            
            status.innerHTML = `
                <div class="status ${results.filter(r => r.includes('‚úÖ')).length > 2 ? 'success' : 'warning'}">
                    <h3>Source Test Results:</h3>
                    ${results.map(r => `<div>${r}</div>`).join('')}
                </div>
            `;
        }
        
        async function gatherAllIntelligence() {
            const orgName = document.getElementById('orgName').value;
            const orgUrl = document.getElementById('orgUrl').value;
            const industry = document.getElementById('industry').value;
            const status = document.getElementById('status');
            
            status.innerHTML = '<div class="status">üöÄ Gathering intelligence from ALL sources...</div>';
            
            try {
                // STEP 1: Scraper Intelligence
                status.innerHTML += '<div class="status">üï∑Ô∏è Scraping website...</div>';
                let scraperData = null;
                try {
                    const scraperResponse = await fetch(`${SUPABASE_URL}/functions/v1/scraper-intelligence`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({
                            method: 'scrape',
                            params: { url: orgUrl }
                        })
                    });
                    scraperData = await scraperResponse.json();
                    intelligenceData.scraper = scraperData.data;
                    console.log('Scraper data:', scraperData);
                } catch (e) {
                    console.error('Scraper error:', e);
                }
                
                // STEP 2: News from NewsAPI (direct call to avoid Edge Function timeout)
                status.innerHTML += '<div class="status">üì∞ Fetching news articles...</div>';
                let newsArticles = [];
                try {
                    // Build search query with organization and competitors
                    const searchQuery = `"${orgName}" OR "${orgName.split(' ')[0]}" OR industry:${industry}`;
                    const newsResponse = await fetch(
                        `https://newsapi.org/v2/everything?q=${encodeURIComponent(searchQuery)}&language=en&sortBy=publishedAt&pageSize=20&apiKey=${NEWS_API_KEY}`
                    );
                    const newsData = await newsResponse.json();
                    
                    if (newsData.status === 'ok' && newsData.articles) {
                        newsArticles = newsData.articles.map(article => ({
                            title: article.title,
                            description: article.description,
                            content: article.content,
                            url: article.url,
                            source: article.source?.name,
                            publishedAt: article.publishedAt,
                            author: article.author,
                            image: article.urlToImage
                        }));
                        intelligenceData.news = {
                            articles: newsArticles,
                            totalArticles: newsData.totalResults,
                            status: 'success'
                        };
                    }
                    console.log('News data:', newsArticles.length, 'articles');
                } catch (e) {
                    console.error('News error:', e);
                    intelligenceData.news = { articles: [], error: e.message };
                }
                
                // STEP 3: PR Intelligence (for competitors)
                status.innerHTML += '<div class="status">üéØ Getting competitor intelligence...</div>';
                let prData = null;
                try {
                    const prResponse = await fetch(`${SUPABASE_URL}/functions/v1/pr-intelligence`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            method: 'gather',
                            params: {
                                organization: {
                                    name: orgName,
                                    industry: industry,
                                    url: orgUrl
                                },
                                timeframe: '24h'
                            }
                        })
                    });
                    prData = await prResponse.json();
                    intelligenceData.pr = prData.data;
                    console.log('PR data:', prData);
                } catch (e) {
                    console.error('PR error:', e);
                }
                
                // Display overview
                document.getElementById('overview').innerHTML = `
                    <h2>Intelligence Gathering Complete</h2>
                    <div class="data-source">
                        <strong>üï∑Ô∏è Scraper:</strong> ${scraperData?.success ? '‚úÖ Success' : '‚ùå Failed'}<br>
                        - Leadership: ${scraperData?.data?.signals?.leadership?.length || 0} items<br>
                        - Press: ${scraperData?.data?.signals?.press?.length || 0} releases<br>
                        - Jobs: ${scraperData?.data?.signals?.jobs?.activePostings || 0} postings
                    </div>
                    <div class="data-source">
                        <strong>üì∞ News:</strong> ${newsArticles.length} articles found<br>
                        - Total available: ${intelligenceData.news?.totalArticles || 0}<br>
                        - Sources: ${[...new Set(newsArticles.map(a => a.source))].slice(0, 5).join(', ')}
                    </div>
                    <div class="data-source">
                        <strong>üéØ Competitors:</strong> ${prData?.data?.intelligenceConfig?.topCompetitors?.length || 0} identified<br>
                        - Industry: ${prData?.data?.summary?.industry || industry}<br>
                        - Insights: ${prData?.data?.insights?.length || 0}
                    </div>
                `;
                
                // Display scraper data
                document.getElementById('scraper').innerHTML = `
                    <h2>Scraped Website Intelligence</h2>
                    <h3>Signals Found:</h3>
                    <pre>${JSON.stringify(scraperData?.data?.signals || {}, null, 2)}</pre>
                    <h3>Patterns Detected:</h3>
                    <pre>${JSON.stringify(scraperData?.data?.patterns || [], null, 2)}</pre>
                `;
                
                // Display news data
                document.getElementById('news').innerHTML = `
                    <h2>News Articles (${newsArticles.length})</h2>
                    ${newsArticles.slice(0, 10).map(article => `
                        <div class="article">
                            <strong>${article.title}</strong><br>
                            <small>${article.source} - ${new Date(article.publishedAt).toLocaleDateString()}</small><br>
                            <p>${article.description || ''}</p>
                            ${article.content ? `<details><summary>Full content</summary>${article.content}</details>` : ''}
                        </div>
                    `).join('')}
                `;
                
                // Display PR data
                document.getElementById('pr').innerHTML = `
                    <h2>PR & Competitor Intelligence</h2>
                    <h3>Competitors (${prData?.data?.intelligenceConfig?.topCompetitors?.length || 0}):</h3>
                    <div>${(prData?.data?.intelligenceConfig?.topCompetitors || []).map(c => `<div class="data-source">${c}</div>`).join('')}</div>
                    <h3>Insights:</h3>
                    <pre>${JSON.stringify(prData?.data?.insights || [], null, 2)}</pre>
                `;
                
                status.innerHTML = `
                    <div class="status success">
                        ‚úÖ Intelligence gathering complete!<br>
                        Click "Synthesize with Claude" to generate analysis from ALL this data.
                    </div>
                `;
                
                return { scraperData, newsArticles, prData };
                
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                console.error('Gathering error:', error);
            }
        }
        
        async function synthesizeWithClaude() {
            const orgName = document.getElementById('orgName').value;
            const industry = document.getElementById('industry').value;
            const status = document.getElementById('status');
            
            // Check if we have data
            if (!intelligenceData.news && !intelligenceData.scraper && !intelligenceData.pr) {
                status.innerHTML = '<div class="status warning">‚ö†Ô∏è Please gather intelligence first!</div>';
                return;
            }
            
            status.innerHTML = '<div class="status">üß† Sending ALL data to Claude for synthesis...</div>';
            
            try {
                // Prepare the complete data package for Claude
                const mcpData = {
                    pr: intelligenceData.pr || {},
                    news: {
                        articles: intelligenceData.news?.articles || [],
                        totalArticles: intelligenceData.news?.totalArticles || 0,
                        breakingNews: (intelligenceData.news?.articles || []).slice(0, 5),
                        industryNews: (intelligenceData.news?.articles || []).slice(0, 10)
                    },
                    scraper: intelligenceData.scraper || {},
                    opportunities: intelligenceData.scraper?.patterns || [],
                    media: {}
                };
                
                console.log('Sending to Claude:', mcpData);
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/claude-intelligence-synthesizer-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organization: {
                            name: orgName,
                            industry: industry,
                            competitors: intelligenceData.pr?.intelligenceConfig?.topCompetitors || []
                        },
                        intelligence_type: 'comprehensive',
                        mcp_data: mcpData,
                        goals: {
                            competitive_advantage: true,
                            risk_mitigation: true,
                            opportunity_identification: true
                        }
                    })
                });
                
                const synthesisData = await response.json();
                intelligenceData.synthesis = synthesisData;
                console.log('Claude synthesis:', synthesisData);
                
                // Display synthesis
                document.getElementById('synthesis').innerHTML = `
                    <h2>Claude Intelligence Analysis</h2>
                    
                    <h3>Executive Summary:</h3>
                    <div class="data-source">
                        ${synthesisData.analysis?.executive_summary || 
                          synthesisData.analysis?.multi_perspective_analysis?.['Executive Intelligence Synthesizer']?.analysis?.analysis ||
                          synthesisData.analysis?.multi_perspective_analysis?.['Executive Intelligence Synthesizer']?.analysis_text ||
                          'No executive summary generated'}
                    </div>
                    
                    <h3>Competitive Analysis:</h3>
                    <div class="data-source">
                        ${synthesisData.analysis?.competitive_analysis || 
                          synthesisData.analysis?.multi_perspective_analysis?.['Competitive PR Strategist']?.analysis?.analysis ||
                          synthesisData.analysis?.multi_perspective_analysis?.['Competitive PR Strategist']?.analysis_text ||
                          'No competitive analysis generated'}
                    </div>
                    
                    <h3>Stakeholder Analysis:</h3>
                    <div class="data-source">
                        ${synthesisData.analysis?.stakeholder_analysis || 
                          synthesisData.analysis?.multi_perspective_analysis?.['Stakeholder Communications Expert']?.analysis?.analysis ||
                          synthesisData.analysis?.multi_perspective_analysis?.['Stakeholder Communications Expert']?.analysis_text ||
                          'No stakeholder analysis generated'}
                    </div>
                    
                    <h3>Key Insights:</h3>
                    ${(synthesisData.analysis?.key_insights || 
                       synthesisData.analysis?.multi_perspective_analysis?.['Executive Intelligence Synthesizer']?.analysis?.key_insights || 
                       []).map(insight => `<div class="data-source">‚Ä¢ ${insight}</div>`).join('') || 
                       '<div class="data-source">No insights generated</div>'}
                    
                    <h3>Recommendations:</h3>
                    ${(synthesisData.analysis?.recommendations || 
                       synthesisData.analysis?.multi_perspective_analysis?.['Executive Intelligence Synthesizer']?.analysis?.recommendations || 
                       []).map(rec => `<div class="data-source">‚Ä¢ ${rec}</div>`).join('') || 
                       '<div class="data-source">No recommendations generated</div>'}
                `;
                
                // Display raw data
                document.getElementById('raw').innerHTML = `
                    <h2>Complete Raw Data Package</h2>
                    <h3>Data sent to Claude:</h3>
                    <pre>${JSON.stringify(mcpData, null, 2)}</pre>
                    <h3>Claude Response:</h3>
                    <pre>${JSON.stringify(synthesisData, null, 2)}</pre>
                `;
                
                status.innerHTML = `
                    <div class="status success">
                        ‚úÖ Claude synthesis complete!<br>
                        Data sources used: Scraper ‚úì News (${intelligenceData.news?.articles?.length || 0} articles) ‚úì PR/Competitors ‚úì
                    </div>
                `;
                
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå Synthesis error: ${error.message}</div>`;
                console.error('Synthesis error:', error);
            }
        }
    </script>
</body>
</html>