{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{supabase}from'../config/supabase';import{Send,Bot,User,Loader,FileText,CheckCircle,AlertCircle,Edit3,Eye,Download}from'lucide-react';import'./NivRealtimeChat.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const NivRealtimeChat=()=>{// State management\nconst[message,setMessage]=useState('');const[messages,setMessages]=useState([]);const[artifacts,setArtifacts]=useState([]);const[isLoading,setIsLoading]=useState(false);const[sessionId]=useState(\"session-\".concat(Date.now()));const[selectedArtifact,setSelectedArtifact]=useState(null);const[connectionStatus,setConnectionStatus]=useState('connecting');// Refs\nconst messagesEndRef=useRef(null);const conversationChannel=useRef(null);const artifactChannel=useRef(null);// Initialize realtime subscriptions\nuseEffect(()=>{// Re-enabled database sync\nsetupRealtimeSubscriptions();loadSessionData();console.log('NivRealtimeChat initialized with database sync');return()=>{// Cleanup subscriptions\nif(conversationChannel.current){supabase.removeChannel(conversationChannel.current);}if(artifactChannel.current){supabase.removeChannel(artifactChannel.current);}};},[sessionId]);// Auto-scroll to bottom when messages update\nuseEffect(()=>{scrollToBottom();},[messages]);const scrollToBottom=()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});};const setupRealtimeSubscriptions=()=>{// Subscribe to conversations for this session\nconversationChannel.current=supabase.channel(\"conversations:\".concat(sessionId)).on('postgres_changes',{event:'INSERT',schema:'public',table:'niv_conversations',filter:\"session_id=eq.\".concat(sessionId)},payload=>{console.log('New message received:',payload);setMessages(prev=>[...prev,payload.new]);// Show notification for artifacts\nif(payload.new.artifact_id){showNotification('ðŸ“Ž New artifact created!','success');}}).on('presence',{event:'sync'},()=>{setConnectionStatus('connected');}).subscribe(status=>{console.log('Conversation subscription status:',status);if(status==='SUBSCRIBED'){setConnectionStatus('connected');}});// Subscribe to artifacts for this session\nartifactChannel.current=supabase.channel(\"artifacts:\".concat(sessionId)).on('postgres_changes',{event:'*',schema:'public',table:'niv_artifacts',filter:\"session_id=eq.\".concat(sessionId)},payload=>{console.log('Artifact event:',payload);if(payload.eventType==='INSERT'){setArtifacts(prev=>[...prev,payload.new]);showNotification(\"\\u2728 Created: \".concat(payload.new.title),'success');}else if(payload.eventType==='UPDATE'){setArtifacts(prev=>prev.map(a=>a.id===payload.new.id?payload.new:a));showNotification(\"\\uD83D\\uDCDD Updated: \".concat(payload.new.title),'info');}else if(payload.eventType==='DELETE'){setArtifacts(prev=>prev.filter(a=>a.id!==payload.old.id));}}).subscribe(status=>{console.log('Artifact subscription status:',status);});};const loadSessionData=async()=>{try{// Load existing conversations\nconst{data:convos,error:convoError}=await supabase.from('niv_conversations').select('*').eq('session_id',sessionId).order('created_at',{ascending:true});if(convoError){console.error('Error loading conversations:',convoError);}else if(convos){setMessages(convos);}// Load existing artifacts\nconst{data:arts,error:artError}=await supabase.from('niv_artifacts').select('*').eq('session_id',sessionId).order('created_at',{ascending:true});if(artError){console.error('Error loading artifacts:',artError);}else if(arts){setArtifacts(arts);}}catch(error){console.error('Error loading session data:',error);}};const sendMessage=async()=>{if(!message.trim()||isLoading)return;const userMessage=message.trim();setMessage('');setIsLoading(true);// Add user message to UI immediately\nconst userMsg={id:\"temp-\".concat(Date.now()),role:'user',content:userMessage,created_at:new Date().toISOString()};setMessages(prev=>[...prev,userMsg]);try{// Build conversation history\nconst conversationHistory=[...messages,userMsg].map(m=>({role:m.role,content:m.content}));// Call edge function using Supabase client\nconst{data,error:fnError}=await supabase.functions.invoke('niv-realtime',{body:{message:userMessage,sessionId,userId:'user-123',// In production, get from auth\nconversationHistory}});if(fnError){throw fnError;}if(!data){throw new Error('Failed to send message');}// Log response for debugging\nconsole.log('Edge function response:',data);// Add assistant response to UI\nif(data.response){const assistantMsg={id:\"temp-\".concat(Date.now(),\"-assistant\"),role:'assistant',content:data.response,artifact_id:data.artifactId,mcps_used:data.mcpsUsed||[],created_at:new Date().toISOString()};setMessages(prev=>[...prev,assistantMsg]);}// Add artifact to UI if created\nif(data.artifact){setArtifacts(prev=>[...prev,data.artifact]);showNotification(\"\\u2728 Created: \".concat(data.artifact.title),'success');}}catch(error){console.error('Error sending message:',error);showNotification('Failed to send message','error');// Add error message to chat\nsetMessages(prev=>[...prev,{role:'system',content:\"Error: \".concat(error.message),created_at:new Date().toISOString()}]);}finally{setIsLoading(false);}};const openInWorkspace=artifact=>{setSelectedArtifact(artifact);// In production, this could open a modal or navigate to workspace\nconsole.log('Opening artifact in workspace:',artifact);};const downloadArtifact=artifact=>{const content=JSON.stringify(artifact.content,null,2);const blob=new Blob([content],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=\"\".concat(artifact.title.replace(/\\s+/g,'-'),\".json\");a.click();URL.revokeObjectURL(url);};const showNotification=function(message){let type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'info';// Simple notification - in production use a proper toast library\nconst notification=document.createElement('div');notification.className=\"notification notification-\".concat(type);notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.classList.add('fade-out');setTimeout(()=>document.body.removeChild(notification),300);},3000);};const getConnectionIcon=()=>{switch(connectionStatus){case'connected':return/*#__PURE__*/_jsx(CheckCircle,{className:\"h-4 w-4 text-green-500\"});case'connecting':return/*#__PURE__*/_jsx(Loader,{className:\"h-4 w-4 text-yellow-500 animate-spin\"});default:return/*#__PURE__*/_jsx(AlertCircle,{className:\"h-4 w-4 text-red-500\"});}};return/*#__PURE__*/_jsxs(\"div\",{className:\"niv-realtime-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-header-left\",children:[/*#__PURE__*/_jsx(Bot,{className:\"h-8 w-8 text-blue-600\"}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h1\",{children:\"Niv - AI PR Strategist\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-500\",children:[\"Session: \",sessionId.slice(0,8),\"...\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-header-right\",children:[getConnectionIcon(),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm\",children:connectionStatus})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-main\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-chat\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-messages\",children:[messages.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"niv-welcome\",children:[/*#__PURE__*/_jsx(Bot,{className:\"h-16 w-16 text-gray-300 mb-4\"}),/*#__PURE__*/_jsx(\"h2\",{children:\"Welcome! I'm Niv, your AI PR Strategist.\"}),/*#__PURE__*/_jsx(\"p\",{children:\"How can I help you today?\"})]}):messages.map((msg,index)=>/*#__PURE__*/_jsxs(\"div\",{className:\"niv-message niv-message-\".concat(msg.role),children:[/*#__PURE__*/_jsx(\"div\",{className:\"niv-message-icon\",children:msg.role==='user'?/*#__PURE__*/_jsx(User,{className:\"h-5 w-5\"}):msg.role==='assistant'?/*#__PURE__*/_jsx(Bot,{className:\"h-5 w-5\"}):/*#__PURE__*/_jsx(AlertCircle,{className:\"h-5 w-5\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-message-content\",children:[/*#__PURE__*/_jsx(\"p\",{children:msg.content}),msg.artifact_id&&/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifact-badge\",children:[/*#__PURE__*/_jsx(FileText,{className:\"h-3 w-3\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Artifact created\"})]}),msg.mcps_used&&msg.mcps_used.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"niv-mcp-badges\",children:msg.mcps_used.map((mcp,i)=>/*#__PURE__*/_jsx(\"span\",{className:\"niv-mcp-badge\",children:mcp},i))})]})]},msg.id||index)),isLoading&&/*#__PURE__*/_jsxs(\"div\",{className:\"niv-message niv-message-assistant\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"niv-message-icon\",children:/*#__PURE__*/_jsx(Bot,{className:\"h-5 w-5 animate-pulse\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"niv-message-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"niv-typing\",children:[/*#__PURE__*/_jsx(\"span\",{}),/*#__PURE__*/_jsx(\"span\",{}),/*#__PURE__*/_jsx(\"span\",{})]})})]}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-input-area\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:message,onChange:e=>setMessage(e.target.value),onKeyPress:e=>e.key==='Enter'&&!e.shiftKey&&sendMessage(),placeholder:\"Ask Niv anything about PR strategy...\",disabled:isLoading,className:\"niv-input\"}),/*#__PURE__*/_jsx(\"button\",{onClick:sendMessage,disabled:isLoading||!message.trim(),className:\"niv-send-button\",children:isLoading?/*#__PURE__*/_jsx(Loader,{className:\"h-5 w-5 animate-spin\"}):/*#__PURE__*/_jsx(Send,{className:\"h-5 w-5\"})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifacts-panel\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"niv-artifacts-header\",children:/*#__PURE__*/_jsxs(\"h3\",{children:[\"Artifacts (\",artifacts.length,\")\"]})}),artifacts.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifacts-empty\",children:[/*#__PURE__*/_jsx(FileText,{className:\"h-12 w-12 text-gray-300 mb-2\"}),/*#__PURE__*/_jsx(\"p\",{children:\"No artifacts yet\"}),/*#__PURE__*/_jsx(\"small\",{children:\"Artifacts appear here after consultation\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"niv-artifacts-list\",children:artifacts.map(artifact=>/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifact-card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifact-header\",children:[/*#__PURE__*/_jsx(\"h4\",{children:artifact.title}),/*#__PURE__*/_jsx(\"span\",{className:\"niv-artifact-type\",children:artifact.type})]}),artifact.mcp_sources&&artifact.mcp_sources.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"niv-artifact-mcps\",children:artifact.mcp_sources.map((mcp,i)=>/*#__PURE__*/_jsx(\"span\",{className:\"niv-mcp-mini\",children:mcp},i))}),/*#__PURE__*/_jsx(\"div\",{className:\"niv-artifact-preview\",children:typeof artifact.content==='object'?/*#__PURE__*/_jsxs(\"pre\",{children:[JSON.stringify(artifact.content,null,2).slice(0,100),\"...\"]}):/*#__PURE__*/_jsxs(\"p\",{children:[artifact.content.slice(0,100),\"...\"]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"niv-artifact-actions\",children:[/*#__PURE__*/_jsxs(\"button\",{onClick:()=>openInWorkspace(artifact),className:\"niv-artifact-action\",children:[/*#__PURE__*/_jsx(Edit3,{className:\"h-4 w-4\"}),\"Edit\"]}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setSelectedArtifact(artifact),className:\"niv-artifact-action\",children:[/*#__PURE__*/_jsx(Eye,{className:\"h-4 w-4\"}),\"View\"]}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>downloadArtifact(artifact),className:\"niv-artifact-action\",children:[/*#__PURE__*/_jsx(Download,{className:\"h-4 w-4\"}),\"Export\"]})]})]},artifact.id))})]})]}),selectedArtifact&&/*#__PURE__*/_jsx(\"div\",{className:\"niv-workspace-modal\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"niv-workspace-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"niv-workspace-header\",children:[/*#__PURE__*/_jsx(\"h2\",{children:selectedArtifact.title}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setSelectedArtifact(null),children:\"\\u2715\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"niv-workspace-body\",children:/*#__PURE__*/_jsx(\"pre\",{children:JSON.stringify(selectedArtifact.content,null,2)})})]})})]});};export default NivRealtimeChat;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}