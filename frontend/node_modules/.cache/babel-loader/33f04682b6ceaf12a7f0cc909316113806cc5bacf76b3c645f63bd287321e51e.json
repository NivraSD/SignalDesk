{"ast":null,"code":"// Claude Intelligence Service V2\n// Enhanced with specialized personas, organizational context, and memory integration\n\nimport { getIndustryCompetitors, detectIndustryFromOrganization } from '../utils/industryCompetitors';\nimport aiIndustryExpansionService from './aiIndustryExpansionService';\nimport organizationProfileService from './organizationProfileService';\nimport tabIntelligenceService from './tabIntelligenceService';\nimport intelligentDiscoveryService from './intelligentDiscoveryService';\nclass ClaudeIntelligenceServiceV2 {\n  constructor() {\n    this.supabaseUrl = process.env.REACT_APP_SUPABASE_URL || 'https://zskaxjtyuaqazydouifp.supabase.co';\n    this.supabaseKey = process.env.REACT_APP_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';\n\n    // Track which personas are being used\n    this.activePersonas = {\n      competitive_strategist: false,\n      stakeholder_psychologist: false,\n      narrative_architect: false,\n      risk_prophet: false,\n      opportunity_hunter: false,\n      executive_synthesizer: false\n    };\n\n    // Cache for recent analyses to avoid redundant calls\n    this.analysisCache = new Map();\n    this.cacheTimeout = 2 * 60 * 1000; // 2 minutes - shorter cache for real-time experience\n    this.pendingRequests = new Map(); // Track pending requests to prevent duplicates\n  }\n\n  /**\n   * Helper function to extract stakeholders as an array from either array or object format\n   */\n  extractStakeholdersArray(stakeholders) {\n    if (!stakeholders) return [];\n\n    // If it's already an array, return it\n    if (Array.isArray(stakeholders)) {\n      return stakeholders;\n    }\n\n    // If it's an object with stakeholder groups, flatten all values\n    if (typeof stakeholders === 'object') {\n      const allStakeholders = [];\n      for (const [category, items] of Object.entries(stakeholders)) {\n        if (Array.isArray(items)) {\n          allStakeholders.push(...items);\n        } else if (typeof items === 'string') {\n          allStakeholders.push(items);\n        }\n      }\n      return allStakeholders;\n    }\n    return [];\n  }\n  async gatherAndAnalyze(config, timeframe = '24h', options = {}) {\n    var _config$organization, _config$organization2, _config$organization3, _config$intelligence, _config$intelligence2;\n    console.log('ðŸ” Starting intelligent analysis');\n\n    // Check if this is minimal onboarding (new approach)\n    const isMinimalOnboarding = localStorage.getItem('signaldesk_minimal') === 'true';\n\n    // Extract basic info\n    const orgName = ((_config$organization = config.organization) === null || _config$organization === void 0 ? void 0 : _config$organization.name) || config.organizationName || '';\n    const website = ((_config$organization2 = config.organization) === null || _config$organization2 === void 0 ? void 0 : _config$organization2.website) || config.website || '';\n    const description = ((_config$organization3 = config.organization) === null || _config$organization3 === void 0 ? void 0 : _config$organization3.description) || '';\n    const goals = config.goals || {};\n    console.log(`ðŸ¢ Analyzing ${orgName}`);\n    console.log('ðŸŽ¯ Goals:', Object.keys(goals).filter(k => goals[k]));\n\n    // Step 1: Intelligent Discovery (replaces broken onboarding)\n    let discoveredIntelligence;\n    if (isMinimalOnboarding || !((_config$intelligence = config.intelligence) !== null && _config$intelligence !== void 0 && _config$intelligence.stakeholders) || typeof ((_config$intelligence2 = config.intelligence) === null || _config$intelligence2 === void 0 ? void 0 : _config$intelligence2.stakeholders) === 'string') {\n      console.log('ðŸ¤– Using intelligent discovery to find real data...');\n      discoveredIntelligence = await intelligentDiscoveryService.discoverCompanyIntelligence(orgName, website, description);\n    } else {\n      var _config$organization4, _config$intelligence3, _config$intelligence4, _config$intelligence5;\n      // Fallback to old config if somehow it has real data\n      discoveredIntelligence = {\n        company: config.organization,\n        competitors: ((_config$organization4 = config.organization) === null || _config$organization4 === void 0 ? void 0 : _config$organization4.competitors) || [],\n        stakeholders: ((_config$intelligence3 = config.intelligence) === null || _config$intelligence3 === void 0 ? void 0 : _config$intelligence3.stakeholders) || {},\n        topics: ((_config$intelligence4 = config.intelligence) === null || _config$intelligence4 === void 0 ? void 0 : _config$intelligence4.topics) || [],\n        keywords: ((_config$intelligence5 = config.intelligence) === null || _config$intelligence5 === void 0 ? void 0 : _config$intelligence5.keywords) || []\n      };\n    }\n\n    // Build profile from discovered intelligence\n    const enhancedOrganization = {\n      ...discoveredIntelligence.company,\n      name: orgName,\n      competitors: discoveredIntelligence.competitors,\n      stakeholders: discoveredIntelligence.stakeholders,\n      topics: discoveredIntelligence.topics,\n      keywords: discoveredIntelligence.keywords\n    };\n    const profile = await organizationProfileService.getOrBuildProfile(enhancedOrganization);\n    console.log('ðŸ“‹ Organization Profile loaded:', profile.identity.name, `(${profile.confidence_level})`);\n\n    // Use profile to guide intelligence gathering\n    const intelligenceGuidance = organizationProfileService.getIntelligenceGuidance(profile);\n\n    // Use the discovered/enhanced organization as the full context\n    const fullOrganization = enhancedOrganization;\n    const industry = fullOrganization.industry || 'technology';\n    console.log('ðŸ­ Using industry:', industry);\n    console.log('ðŸ¢ Real Competitors:', fullOrganization.competitors);\n    console.log('ðŸ‘¥ Real Stakeholders:', fullOrganization.stakeholders);\n    console.log('ðŸ“ Real Topics:', fullOrganization.topics);\n    console.log('ðŸ”‘ Smart Keywords:', fullOrganization.keywords);\n    console.log('ðŸŽ¯ Full organization context:', fullOrganization);\n\n    // Check cache first with full context\n    const cacheKey = `${fullOrganization.name}_${industry}_${timeframe}_${JSON.stringify(goals)}`;\n    const cached = this.getCachedAnalysis(cacheKey);\n    if (cached && !options.forceRefresh) {\n      console.log('ðŸ“¦ Using cached analysis');\n      return cached;\n    }\n\n    // Check if request is already pending to prevent duplicates\n    if (this.pendingRequests.has(cacheKey)) {\n      console.log('â³ Request already pending, waiting for result...');\n      return await this.pendingRequests.get(cacheKey);\n    }\n\n    // Create a promise for this request to prevent duplicates\n    const analysisPromise = this.performAnalysis(fullOrganization, goals, timeframe, options, profile, intelligenceGuidance);\n    this.pendingRequests.set(cacheKey, analysisPromise);\n    try {\n      const result = await analysisPromise;\n      // Cache the result\n      this.cacheAnalysis(cacheKey, result);\n      return result;\n    } finally {\n      // Clean up pending request\n      this.pendingRequests.delete(cacheKey);\n    }\n  }\n  async performAnalysis(organization, goals, timeframe, options, profile, intelligenceGuidance) {\n    var _intelligenceGuidance;\n    console.log('ðŸŽ¯ Gathering intelligence with specialized personas');\n    console.log('ðŸ“Š Organization:', organization.name, '| Industry:', organization.industry);\n    console.log('ðŸŽ¯ Active goals:', Object.entries(goals).filter(([k, v]) => v).map(([k]) => k));\n    console.log('ðŸ“‹ Using profile guidance:', intelligenceGuidance === null || intelligenceGuidance === void 0 ? void 0 : (_intelligenceGuidance = intelligenceGuidance.search_priorities) === null || _intelligenceGuidance === void 0 ? void 0 : _intelligenceGuidance.slice(0, 3));\n\n    // Step 1: Enhance organization data with Claude before MCP calls\n    const enhancedOrganization = await this.enhanceOrganizationWithClaude(organization, goals);\n\n    // Step 2: Gather raw data from MCPs with ENHANCED context\n    const mcpData = await this.orchestrateMCPs(enhancedOrganization, timeframe);\n\n    // Step 3: Determine which analyses need second opinions\n    const criticalAnalyses = this.identifyCriticalAnalyses(mcpData, goals);\n\n    // Step 4: Send to Claude V2 for persona-based synthesis with profile context\n    const synthesizedIntelligence = await this.synthesizeWithClaudeV2(mcpData, enhancedOrganization, goals, timeframe, criticalAnalyses, profile, intelligenceGuidance);\n\n    // Step 5: Store key insights in memory\n    await this.storeKeyInsights(synthesizedIntelligence, enhancedOrganization);\n\n    // Generate tab-specific intelligence using profile\n    const tabIntelligence = await tabIntelligenceService.generateTabIntelligence(enhancedOrganization, synthesizedIntelligence, profile);\n\n    // Update profile with new intelligence\n    await organizationProfileService.updateProfile(enhancedOrganization, synthesizedIntelligence);\n\n    // Return enhanced intelligence with tab-specific content\n    return {\n      ...synthesizedIntelligence,\n      profile: {\n        confidence_level: profile.confidence_level,\n        last_updated: profile.last_updated,\n        established_facts: profile.established_facts\n      },\n      tabs: tabIntelligence,\n      guidance: intelligenceGuidance\n    };\n  }\n  async enhanceOrganizationWithClaude(organization, goals) {\n    console.log('ðŸ”® Enhancing organization data with AI Industry Expansion');\n    try {\n      // Use AI to EXPAND industry data, not necessarily to override the industry\n      const fullAnalysis = await aiIndustryExpansionService.analyzeAndExpandIndustry({\n        name: organization.name,\n        website: organization.website,\n        description: organization.description,\n        industry: organization.industry // Pass user's industry selection\n      });\n      console.log('ðŸŽ¯ AI analysis complete for industry:', organization.industry || fullAnalysis.primary_industry);\n\n      // Respect user's industry choice if provided\n      const finalIndustry = organization.industry || fullAnalysis.primary_industry;\n      return {\n        ...organization,\n        // Keep user's industry or use AI's if none provided\n        industry: finalIndustry,\n        subcategories: fullAnalysis.subcategories,\n        // Use AI-discovered competitors instead of generic tech defaults\n        competitors: [...new Set([...(organization.competitors || []), ...fullAnalysis.direct_competitors.slice(0, 8)])],\n        // Rich stakeholder data from AI\n        stakeholders: [...new Set([...this.extractStakeholdersArray(organization.stakeholders), ...fullAnalysis.stakeholder_groups.slice(0, 6)])],\n        // Industry-specific topics and keywords\n        topics: [...new Set([...(organization.topics || []), ...fullAnalysis.trending_topics.slice(0, 5)])],\n        keywords: [...new Set([...(organization.keywords || []), ...fullAnalysis.monitoring_keywords.slice(0, 10)])],\n        // Additional AI insights\n        industryInsights: {\n          media_outlets: fullAnalysis.media_outlets,\n          industry_events: fullAnalysis.industry_events,\n          regulatory_bodies: fullAnalysis.regulatory_bodies,\n          ecosystem_players: fullAnalysis.ecosystem_players\n        },\n        enhancedAt: new Date().toISOString(),\n        enhancementSource: 'ai_expansion'\n      };\n    } catch (error) {\n      console.error('Failed to enhance organization with AI:', error);\n      return await this.fallbackClaudeEnhancement(organization, goals);\n    }\n  }\n  async fallbackClaudeEnhancement(organization, goals) {\n    console.log('ðŸ”„ Using fallback Claude enhancement');\n    try {\n      const enhancementPrompt = `\n        Organization: ${organization.name}\n        Industry: ${organization.industry}\n        Website: ${organization.website || 'Not provided'}\n        \n        This is NOT a technology company. Analyze the actual business and industry.\n        Provide relevant competitors, stakeholders, and keywords specific to their industry.\n        \n        DO NOT default to tech companies like Google, Apple, Microsoft unless this is actually a tech company.\n      `;\n      const response = await fetch(`${this.supabaseUrl}/functions/v1/claude-intelligence-synthesizer-v2`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          intelligence_type: 'enhance_organization',\n          organization,\n          goals,\n          prompt: enhancementPrompt\n        })\n      });\n      if (response.ok) {\n        const enhanced = await response.json();\n        console.log('âœ¨ Organization enhanced with fallback Claude insights');\n        return {\n          ...organization,\n          competitors: [...new Set([...(organization.competitors || []), ...(enhanced.competitors || [])])],\n          stakeholders: [...new Set([...this.extractStakeholdersArray(organization.stakeholders), ...this.extractStakeholdersArray(enhanced.stakeholders)])],\n          topics: [...new Set([...(organization.topics || []), ...(enhanced.topics || [])])],\n          keywords: [...new Set([...(organization.keywords || []), ...(enhanced.keywords || [])])],\n          industryInsights: enhanced.industryInsights || {},\n          enhancedAt: new Date().toISOString(),\n          enhancementSource: 'claude_fallback'\n        };\n      }\n    } catch (error) {\n      console.error('Fallback enhancement also failed:', error);\n    }\n\n    // Return original if both enhancements fail\n    return organization;\n  }\n  identifyCriticalAnalyses(mcpData, goals) {\n    var _mcpData$monitoring, _mcpData$monitoring$a;\n    const critical = [];\n\n    // Competitor movements are always critical\n    if (mcpData.competitive && Object.keys(mcpData.competitive).length > 0) {\n      critical.push('competitor');\n    }\n\n    // Risk assessments need second opinions\n    if ((_mcpData$monitoring = mcpData.monitoring) !== null && _mcpData$monitoring !== void 0 && (_mcpData$monitoring$a = _mcpData$monitoring.alerts) !== null && _mcpData$monitoring$a !== void 0 && _mcpData$monitoring$a.some(a => a.severity === 'critical')) {\n      critical.push('predictive');\n    }\n\n    // Executive summaries for important goals\n    if (goals.investor_relations || goals.crisis_preparedness) {\n      critical.push('executive_summary');\n    }\n    return critical;\n  }\n  async orchestrateMCPs(organization, timeframe) {\n    console.log('ðŸ“Š Orchestrating MCPs for', organization.name);\n\n    // Parallel MCP calls with enhanced parameters\n    const mcpCalls = [this.callMCP('pr', 'gather', {\n      organization,\n      timeframe,\n      focus: 'competitive_intelligence'\n    }), this.callMCP('news', 'gather', {\n      organization,\n      timeframe,\n      focus: 'market_trends'\n    }), this.callMCP('media', 'discover', {\n      organization,\n      timeframe,\n      focus: 'media_coverage'\n    }), this.callMCP('opportunities', 'discover', {\n      organization,\n      timeframe,\n      focus: 'strategic_opportunities'\n    }), this.callMCP('analytics', 'analyze', {\n      organization,\n      timeframe,\n      metrics: ['sentiment', 'reach', 'engagement']\n    }), this.callMCP('relationships', 'assess', {\n      organization,\n      timeframe,\n      stakeholders: 'all'\n    }), this.callMCP('monitor', 'check', {\n      organization,\n      timeframe,\n      alert_level: 'all'\n    })];\n    const results = await Promise.allSettled(mcpCalls);\n\n    // Organize results by type with enhanced error handling\n    const mcpData = {\n      competitive: results[0].status === 'fulfilled' ? results[0].value : null,\n      news: results[1].status === 'fulfilled' ? results[1].value : null,\n      media: results[2].status === 'fulfilled' ? results[2].value : null,\n      opportunities: results[3].status === 'fulfilled' ? results[3].value : null,\n      analytics: results[4].status === 'fulfilled' ? results[4].value : null,\n      stakeholder: results[5].status === 'fulfilled' ? results[5].value : null,\n      monitoring: results[6].status === 'fulfilled' ? results[6].value : null\n    };\n\n    // Log successful data gathering\n    const successfulMCPs = Object.keys(mcpData).filter(k => mcpData[k]);\n    console.log('âœ… MCP data gathered from:', successfulMCPs.join(', '));\n\n    // Warn about failed MCPs\n    const failedMCPs = Object.keys(mcpData).filter(k => !mcpData[k]);\n    if (failedMCPs.length > 0) {\n      console.warn('âš ï¸ Failed to gather from:', failedMCPs.join(', '));\n    }\n    return mcpData;\n  }\n  async callMCP(server, method, params) {\n    try {\n      const response = await fetch(`${this.supabaseUrl}/functions/v1/${server}-intelligence`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          method,\n          params\n        })\n      });\n      if (response.ok) {\n        const data = await response.json();\n        if (data.success && data.data) {\n          return data.data;\n        }\n      }\n      return null;\n    } catch (error) {\n      console.log(`MCP ${server}.${method} failed:`, error.message);\n      return null;\n    }\n  }\n  async synthesizeWithClaudeV2(mcpData, organization, goals, timeframe, criticalAnalyses, profile, intelligenceGuidance) {\n    var _profile$identity;\n    console.log('ðŸ§  Synthesizing with Claude V2 specialized personas');\n    console.log('ðŸ“‹ Profile context:', profile === null || profile === void 0 ? void 0 : (_profile$identity = profile.identity) === null || _profile$identity === void 0 ? void 0 : _profile$identity.name, profile === null || profile === void 0 ? void 0 : profile.confidence_level);\n    try {\n      // Call different synthesis types in parallel with V2 endpoint, including profile context\n      const synthesisPromises = [this.callClaudeV2Synthesizer('competitor', mcpData.competitive, organization, goals, timeframe, criticalAnalyses.includes('competitor'), profile, intelligenceGuidance), this.callClaudeV2Synthesizer('stakeholder', {\n        relationships: mcpData.stakeholder,\n        media: mcpData.media\n      }, organization, goals, timeframe, criticalAnalyses.includes('stakeholder'), profile, intelligenceGuidance), this.callClaudeV2Synthesizer('narrative', {\n        news: mcpData.news,\n        media: mcpData.media,\n        analytics: mcpData.analytics\n      }, organization, goals, timeframe, criticalAnalyses.includes('narrative'), profile, intelligenceGuidance), this.callClaudeV2Synthesizer('predictive', mcpData, organization, goals, timeframe, criticalAnalyses.includes('predictive'), profile, intelligenceGuidance)];\n      const results = await Promise.allSettled(synthesisPromises);\n\n      // Get executive summary based on all analyses\n      const allAnalyses = {\n        competitor: results[0].status === 'fulfilled' ? results[0].value : null,\n        stakeholder: results[1].status === 'fulfilled' ? results[1].value : null,\n        narrative: results[2].status === 'fulfilled' ? results[2].value : null,\n        predictive: results[3].status === 'fulfilled' ? results[3].value : null\n      };\n\n      // Executive summary with second opinion and profile context\n      const executiveSummary = await this.callClaudeV2Synthesizer('executive_summary', allAnalyses, organization, goals, timeframe, criticalAnalyses.includes('executive_summary'), profile, intelligenceGuidance);\n\n      // Track which personas were activated\n      this.updateActivePersonas(allAnalyses);\n      return {\n        ...allAnalyses,\n        executive_summary: executiveSummary,\n        raw_mcp_data: mcpData,\n        analysis_metadata: {\n          timestamp: new Date().toISOString(),\n          timeframe,\n          personas_used: this.getActivePersonas(),\n          critical_analyses: criticalAnalyses,\n          confidence_scores: this.extractConfidenceScores(allAnalyses)\n        }\n      };\n    } catch (error) {\n      console.error('Claude V2 synthesis failed:', error);\n\n      // Fallback to structured MCP data if Claude fails\n      return this.getFallbackAnalysis(mcpData);\n    }\n  }\n  async callClaudeV2Synthesizer(intelligenceType, mcpData, organization, goals, timeframe, requiresSecondOpinion = false, profile = null, intelligenceGuidance = null) {\n    // Log what we're sending to Claude\n    console.log(`ðŸš€ Sending to Claude ${intelligenceType}:`, {\n      hasOrganization: !!organization,\n      orgName: organization === null || organization === void 0 ? void 0 : organization.name,\n      industry: organization === null || organization === void 0 ? void 0 : organization.industry,\n      competitors: organization === null || organization === void 0 ? void 0 : organization.competitors,\n      stakeholders: organization === null || organization === void 0 ? void 0 : organization.stakeholders,\n      topics: organization === null || organization === void 0 ? void 0 : organization.topics,\n      goalsCount: Object.keys(goals || {}).filter(k => goals[k]).length,\n      hasMcpData: !!mcpData,\n      hasProfile: !!profile,\n      profileConfidence: profile === null || profile === void 0 ? void 0 : profile.confidence_level\n    });\n    try {\n      const response = await fetch(`${this.supabaseUrl}/functions/v1/claude-intelligence-synthesizer-v2`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          intelligence_type: intelligenceType,\n          mcp_data: mcpData,\n          organization,\n          goals,\n          timeframe,\n          requires_second_opinion: requiresSecondOpinion,\n          profile: profile ? {\n            established_facts: profile.established_facts,\n            monitoring_targets: profile.monitoring_targets,\n            objectives: profile.objectives,\n            context_flags: profile.context\n          } : null,\n          guidance: intelligenceGuidance\n        })\n      });\n      if (response.ok) {\n        const data = await response.json();\n        if (data.success && data.analysis) {\n          // Log persona usage\n          if (data.personas_used) {\n            console.log(`ðŸ“ ${intelligenceType} analyzed by:`, data.personas_used.join(', '));\n          }\n          return data.analysis;\n        } else {\n          console.log(`âš ï¸ Claude V2 returned success=false for ${intelligenceType}:`, data.error);\n        }\n      } else {\n        const errorText = await response.text();\n        console.error(`âŒ Claude V2 HTTP error for ${intelligenceType} (${response.status}):`, errorText);\n      }\n      return null;\n    } catch (error) {\n      console.error(`Claude V2 synthesis for ${intelligenceType} failed:`, error);\n      return null;\n    }\n  }\n  async storeKeyInsights(intelligence, organization) {\n    var _intelligence$executi, _intelligence$competi, _intelligence$predict, _intelligence$predict2, _organization$name;\n    // Store critical insights in memory for future reference\n    const keyInsights = [];\n    if ((_intelligence$executi = intelligence.executive_summary) !== null && _intelligence$executi !== void 0 && _intelligence$executi.key_insight) {\n      var _intelligence$analysi, _intelligence$analysi2;\n      keyInsights.push({\n        type: 'executive_insight',\n        content: intelligence.executive_summary.key_insight,\n        confidence: ((_intelligence$analysi = intelligence.analysis_metadata) === null || _intelligence$analysi === void 0 ? void 0 : (_intelligence$analysi2 = _intelligence$analysi.confidence_scores) === null || _intelligence$analysi2 === void 0 ? void 0 : _intelligence$analysi2.executive) || 0\n      });\n    }\n    if ((_intelligence$competi = intelligence.competitor) !== null && _intelligence$competi !== void 0 && _intelligence$competi.priority_focus) {\n      var _intelligence$analysi3, _intelligence$analysi4;\n      keyInsights.push({\n        type: 'competitive_priority',\n        content: intelligence.competitor.priority_focus,\n        confidence: ((_intelligence$analysi3 = intelligence.analysis_metadata) === null || _intelligence$analysi3 === void 0 ? void 0 : (_intelligence$analysi4 = _intelligence$analysi3.confidence_scores) === null || _intelligence$analysi4 === void 0 ? void 0 : _intelligence$analysi4.competitor) || 0\n      });\n    }\n    if (((_intelligence$predict = intelligence.predictive) === null || _intelligence$predict === void 0 ? void 0 : (_intelligence$predict2 = _intelligence$predict.cascade_risks) === null || _intelligence$predict2 === void 0 ? void 0 : _intelligence$predict2.length) > 0) {\n      var _intelligence$analysi5, _intelligence$analysi6;\n      keyInsights.push({\n        type: 'risk_alert',\n        content: intelligence.predictive.cascade_risks[0],\n        confidence: ((_intelligence$analysi5 = intelligence.analysis_metadata) === null || _intelligence$analysi5 === void 0 ? void 0 : (_intelligence$analysi6 = _intelligence$analysi5.confidence_scores) === null || _intelligence$analysi6 === void 0 ? void 0 : _intelligence$analysi6.predictive) || 0\n      });\n    }\n\n    // Store in localStorage for now (would be database in production)\n    // Use organization name as fallback if no ID exists\n    const memoryId = organization.id || ((_organization$name = organization.name) === null || _organization$name === void 0 ? void 0 : _organization$name.toLowerCase().replace(/\\s+/g, '_'));\n    const memoryKey = `signaldesk_memory_${memoryId}`;\n    const existingMemory = JSON.parse(localStorage.getItem(memoryKey) || '[]');\n    keyInsights.forEach(insight => {\n      existingMemory.push({\n        ...insight,\n        timestamp: new Date().toISOString(),\n        organization_id: organization.id\n      });\n    });\n\n    // Keep only last 100 insights\n    const trimmedMemory = existingMemory.slice(-100);\n    localStorage.setItem(memoryKey, JSON.stringify(trimmedMemory));\n    console.log('ðŸ’¾ Stored', keyInsights.length, 'key insights in memory');\n  }\n  updateActivePersonas(analyses) {\n    // Track which personas provided valuable input\n    this.activePersonas = {\n      competitive_strategist: !!analyses.competitor,\n      stakeholder_psychologist: !!analyses.stakeholder,\n      narrative_architect: !!analyses.narrative,\n      risk_prophet: !!analyses.predictive,\n      opportunity_hunter: !!analyses.predictive,\n      executive_synthesizer: !!analyses.executive_summary\n    };\n  }\n  getActivePersonas() {\n    return Object.entries(this.activePersonas).filter(([_, active]) => active).map(([persona]) => persona);\n  }\n  extractConfidenceScores(analyses) {\n    const scores = {};\n\n    // Extract confidence from second opinions if available\n    Object.entries(analyses).forEach(([key, value]) => {\n      if (value !== null && value !== void 0 && value.consensus_level) {\n        scores[key] = value.consensus_level;\n      } else if (value !== null && value !== void 0 && value.overall_confidence) {\n        scores[key] = value.overall_confidence;\n      } else {\n        scores[key] = 70; // Default confidence\n      }\n    });\n    return scores;\n  }\n  getCachedAnalysis(key) {\n    const cached = this.analysisCache.get(key);\n    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {\n      return cached.data;\n    }\n    this.analysisCache.delete(key);\n    return null;\n  }\n  cacheAnalysis(key, data) {\n    this.analysisCache.set(key, {\n      data,\n      timestamp: Date.now()\n    });\n\n    // Clean old cache entries\n    if (this.analysisCache.size > 10) {\n      const oldestKey = this.analysisCache.keys().next().value;\n      this.analysisCache.delete(oldestKey);\n    }\n  }\n  getFallbackAnalysis(mcpData) {\n    // Structured fallback when Claude is unavailable\n    return {\n      competitor: {\n        key_movements: [],\n        strategic_patterns: [\"Analysis temporarily unavailable\"],\n        recommended_actions: [\"Continue monitoring\"],\n        competitive_advantage: \"Under analysis\",\n        priority_focus: \"Maintain current strategy\"\n      },\n      stakeholder: {\n        stakeholder_map: [],\n        coalition_opportunities: [],\n        risk_stakeholders: [],\n        engagement_strategies: [],\n        immediate_actions: [\"Review stakeholder positions\"]\n      },\n      narrative: {\n        goal_narrative_alignment: {},\n        whitespace_opportunities: [],\n        messaging_recommendations: [],\n        emerging_narratives: [],\n        narrative_strategy: \"Maintain consistent messaging\"\n      },\n      predictive: {\n        goal_impact_forecast: {},\n        predicted_competitor_moves: [],\n        cascade_risks: [],\n        goal_vulnerabilities: [],\n        proactive_recommendations: [\"Continue monitoring\"]\n      },\n      executive_summary: {\n        key_insight: \"Intelligence system processing\",\n        immediate_priorities: [\"Gather more data\", \"Monitor developments\"],\n        biggest_opportunity: \"Under analysis\",\n        biggest_risk: \"Limited visibility\",\n        resource_allocation: {},\n        thirty_day_strategy: \"Maintain current operations while gathering intelligence\"\n      },\n      raw_mcp_data: mcpData,\n      analysis_metadata: {\n        timestamp: new Date().toISOString(),\n        fallback_mode: true,\n        personas_used: [],\n        confidence_scores: {}\n      }\n    };\n  }\n}\nexport default new ClaudeIntelligenceServiceV2();","map":{"version":3,"names":["getIndustryCompetitors","detectIndustryFromOrganization","aiIndustryExpansionService","organizationProfileService","tabIntelligenceService","intelligentDiscoveryService","ClaudeIntelligenceServiceV2","constructor","supabaseUrl","process","env","REACT_APP_SUPABASE_URL","supabaseKey","REACT_APP_SUPABASE_ANON_KEY","activePersonas","competitive_strategist","stakeholder_psychologist","narrative_architect","risk_prophet","opportunity_hunter","executive_synthesizer","analysisCache","Map","cacheTimeout","pendingRequests","extractStakeholdersArray","stakeholders","Array","isArray","allStakeholders","category","items","Object","entries","push","gatherAndAnalyze","config","timeframe","options","_config$organization","_config$organization2","_config$organization3","_config$intelligence","_config$intelligence2","console","log","isMinimalOnboarding","localStorage","getItem","orgName","organization","name","organizationName","website","description","goals","keys","filter","k","discoveredIntelligence","intelligence","discoverCompanyIntelligence","_config$organization4","_config$intelligence3","_config$intelligence4","_config$intelligence5","company","competitors","topics","keywords","enhancedOrganization","profile","getOrBuildProfile","identity","confidence_level","intelligenceGuidance","getIntelligenceGuidance","fullOrganization","industry","cacheKey","JSON","stringify","cached","getCachedAnalysis","forceRefresh","has","get","analysisPromise","performAnalysis","set","result","cacheAnalysis","delete","_intelligenceGuidance","v","map","search_priorities","slice","enhanceOrganizationWithClaude","mcpData","orchestrateMCPs","criticalAnalyses","identifyCriticalAnalyses","synthesizedIntelligence","synthesizeWithClaudeV2","storeKeyInsights","tabIntelligence","generateTabIntelligence","updateProfile","last_updated","established_facts","tabs","guidance","fullAnalysis","analyzeAndExpandIndustry","primary_industry","finalIndustry","subcategories","Set","direct_competitors","stakeholder_groups","trending_topics","monitoring_keywords","industryInsights","media_outlets","industry_events","regulatory_bodies","ecosystem_players","enhancedAt","Date","toISOString","enhancementSource","error","fallbackClaudeEnhancement","enhancementPrompt","response","fetch","method","headers","body","intelligence_type","prompt","ok","enhanced","json","_mcpData$monitoring","_mcpData$monitoring$a","critical","competitive","length","monitoring","alerts","some","a","severity","investor_relations","crisis_preparedness","mcpCalls","callMCP","focus","metrics","alert_level","results","Promise","allSettled","status","value","news","media","opportunities","analytics","stakeholder","successfulMCPs","join","failedMCPs","warn","server","params","data","success","message","_profile$identity","synthesisPromises","callClaudeV2Synthesizer","includes","relationships","allAnalyses","competitor","narrative","predictive","executiveSummary","updateActivePersonas","executive_summary","raw_mcp_data","analysis_metadata","timestamp","personas_used","getActivePersonas","critical_analyses","confidence_scores","extractConfidenceScores","getFallbackAnalysis","intelligenceType","requiresSecondOpinion","hasOrganization","goalsCount","hasMcpData","hasProfile","profileConfidence","mcp_data","requires_second_opinion","monitoring_targets","objectives","context_flags","context","analysis","errorText","text","_intelligence$executi","_intelligence$competi","_intelligence$predict","_intelligence$predict2","_organization$name","keyInsights","key_insight","_intelligence$analysi","_intelligence$analysi2","type","content","confidence","executive","priority_focus","_intelligence$analysi3","_intelligence$analysi4","cascade_risks","_intelligence$analysi5","_intelligence$analysi6","memoryId","id","toLowerCase","replace","memoryKey","existingMemory","parse","forEach","insight","organization_id","trimmedMemory","setItem","analyses","_","active","persona","scores","key","consensus_level","overall_confidence","now","size","oldestKey","next","key_movements","strategic_patterns","recommended_actions","competitive_advantage","stakeholder_map","coalition_opportunities","risk_stakeholders","engagement_strategies","immediate_actions","goal_narrative_alignment","whitespace_opportunities","messaging_recommendations","emerging_narratives","narrative_strategy","goal_impact_forecast","predicted_competitor_moves","goal_vulnerabilities","proactive_recommendations","immediate_priorities","biggest_opportunity","biggest_risk","resource_allocation","thirty_day_strategy","fallback_mode"],"sources":["/Users/jonathanliebowitz/Desktop/SignalDesk/frontend/src/services/claudeIntelligenceServiceV2.js"],"sourcesContent":["// Claude Intelligence Service V2\n// Enhanced with specialized personas, organizational context, and memory integration\n\nimport { getIndustryCompetitors, detectIndustryFromOrganization } from '../utils/industryCompetitors';\nimport aiIndustryExpansionService from './aiIndustryExpansionService';\nimport organizationProfileService from './organizationProfileService';\nimport tabIntelligenceService from './tabIntelligenceService';\nimport intelligentDiscoveryService from './intelligentDiscoveryService';\n\nclass ClaudeIntelligenceServiceV2 {\n  constructor() {\n    this.supabaseUrl = process.env.REACT_APP_SUPABASE_URL || 'https://zskaxjtyuaqazydouifp.supabase.co';\n    this.supabaseKey = process.env.REACT_APP_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';\n    \n    // Track which personas are being used\n    this.activePersonas = {\n      competitive_strategist: false,\n      stakeholder_psychologist: false,\n      narrative_architect: false,\n      risk_prophet: false,\n      opportunity_hunter: false,\n      executive_synthesizer: false\n    };\n    \n    // Cache for recent analyses to avoid redundant calls\n    this.analysisCache = new Map();\n    this.cacheTimeout = 2 * 60 * 1000; // 2 minutes - shorter cache for real-time experience\n    this.pendingRequests = new Map(); // Track pending requests to prevent duplicates\n  }\n\n  /**\n   * Helper function to extract stakeholders as an array from either array or object format\n   */\n  extractStakeholdersArray(stakeholders) {\n    if (!stakeholders) return [];\n    \n    // If it's already an array, return it\n    if (Array.isArray(stakeholders)) {\n      return stakeholders;\n    }\n    \n    // If it's an object with stakeholder groups, flatten all values\n    if (typeof stakeholders === 'object') {\n      const allStakeholders = [];\n      for (const [category, items] of Object.entries(stakeholders)) {\n        if (Array.isArray(items)) {\n          allStakeholders.push(...items);\n        } else if (typeof items === 'string') {\n          allStakeholders.push(items);\n        }\n      }\n      return allStakeholders;\n    }\n    \n    return [];\n  }\n\n  async gatherAndAnalyze(config, timeframe = '24h', options = {}) {\n    console.log('ðŸ” Starting intelligent analysis');\n    \n    // Check if this is minimal onboarding (new approach)\n    const isMinimalOnboarding = localStorage.getItem('signaldesk_minimal') === 'true';\n    \n    // Extract basic info\n    const orgName = config.organization?.name || config.organizationName || '';\n    const website = config.organization?.website || config.website || '';\n    const description = config.organization?.description || '';\n    const goals = config.goals || {};\n    \n    console.log(`ðŸ¢ Analyzing ${orgName}`);\n    console.log('ðŸŽ¯ Goals:', Object.keys(goals).filter(k => goals[k]));\n    \n    // Step 1: Intelligent Discovery (replaces broken onboarding)\n    let discoveredIntelligence;\n    if (isMinimalOnboarding || !config.intelligence?.stakeholders || \n        typeof config.intelligence?.stakeholders === 'string') {\n      console.log('ðŸ¤– Using intelligent discovery to find real data...');\n      discoveredIntelligence = await intelligentDiscoveryService.discoverCompanyIntelligence(\n        orgName, website, description\n      );\n    } else {\n      // Fallback to old config if somehow it has real data\n      discoveredIntelligence = {\n        company: config.organization,\n        competitors: config.organization?.competitors || [],\n        stakeholders: config.intelligence?.stakeholders || {},\n        topics: config.intelligence?.topics || [],\n        keywords: config.intelligence?.keywords || []\n      };\n    }\n    \n    // Build profile from discovered intelligence\n    const enhancedOrganization = {\n      ...discoveredIntelligence.company,\n      name: orgName,\n      competitors: discoveredIntelligence.competitors,\n      stakeholders: discoveredIntelligence.stakeholders,\n      topics: discoveredIntelligence.topics,\n      keywords: discoveredIntelligence.keywords\n    };\n    \n    const profile = await organizationProfileService.getOrBuildProfile(enhancedOrganization);\n    console.log('ðŸ“‹ Organization Profile loaded:', profile.identity.name, \n                `(${profile.confidence_level})`);\n    \n    // Use profile to guide intelligence gathering\n    const intelligenceGuidance = organizationProfileService.getIntelligenceGuidance(profile);\n    \n    // Use the discovered/enhanced organization as the full context\n    const fullOrganization = enhancedOrganization;\n    const industry = fullOrganization.industry || 'technology';\n    \n    console.log('ðŸ­ Using industry:', industry);\n    console.log('ðŸ¢ Real Competitors:', fullOrganization.competitors);\n    console.log('ðŸ‘¥ Real Stakeholders:', fullOrganization.stakeholders);\n    console.log('ðŸ“ Real Topics:', fullOrganization.topics);\n    console.log('ðŸ”‘ Smart Keywords:', fullOrganization.keywords);\n    console.log('ðŸŽ¯ Full organization context:', fullOrganization);\n    \n    // Check cache first with full context\n    const cacheKey = `${fullOrganization.name}_${industry}_${timeframe}_${JSON.stringify(goals)}`;\n    const cached = this.getCachedAnalysis(cacheKey);\n    if (cached && !options.forceRefresh) {\n      console.log('ðŸ“¦ Using cached analysis');\n      return cached;\n    }\n\n    // Check if request is already pending to prevent duplicates\n    if (this.pendingRequests.has(cacheKey)) {\n      console.log('â³ Request already pending, waiting for result...');\n      return await this.pendingRequests.get(cacheKey);\n    }\n    \n    // Create a promise for this request to prevent duplicates\n    const analysisPromise = this.performAnalysis(fullOrganization, goals, timeframe, options, profile, intelligenceGuidance);\n    this.pendingRequests.set(cacheKey, analysisPromise);\n    \n    try {\n      const result = await analysisPromise;\n      // Cache the result\n      this.cacheAnalysis(cacheKey, result);\n      return result;\n    } finally {\n      // Clean up pending request\n      this.pendingRequests.delete(cacheKey);\n    }\n  }\n\n  async performAnalysis(organization, goals, timeframe, options, profile, intelligenceGuidance) {\n    console.log('ðŸŽ¯ Gathering intelligence with specialized personas');\n    console.log('ðŸ“Š Organization:', organization.name, '| Industry:', organization.industry);\n    console.log('ðŸŽ¯ Active goals:', Object.entries(goals).filter(([k,v]) => v).map(([k]) => k));\n    console.log('ðŸ“‹ Using profile guidance:', intelligenceGuidance?.search_priorities?.slice(0, 3));\n    \n    // Step 1: Enhance organization data with Claude before MCP calls\n    const enhancedOrganization = await this.enhanceOrganizationWithClaude(organization, goals);\n    \n    // Step 2: Gather raw data from MCPs with ENHANCED context\n    const mcpData = await this.orchestrateMCPs(enhancedOrganization, timeframe);\n    \n    // Step 3: Determine which analyses need second opinions\n    const criticalAnalyses = this.identifyCriticalAnalyses(mcpData, goals);\n    \n    // Step 4: Send to Claude V2 for persona-based synthesis with profile context\n    const synthesizedIntelligence = await this.synthesizeWithClaudeV2(\n      mcpData, \n      enhancedOrganization, \n      goals, \n      timeframe,\n      criticalAnalyses,\n      profile,\n      intelligenceGuidance\n    );\n    \n    // Step 5: Store key insights in memory\n    await this.storeKeyInsights(synthesizedIntelligence, enhancedOrganization);\n    \n    // Generate tab-specific intelligence using profile\n    const tabIntelligence = await tabIntelligenceService.generateTabIntelligence(\n      enhancedOrganization,\n      synthesizedIntelligence,\n      profile\n    );\n    \n    // Update profile with new intelligence\n    await organizationProfileService.updateProfile(enhancedOrganization, synthesizedIntelligence);\n    \n    // Return enhanced intelligence with tab-specific content\n    return {\n      ...synthesizedIntelligence,\n      profile: {\n        confidence_level: profile.confidence_level,\n        last_updated: profile.last_updated,\n        established_facts: profile.established_facts\n      },\n      tabs: tabIntelligence,\n      guidance: intelligenceGuidance\n    };\n  }\n\n  async enhanceOrganizationWithClaude(organization, goals) {\n    console.log('ðŸ”® Enhancing organization data with AI Industry Expansion');\n    \n    try {\n      // Use AI to EXPAND industry data, not necessarily to override the industry\n      const fullAnalysis = await aiIndustryExpansionService.analyzeAndExpandIndustry({\n        name: organization.name,\n        website: organization.website,\n        description: organization.description,\n        industry: organization.industry // Pass user's industry selection\n      });\n      \n      console.log('ðŸŽ¯ AI analysis complete for industry:', organization.industry || fullAnalysis.primary_industry);\n      \n      // Respect user's industry choice if provided\n      const finalIndustry = organization.industry || fullAnalysis.primary_industry;\n      \n      return {\n        ...organization,\n        // Keep user's industry or use AI's if none provided\n        industry: finalIndustry,\n        subcategories: fullAnalysis.subcategories,\n        \n        // Use AI-discovered competitors instead of generic tech defaults\n        competitors: [...new Set([\n          ...(organization.competitors || []), \n          ...fullAnalysis.direct_competitors.slice(0, 8)\n        ])],\n        \n        // Rich stakeholder data from AI\n        stakeholders: [...new Set([\n          ...this.extractStakeholdersArray(organization.stakeholders), \n          ...fullAnalysis.stakeholder_groups.slice(0, 6)\n        ])],\n        \n        // Industry-specific topics and keywords\n        topics: [...new Set([\n          ...(organization.topics || []), \n          ...fullAnalysis.trending_topics.slice(0, 5)\n        ])],\n        keywords: [...new Set([\n          ...(organization.keywords || []), \n          ...fullAnalysis.monitoring_keywords.slice(0, 10)\n        ])],\n        \n        // Additional AI insights\n        industryInsights: {\n          media_outlets: fullAnalysis.media_outlets,\n          industry_events: fullAnalysis.industry_events,\n          regulatory_bodies: fullAnalysis.regulatory_bodies,\n          ecosystem_players: fullAnalysis.ecosystem_players\n        },\n        \n        enhancedAt: new Date().toISOString(),\n        enhancementSource: 'ai_expansion'\n      };\n      \n    } catch (error) {\n      console.error('Failed to enhance organization with AI:', error);\n      return await this.fallbackClaudeEnhancement(organization, goals);\n    }\n  }\n\n  async fallbackClaudeEnhancement(organization, goals) {\n    console.log('ðŸ”„ Using fallback Claude enhancement');\n    \n    try {\n      const enhancementPrompt = `\n        Organization: ${organization.name}\n        Industry: ${organization.industry}\n        Website: ${organization.website || 'Not provided'}\n        \n        This is NOT a technology company. Analyze the actual business and industry.\n        Provide relevant competitors, stakeholders, and keywords specific to their industry.\n        \n        DO NOT default to tech companies like Google, Apple, Microsoft unless this is actually a tech company.\n      `;\n      \n      const response = await fetch(`${this.supabaseUrl}/functions/v1/claude-intelligence-synthesizer-v2`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          intelligence_type: 'enhance_organization',\n          organization,\n          goals,\n          prompt: enhancementPrompt\n        })\n      });\n      \n      if (response.ok) {\n        const enhanced = await response.json();\n        console.log('âœ¨ Organization enhanced with fallback Claude insights');\n        \n        return {\n          ...organization,\n          competitors: [...new Set([...(organization.competitors || []), ...(enhanced.competitors || [])])],\n          stakeholders: [...new Set([...this.extractStakeholdersArray(organization.stakeholders), ...this.extractStakeholdersArray(enhanced.stakeholders)])],\n          topics: [...new Set([...(organization.topics || []), ...(enhanced.topics || [])])],\n          keywords: [...new Set([...(organization.keywords || []), ...(enhanced.keywords || [])])],\n          industryInsights: enhanced.industryInsights || {},\n          enhancedAt: new Date().toISOString(),\n          enhancementSource: 'claude_fallback'\n        };\n      }\n    } catch (error) {\n      console.error('Fallback enhancement also failed:', error);\n    }\n    \n    // Return original if both enhancements fail\n    return organization;\n  }\n\n  identifyCriticalAnalyses(mcpData, goals) {\n    const critical = [];\n    \n    // Competitor movements are always critical\n    if (mcpData.competitive && Object.keys(mcpData.competitive).length > 0) {\n      critical.push('competitor');\n    }\n    \n    // Risk assessments need second opinions\n    if (mcpData.monitoring?.alerts?.some(a => a.severity === 'critical')) {\n      critical.push('predictive');\n    }\n    \n    // Executive summaries for important goals\n    if (goals.investor_relations || goals.crisis_preparedness) {\n      critical.push('executive_summary');\n    }\n    \n    return critical;\n  }\n\n  async orchestrateMCPs(organization, timeframe) {\n    console.log('ðŸ“Š Orchestrating MCPs for', organization.name);\n    \n    // Parallel MCP calls with enhanced parameters\n    const mcpCalls = [\n      this.callMCP('pr', 'gather', { \n        organization, \n        timeframe,\n        focus: 'competitive_intelligence' \n      }),\n      this.callMCP('news', 'gather', { \n        organization, \n        timeframe,\n        focus: 'market_trends' \n      }),\n      this.callMCP('media', 'discover', { \n        organization, \n        timeframe,\n        focus: 'media_coverage' \n      }),\n      this.callMCP('opportunities', 'discover', { \n        organization, \n        timeframe,\n        focus: 'strategic_opportunities' \n      }),\n      this.callMCP('analytics', 'analyze', { \n        organization, \n        timeframe,\n        metrics: ['sentiment', 'reach', 'engagement'] \n      }),\n      this.callMCP('relationships', 'assess', { \n        organization, \n        timeframe,\n        stakeholders: 'all' \n      }),\n      this.callMCP('monitor', 'check', { \n        organization, \n        timeframe,\n        alert_level: 'all' \n      }),\n    ];\n\n    const results = await Promise.allSettled(mcpCalls);\n    \n    // Organize results by type with enhanced error handling\n    const mcpData = {\n      competitive: results[0].status === 'fulfilled' ? results[0].value : null,\n      news: results[1].status === 'fulfilled' ? results[1].value : null,\n      media: results[2].status === 'fulfilled' ? results[2].value : null,\n      opportunities: results[3].status === 'fulfilled' ? results[3].value : null,\n      analytics: results[4].status === 'fulfilled' ? results[4].value : null,\n      stakeholder: results[5].status === 'fulfilled' ? results[5].value : null,\n      monitoring: results[6].status === 'fulfilled' ? results[6].value : null,\n    };\n\n    // Log successful data gathering\n    const successfulMCPs = Object.keys(mcpData).filter(k => mcpData[k]);\n    console.log('âœ… MCP data gathered from:', successfulMCPs.join(', '));\n    \n    // Warn about failed MCPs\n    const failedMCPs = Object.keys(mcpData).filter(k => !mcpData[k]);\n    if (failedMCPs.length > 0) {\n      console.warn('âš ï¸ Failed to gather from:', failedMCPs.join(', '));\n    }\n    \n    return mcpData;\n  }\n\n  async callMCP(server, method, params) {\n    try {\n      const response = await fetch(`${this.supabaseUrl}/functions/v1/${server}-intelligence`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          method,\n          params\n        })\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.success && data.data) {\n          return data.data;\n        }\n      }\n      return null;\n    } catch (error) {\n      console.log(`MCP ${server}.${method} failed:`, error.message);\n      return null;\n    }\n  }\n\n  async synthesizeWithClaudeV2(mcpData, organization, goals, timeframe, criticalAnalyses, profile, intelligenceGuidance) {\n    console.log('ðŸ§  Synthesizing with Claude V2 specialized personas');\n    console.log('ðŸ“‹ Profile context:', profile?.identity?.name, profile?.confidence_level);\n    \n    try {\n      // Call different synthesis types in parallel with V2 endpoint, including profile context\n      const synthesisPromises = [\n        this.callClaudeV2Synthesizer('competitor', mcpData.competitive, organization, goals, timeframe, \n          criticalAnalyses.includes('competitor'), profile, intelligenceGuidance),\n        this.callClaudeV2Synthesizer('stakeholder', {\n          relationships: mcpData.stakeholder,\n          media: mcpData.media\n        }, organization, goals, timeframe, \n          criticalAnalyses.includes('stakeholder'), profile, intelligenceGuidance),\n        this.callClaudeV2Synthesizer('narrative', {\n          news: mcpData.news,\n          media: mcpData.media,\n          analytics: mcpData.analytics\n        }, organization, goals, timeframe,\n          criticalAnalyses.includes('narrative'), profile, intelligenceGuidance),\n        this.callClaudeV2Synthesizer('predictive', mcpData, organization, goals, timeframe,\n          criticalAnalyses.includes('predictive'), profile, intelligenceGuidance),\n      ];\n\n      const results = await Promise.allSettled(synthesisPromises);\n      \n      // Get executive summary based on all analyses\n      const allAnalyses = {\n        competitor: results[0].status === 'fulfilled' ? results[0].value : null,\n        stakeholder: results[1].status === 'fulfilled' ? results[1].value : null,\n        narrative: results[2].status === 'fulfilled' ? results[2].value : null,\n        predictive: results[3].status === 'fulfilled' ? results[3].value : null,\n      };\n\n      // Executive summary with second opinion and profile context\n      const executiveSummary = await this.callClaudeV2Synthesizer(\n        'executive_summary', \n        allAnalyses, \n        organization, \n        goals, \n        timeframe,\n        criticalAnalyses.includes('executive_summary'),\n        profile,\n        intelligenceGuidance\n      );\n\n      // Track which personas were activated\n      this.updateActivePersonas(allAnalyses);\n\n      return {\n        ...allAnalyses,\n        executive_summary: executiveSummary,\n        raw_mcp_data: mcpData,\n        analysis_metadata: {\n          timestamp: new Date().toISOString(),\n          timeframe,\n          personas_used: this.getActivePersonas(),\n          critical_analyses: criticalAnalyses,\n          confidence_scores: this.extractConfidenceScores(allAnalyses)\n        }\n      };\n\n    } catch (error) {\n      console.error('Claude V2 synthesis failed:', error);\n      \n      // Fallback to structured MCP data if Claude fails\n      return this.getFallbackAnalysis(mcpData);\n    }\n  }\n\n  async callClaudeV2Synthesizer(intelligenceType, mcpData, organization, goals, timeframe, requiresSecondOpinion = false, profile = null, intelligenceGuidance = null) {\n    // Log what we're sending to Claude\n    console.log(`ðŸš€ Sending to Claude ${intelligenceType}:`, {\n      hasOrganization: !!organization,\n      orgName: organization?.name,\n      industry: organization?.industry,\n      competitors: organization?.competitors,\n      stakeholders: organization?.stakeholders,\n      topics: organization?.topics,\n      goalsCount: Object.keys(goals || {}).filter(k => goals[k]).length,\n      hasMcpData: !!mcpData,\n      hasProfile: !!profile,\n      profileConfidence: profile?.confidence_level\n    });\n    \n    try {\n      const response = await fetch(`${this.supabaseUrl}/functions/v1/claude-intelligence-synthesizer-v2`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.supabaseKey}`\n        },\n        body: JSON.stringify({\n          intelligence_type: intelligenceType,\n          mcp_data: mcpData,\n          organization,\n          goals,\n          timeframe,\n          requires_second_opinion: requiresSecondOpinion,\n          profile: profile ? {\n            established_facts: profile.established_facts,\n            monitoring_targets: profile.monitoring_targets,\n            objectives: profile.objectives,\n            context_flags: profile.context\n          } : null,\n          guidance: intelligenceGuidance\n        })\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        if (data.success && data.analysis) {\n          // Log persona usage\n          if (data.personas_used) {\n            console.log(`ðŸ“ ${intelligenceType} analyzed by:`, data.personas_used.join(', '));\n          }\n          return data.analysis;\n        } else {\n          console.log(`âš ï¸ Claude V2 returned success=false for ${intelligenceType}:`, data.error);\n        }\n      } else {\n        const errorText = await response.text();\n        console.error(`âŒ Claude V2 HTTP error for ${intelligenceType} (${response.status}):`, errorText);\n      }\n      return null;\n    } catch (error) {\n      console.error(`Claude V2 synthesis for ${intelligenceType} failed:`, error);\n      return null;\n    }\n  }\n\n  async storeKeyInsights(intelligence, organization) {\n    // Store critical insights in memory for future reference\n    const keyInsights = [];\n    \n    if (intelligence.executive_summary?.key_insight) {\n      keyInsights.push({\n        type: 'executive_insight',\n        content: intelligence.executive_summary.key_insight,\n        confidence: intelligence.analysis_metadata?.confidence_scores?.executive || 0\n      });\n    }\n    \n    if (intelligence.competitor?.priority_focus) {\n      keyInsights.push({\n        type: 'competitive_priority',\n        content: intelligence.competitor.priority_focus,\n        confidence: intelligence.analysis_metadata?.confidence_scores?.competitor || 0\n      });\n    }\n    \n    if (intelligence.predictive?.cascade_risks?.length > 0) {\n      keyInsights.push({\n        type: 'risk_alert',\n        content: intelligence.predictive.cascade_risks[0],\n        confidence: intelligence.analysis_metadata?.confidence_scores?.predictive || 0\n      });\n    }\n    \n    // Store in localStorage for now (would be database in production)\n    // Use organization name as fallback if no ID exists\n    const memoryId = organization.id || organization.name?.toLowerCase().replace(/\\s+/g, '_');\n    const memoryKey = `signaldesk_memory_${memoryId}`;\n    const existingMemory = JSON.parse(localStorage.getItem(memoryKey) || '[]');\n    \n    keyInsights.forEach(insight => {\n      existingMemory.push({\n        ...insight,\n        timestamp: new Date().toISOString(),\n        organization_id: organization.id\n      });\n    });\n    \n    // Keep only last 100 insights\n    const trimmedMemory = existingMemory.slice(-100);\n    localStorage.setItem(memoryKey, JSON.stringify(trimmedMemory));\n    \n    console.log('ðŸ’¾ Stored', keyInsights.length, 'key insights in memory');\n  }\n\n  updateActivePersonas(analyses) {\n    // Track which personas provided valuable input\n    this.activePersonas = {\n      competitive_strategist: !!analyses.competitor,\n      stakeholder_psychologist: !!analyses.stakeholder,\n      narrative_architect: !!analyses.narrative,\n      risk_prophet: !!analyses.predictive,\n      opportunity_hunter: !!analyses.predictive,\n      executive_synthesizer: !!analyses.executive_summary\n    };\n  }\n\n  getActivePersonas() {\n    return Object.entries(this.activePersonas)\n      .filter(([_, active]) => active)\n      .map(([persona]) => persona);\n  }\n\n  extractConfidenceScores(analyses) {\n    const scores = {};\n    \n    // Extract confidence from second opinions if available\n    Object.entries(analyses).forEach(([key, value]) => {\n      if (value?.consensus_level) {\n        scores[key] = value.consensus_level;\n      } else if (value?.overall_confidence) {\n        scores[key] = value.overall_confidence;\n      } else {\n        scores[key] = 70; // Default confidence\n      }\n    });\n    \n    return scores;\n  }\n\n  getCachedAnalysis(key) {\n    const cached = this.analysisCache.get(key);\n    if (cached && Date.now() - cached.timestamp < this.cacheTimeout) {\n      return cached.data;\n    }\n    this.analysisCache.delete(key);\n    return null;\n  }\n\n  cacheAnalysis(key, data) {\n    this.analysisCache.set(key, {\n      data,\n      timestamp: Date.now()\n    });\n    \n    // Clean old cache entries\n    if (this.analysisCache.size > 10) {\n      const oldestKey = this.analysisCache.keys().next().value;\n      this.analysisCache.delete(oldestKey);\n    }\n  }\n\n  getFallbackAnalysis(mcpData) {\n    // Structured fallback when Claude is unavailable\n    return {\n      competitor: {\n        key_movements: [],\n        strategic_patterns: [\"Analysis temporarily unavailable\"],\n        recommended_actions: [\"Continue monitoring\"],\n        competitive_advantage: \"Under analysis\",\n        priority_focus: \"Maintain current strategy\"\n      },\n      stakeholder: {\n        stakeholder_map: [],\n        coalition_opportunities: [],\n        risk_stakeholders: [],\n        engagement_strategies: [],\n        immediate_actions: [\"Review stakeholder positions\"]\n      },\n      narrative: {\n        goal_narrative_alignment: {},\n        whitespace_opportunities: [],\n        messaging_recommendations: [],\n        emerging_narratives: [],\n        narrative_strategy: \"Maintain consistent messaging\"\n      },\n      predictive: {\n        goal_impact_forecast: {},\n        predicted_competitor_moves: [],\n        cascade_risks: [],\n        goal_vulnerabilities: [],\n        proactive_recommendations: [\"Continue monitoring\"]\n      },\n      executive_summary: {\n        key_insight: \"Intelligence system processing\",\n        immediate_priorities: [\"Gather more data\", \"Monitor developments\"],\n        biggest_opportunity: \"Under analysis\",\n        biggest_risk: \"Limited visibility\",\n        resource_allocation: {},\n        thirty_day_strategy: \"Maintain current operations while gathering intelligence\"\n      },\n      raw_mcp_data: mcpData,\n      analysis_metadata: {\n        timestamp: new Date().toISOString(),\n        fallback_mode: true,\n        personas_used: [],\n        confidence_scores: {}\n      }\n    };\n  }\n}\n\nexport default new ClaudeIntelligenceServiceV2();"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}