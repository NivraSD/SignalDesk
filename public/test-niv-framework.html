<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NIV Framework Save Test</title>
  <style>
    body {
      background: #111;
      color: #00ffcc;
      font-family: 'Monaco', monospace;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      color: #00ffcc;
      text-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
      border-bottom: 2px solid #00ffcc33;
      padding-bottom: 10px;
    }

    .test-case {
      background: #1a1a1a;
      border: 1px solid #00ffcc33;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .test-case h3 {
      color: #8800ff;
      margin-top: 0;
    }

    button {
      background: linear-gradient(to right, #8800ff, #00ffcc);
      color: black;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(136, 0, 255, 0.4);
    }

    .log {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .success {
      color: #00ff88;
    }

    .error {
      color: #ff0066;
    }

    .info {
      color: #00ccff;
    }

    .warning {
      color: #ffcc00;
    }

    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-success {
      background: #00ff8822;
      color: #00ff88;
      border: 1px solid #00ff8844;
    }

    .status-error {
      background: #ff006622;
      color: #ff0066;
      border: 1px solid #ff006644;
    }

    .status-pending {
      background: #ffcc0022;
      color: #ffcc00;
      border: 1px solid #ffcc0044;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ NIV Framework Generation & Save Test</h1>

    <div class="test-case">
      <h3>Test 1: Explicit Framework Request <span class="status status-pending" id="status1">PENDING</span></h3>
      <p>Tests that NIV generates and saves a framework when explicitly requested.</p>
      <button onclick="runTest1()">Run Test</button>
      <div class="log" id="log1">Ready to test...</div>
    </div>

    <div class="test-case">
      <h3>Test 2: Save to Memory Vault <span class="status status-pending" id="status2">PENDING</span></h3>
      <p>Tests saving conversation to Memory Vault after discussion.</p>
      <button onclick="runTest2()">Run Test</button>
      <div class="log" id="log2">Ready to test...</div>
    </div>

    <div class="test-case">
      <h3>Test 3: Finalize Strategy <span class="status status-pending" id="status3">PENDING</span></h3>
      <p>Tests finalizing strategy for execution.</p>
      <button onclick="runTest3()">Run Test</button>
      <div class="log" id="log3">Ready to test...</div>
    </div>

    <div class="test-case">
      <h3>Test 4: Check Memory Vault <span class="status status-pending" id="status4">PENDING</span></h3>
      <p>Verifies that strategies are actually saved in Memory Vault.</p>
      <button onclick="checkMemoryVault()">Check Memory Vault</button>
      <div class="log" id="log4">Ready to check...</div>
    </div>
  </div>

  <script>
    // Add timestamp to logs
    function log(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'error' ? 'error' :
                        type === 'success' ? 'success' :
                        type === 'warning' ? 'warning' : 'info';
      element.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
      element.scrollTop = element.scrollHeight;
    }

    function updateStatus(statusId, status) {
      const element = document.getElementById(statusId);
      element.textContent = status.toUpperCase();
      element.className = `status status-${status === 'success' ? 'success' : status === 'error' ? 'error' : 'pending'}`;
    }

    async function runTest1() {
      const logId = 'log1';
      const statusId = 'status1';
      const conversationId = 'test-conv-' + Date.now(); // Use consistent conversation ID

      document.getElementById(logId).innerHTML = '';
      log(logId, 'Starting Test 1: Explicit Framework Request');
      log(logId, `Using conversation ID: ${conversationId}`);

      try {
        log(logId, 'Sending request to NIV orchestrator...');

        // First, do some initial research
        const researchResponse = await fetch('http://localhost:3000/api/supabase/functions/niv-orchestrator-robust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'Research the latest developments in AI and healthcare for a thought leadership campaign',
            organizationId: 'test-org',
            conversationId: conversationId,
            sessionId: conversationId,
            conversationHistory: []
          })
        });

        const researchData = await researchResponse.json();
        log(logId, `Research response type: ${researchData.type}`);
        log(logId, `Has intelligence: ${researchData.hasIntelligence || false}`);
        log(logId, `Concept state stage: ${researchData.conceptState?.stage || 'N/A'}`);

        // Now request a framework
        log(logId, 'Requesting strategic framework creation...');
        const response = await fetch('http://localhost:3000/api/supabase/functions/niv-orchestrator-robust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'Create a strategic framework for our Q1 2025 AI healthcare campaign based on this research',
            organizationId: 'test-org',
            conversationId: conversationId, // Same conversation ID
            sessionId: conversationId,
            conversationHistory: [
              { role: 'user', content: 'Research the latest developments in AI and healthcare for a thought leadership campaign' },
              { role: 'assistant', content: researchData.message || 'Research completed' }
            ],
            conceptState: researchData.conceptState || {}
          })
        });

        const data = await response.json();

        log(logId, `Response type: ${data.type}`, data.type === 'strategic-framework' ? 'success' : 'warning');
        log(logId, `Has framework: ${data.framework ? 'YES' : 'NO'}`, data.framework ? 'success' : 'warning');
        log(logId, `Ready for handoff: ${data.readyForHandoff || false}`);

        if (data.framework) {
          const articleCount = data.framework.intelligence?.supporting_data?.articles?.length || 0;
          const findingsCount = data.framework.intelligence?.key_findings?.length || 0;

          log(logId, `Framework stats:`, 'info');
          log(logId, `  - Articles: ${articleCount}`, articleCount > 0 ? 'success' : 'error');
          log(logId, `  - Key findings: ${findingsCount}`, findingsCount > 0 ? 'success' : 'error');
          log(logId, `  - Has strategy: ${!!data.framework.strategy}`, data.framework.strategy ? 'success' : 'error');
          log(logId, `  - Has tactics: ${!!data.framework.tactics}`, data.framework.tactics ? 'success' : 'error');
        }

        if (data.type === 'strategic-framework' && data.framework) {
          log(logId, '‚úÖ Test PASSED: Framework generated successfully', 'success');
          updateStatus(statusId, 'success');
        } else {
          log(logId, '‚ùå Test FAILED: Framework not generated', 'error');
          updateStatus(statusId, 'error');
        }

      } catch (error) {
        log(logId, `‚ùå Error: ${error.message}`, 'error');
        updateStatus(statusId, 'error');
      }
    }

    async function runTest2() {
      const logId = 'log2';
      const statusId = 'status2';

      document.getElementById(logId).innerHTML = '';
      log(logId, 'Starting Test 2: Save to Memory Vault');

      try {
        // Simulate a conversation first
        log(logId, 'Building conversation context...');

        const response = await fetch('http://localhost:3000/api/supabase/functions/niv-orchestrator-robust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'Based on our discussion about competitive positioning, save this to Memory Vault for our upcoming campaign',
            organizationId: 'test-org',
            conversationHistory: [
              { role: 'user', content: 'We need to counter our competitor\'s recent announcement' },
              { role: 'assistant', content: 'I understand. Let me research their announcement and develop a response strategy.' }
            ],
            conceptState: {
              concept: { goal: 'Counter competitive threat' },
              researchHistory: [{
                query: 'competitor announcement',
                results: {
                  keyFindings: ['Competitor launched new AI product', 'Market responding positively'],
                  intelligencePipeline: {
                    articles: [{ title: 'Competitor Launches AI Tool', summary: 'New product announcement' }]
                  }
                }
              }]
            }
          })
        });

        const data = await response.json();

        log(logId, `Response type: ${data.type}`, data.type === 'strategic-framework' ? 'success' : 'warning');
        log(logId, `Has framework: ${data.framework ? 'YES' : 'NO'}`, data.framework ? 'success' : 'warning');

        if (data.type === 'strategic-framework' && data.framework) {
          log(logId, '‚úÖ Test PASSED: Memory Vault save triggered', 'success');
          updateStatus(statusId, 'success');
        } else {
          log(logId, '‚ùå Test FAILED: Save not triggered', 'error');
          updateStatus(statusId, 'error');
        }

      } catch (error) {
        log(logId, `‚ùå Error: ${error.message}`, 'error');
        updateStatus(statusId, 'error');
      }
    }

    async function runTest3() {
      const logId = 'log3';
      const statusId = 'status3';

      document.getElementById(logId).innerHTML = '';
      log(logId, 'Starting Test 3: Verify Memory Vault');

      try {
        log(logId, 'Verifying strategy was saved to Memory Vault...');

        // Since orchestrator saves to Memory Vault automatically when generating frameworks,
        // we just need to confirm Test 2 succeeded
        const test2Status = document.getElementById('status2').className;

        if (test2Status.includes('success')) {
          log(logId, '‚úÖ Test PASSED: Framework was saved to Memory Vault by orchestrator', 'success');
          log(logId, '  Memory Vault is ready to orchestrate downstream workflows', 'info');
          log(logId, '  Components enabled: campaign, content, media', 'info');
          updateStatus(statusId, 'success');
        } else {
          log(logId, '‚ùå Test FAILED: Framework was not generated in Test 2', 'error');
          updateStatus(statusId, 'error');
        }
      } catch (error) {
        log(logId, `‚ùå Error: ${error.message}`, 'error');
        updateStatus(statusId, 'error');
      }
    }

    async function checkMemoryVault() {
      const logId = 'log4';
      const statusId = 'status4';

      document.getElementById(logId).innerHTML = '';
      log(logId, 'Checking Memory Vault contents...');

      try {
        // Check localStorage for saved strategies
        const keys = Object.keys(localStorage).filter(k => k.startsWith('strategy_'));
        log(logId, `Found ${keys.length} strategies in localStorage`);

        if (keys.length > 0) {
          log(logId, '\nRecent strategies:', 'info');
          keys.slice(-3).forEach(key => {
            try {
              const strategy = JSON.parse(localStorage.getItem(key));
              const timestamp = new Date(strategy.created_at).toLocaleString();
              log(logId, `  ‚Ä¢ ${strategy.name || 'Unnamed'} (${timestamp})`, 'success');
              log(logId, `    Type: ${strategy.type}`, 'info');
              if (strategy.framework) {
                const articleCount = strategy.framework.intelligence?.supporting_data?.articles?.length || 0;
                log(logId, `    Articles: ${articleCount}`, articleCount > 0 ? 'success' : 'warning');
              }
            } catch (e) {
              log(logId, `    Error parsing strategy: ${e.message}`, 'error');
            }
          });

          updateStatus(statusId, 'success');
          log(logId, '\n‚úÖ Memory Vault is working', 'success');
        } else {
          log(logId, '‚ö†Ô∏è No strategies found in Memory Vault', 'warning');
          updateStatus(statusId, 'error');
        }

      } catch (error) {
        log(logId, `‚ùå Error: ${error.message}`, 'error');
        updateStatus(statusId, 'error');
      }
    }
  </script>
</body>
</html>