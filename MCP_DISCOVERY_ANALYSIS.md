# MCP-Discovery Issues Analysis

## Issue 1: NIV Advisor Variable Reference Bug ✅ FIXED

### Problem
NIV Advisor was failing to load organization profiles from mcp-discovery with the error:
```
ReferenceError: organizationName is not defined
```

### Root Cause
In `supabase/functions/niv-advisor/index.ts`, the `getMcpDiscovery()` function parameter is named `organizationInput`, but the code referenced `organizationName` in 4 places:

1. **Line 1228**: `keywords: [organizationName]`
2. **Line 1243**: `return createDefaultProfile(organizationName)`
3. **Line 1252**: `return createDefaultProfile(organizationName)`
4. **Line 1258**: `return createDefaultProfile(organizationName)`

### Solution Implemented
Changed all 4 references from `organizationName` to `organizationInput` to match the function parameter.

### Impact
- Intelligence/Executive Synthesis successfully loaded profiles (as seen in logs)
- NIV Advisor was failing to load profiles, falling back to default
- This caused NIV Advisor to not have access to competitor intelligence, keywords, and industry context

---

## Issue 2: Semantic Matching Gap - Simple Word Matching vs. Understanding

### Problem Statement
**MCP-discovery creates rich semantic understanding of organizations but uses literal string matching for article relevance**

The system has two contradictory approaches:
1. **Deep Semantic Understanding (Claude)**: Creates comprehensive profiles with descriptions, industry analysis, competitive dynamics
2. **Literal String Matching (Relevance Scoring)**: Uses `.includes()` to match articles against keywords

### Example
**Profile Generated by Claude:**
```json
{
  "organization_name": "Hootsuite",
  "description": "Hootsuite is a leading social media management platform...",
  "industry": "Social Media Management & Marketing Technology",
  "keywords": ["social media management", "content scheduling", "Hootsuite"]
}
```

**Article that SHOULD match but DOESN'T:**
- Title: "Digital engagement tools revolutionize marketing workflows"
- Content: "...platforms for social content orchestration are seeing rapid adoption..."

**Why it fails:** The article describes the exact industry and use case but uses different terminology ("digital engagement tools", "social content orchestration") than the literal keywords ("social media management", "content scheduling").

### Code Evidence

#### 1. mcp-discovery creates semantic understanding
**File:** `supabase/functions/mcp-discovery/index.ts`
- Line 294-612: Claude analyzes organization and creates rich profile with description, industry classification, competitive dynamics
- The profile **understands** what the company does semantically

#### 2. But keyword generation is simplistic
**File:** `supabase/functions/mcp-discovery/index.ts` (lines 809-818)
```typescript
function generateKeywords(organization_name: string, analysisData: any): string[] {
  const keywords = [
    organization_name,
    ...analysisData.monitoring_config?.keywords || [],
    ...analysisData.competition?.direct_competitors?.slice(0, 5) || [],
    ...analysisData.trending?.hot_topics?.slice(0, 5) || []
  ];

  return [...new Set(keywords)];
}
```
Just concatenates strings without semantic expansion.

#### 3. Sub-category discovery uses literal matching
**File:** `supabase/functions/mcp-discovery/industry-competitors.ts` (lines 407-471)
```typescript
const searchText = `${organization} ${description}`.toLowerCase();

for (const [subCategory, terms] of Object.entries(keywords)) {
  let score = 0;
  for (const term of terms) {
    if (searchText.includes(term.toLowerCase())) {  // ❌ Literal string match
      score += 1;
    }
  }
}
```

#### 4. Article relevance scoring uses literal matching
**File:** `supabase/functions/monitor-stage-2-relevance/index.ts`

**Competitor matching (lines 316-321):**
```typescript
const competitorInTitle = targetEntities.competitors.find(comp =>
  comp && titleText.includes(comp.toLowerCase())  // ❌ Literal string match
);
const competitorMentioned = targetEntities.competitors.filter(comp =>
  comp && text.includes(comp.toLowerCase())  // ❌ Literal string match
);
```

**Keyword matching (lines 328-330):**
```typescript
targetEntities.keywords.forEach(keyword => {
  if (text.includes(keyword.toLowerCase())) {  // ❌ Literal string match
    // Categorize the keyword...
  }
});
```

### The Disconnect

| Component | Approach | Example |
|-----------|----------|---------|
| **mcp-discovery (Claude)** | Semantic understanding | "Hootsuite is a social media management platform that enables businesses to schedule, publish, and analyze social media content" |
| **keyword generation** | String concatenation | `["Hootsuite", "social media management", "Facebook", "Twitter"]` |
| **industry-competitors** | Literal substring match | `searchText.includes("social media")` |
| **relevance scoring** | Literal substring match | `text.includes("social media management")` |

### Real-World Impact

**Scenario 1: Synonym Mismatch**
- Profile keyword: "social media management"
- Article terms: "social engagement platform", "content scheduling tool", "digital marketing solution"
- **Result:** Article missed even though it's highly relevant

**Scenario 2: Competitor Variations**
- Profile competitor: "Sprout Social"
- Article mentions: "SproutSocial", "Sprout", "the social media analytics company"
- **Result:** Only exact "Sprout Social" matches, others missed

**Scenario 3: Industry Evolution**
- Profile created with: "electric vehicle manufacturer"
- Industry now says: "EV maker", "battery-electric automaker", "zero-emission vehicle company"
- **Result:** Misses newer terminology that has emerged since profile creation

### Proposed Solutions

#### Short-term (Quick Wins)
1. **Expand keyword matching to include common variations**
   - Add fuzzy matching for company names (e.g., "SproutSocial" matches "Sprout Social")
   - Include common abbreviations (e.g., "EV" for "electric vehicle")

2. **Use Claude's description for matching**
   - Extract key phrases from the semantic description
   - Use these as additional matching signals

#### Medium-term (Better Semantic Matching)
1. **Semantic similarity scoring**
   - Use embeddings to compare article content to profile description
   - Score based on semantic similarity, not just keyword overlap

2. **Dynamic keyword expansion**
   - When keywords are generated, use Claude to create synonym sets
   - Include industry-standard terminology variations

#### Long-term (Semantic Search)
1. **Vector-based article matching**
   - Embed articles and profile descriptions
   - Use semantic search (e.g., pgvector in Supabase) for relevance

2. **Continuous learning**
   - Track which articles users find relevant
   - Expand keyword sets based on user feedback

### Recommended Immediate Action

1. ✅ **DONE**: Fix the NIV Advisor variable bug
2. **TODO**: Add synonym expansion to keyword generation
3. **TODO**: Include profile description in relevance scoring prompt to Claude
4. **TODO**: Consider hybrid approach: keyword matching + semantic similarity score

### Code Locations for Changes

1. **Keyword Generation**: `supabase/functions/mcp-discovery/index.ts:809-818`
2. **Industry Discovery**: `supabase/functions/mcp-discovery/industry-competitors.ts:407-471`
3. **Relevance Scoring**: `supabase/functions/monitor-stage-2-relevance/index.ts:296-450`

### Example Fix: Enhanced Keyword Matching

Instead of:
```typescript
if (text.includes(keyword.toLowerCase())) {
  // match found
}
```

Use:
```typescript
// Create variations of the keyword
const keywordVariations = expandKeyword(keyword);
const matched = keywordVariations.some(variant =>
  text.includes(variant.toLowerCase())
);

if (matched) {
  // match found
}
```

Where `expandKeyword()` could:
- Split multi-word keywords and match partial phrases
- Include common abbreviations
- Handle company name variations
- Use the semantic description as a matching signal
