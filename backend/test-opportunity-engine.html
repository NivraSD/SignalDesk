<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Opportunity Engine Analysis</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0a0a;
            color: #e8e8e8;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 { color: #60a5fa; }
        h2 { color: #a78bfa; margin-top: 30px; }
        button {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        .status { 
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        #log {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid rgba(139, 92, 246, 0.3);
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <h1>üî¨ Opportunity Engine Analysis Test</h1>
    
    <div class="test-section">
        <h2>Test Objective</h2>
        <p>Verify that clicking "Analyze" in the Opportunity Engine shows analysis within the component, not in Content Generator.</p>
    </div>

    <div class="test-section">
        <h2>Authentication</h2>
        <button onclick="testLogin()">1. Login First</button>
        <div id="authStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Test Opportunity Engine</h2>
        <button onclick="openApp()">2. Open SignalDesk App</button>
        <button onclick="testOpportunityAnalysis()">3. Test Analysis API Directly</button>
        <div id="testStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Debug Log</h2>
        <div id="log"></div>
    </div>

    <script>
        const API_URL = 'https://signaldesk-production.up.railway.app/api';
        const FRONTEND_URL = 'https://signaldesk-frontend.vercel.app';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="${type}">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testLogin() {
            log('Testing login...');
            const authDiv = document.getElementById('authStatus');
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'demo@example.com',
                        password: 'demo123!@#'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    authDiv.innerHTML = '<span class="success">‚úÖ Login successful! Token saved.</span>';
                    log('Login successful', 'success');
                    log(`Token: ${data.token.substring(0, 20)}...`, 'info');
                } else {
                    authDiv.innerHTML = '<span class="error">‚ùå Login failed: ' + (data.message || 'Unknown error') + '</span>';
                    log('Login failed: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                authDiv.innerHTML = '<span class="error">‚ùå Login error: ' + error.message + '</span>';
                log('Login error: ' + error.message, 'error');
            }
        }

        function openApp() {
            log('Opening SignalDesk frontend...', 'info');
            window.open(FRONTEND_URL, '_blank');
            log('Instructions:', 'warning');
            log('1. Navigate to the Project page', 'info');
            log('2. Find the Opportunity Engine panel', 'info');
            log('3. Click "Analyze" on any opportunity', 'info');
            log('4. Check if analysis shows in Opportunity Engine or Content Generator', 'info');
        }

        async function testOpportunityAnalysis() {
            log('Testing Opportunity Engine analysis behavior...', 'info');
            const statusDiv = document.getElementById('testStatus');
            const token = localStorage.getItem('token');
            
            if (!token) {
                statusDiv.innerHTML = '<span class="error">‚ùå Please login first!</span>';
                log('No token found. Please login first.', 'error');
                return;
            }

            try {
                // Test 1: Check if opportunities endpoint works
                log('Fetching opportunities...', 'info');
                const oppResponse = await fetch(`${API_URL}/opportunities/discover`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (oppResponse.ok) {
                    const oppData = await oppResponse.json();
                    log(`Found ${oppData.opportunities?.length || 0} opportunities`, 'success');
                } else {
                    log('Opportunities endpoint returned: ' + oppResponse.status, 'warning');
                }

                // Test 2: Check what happens with an analyze-like message
                log('Testing AI message handling...', 'info');
                const aiResponse = await fetch(`${API_URL}/ai/unified-chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Analyze this opportunity for me',
                        mode: 'general',
                        context: {
                            folder: 'opportunity-engine'
                        }
                    })
                });

                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    log('AI Response received', 'success');
                    log('Is Generated Content: ' + (aiData.isGeneratedContent ? 'YES' : 'NO'), 
                        aiData.isGeneratedContent ? 'warning' : 'success');
                    
                    if (aiData.isGeneratedContent) {
                        statusDiv.innerHTML = '<span class="warning">‚ö†Ô∏è AI is treating "analyze" as content generation!</span>';
                        log('ISSUE FOUND: Backend is treating analysis as content generation', 'error');
                    } else {
                        statusDiv.innerHTML = '<span class="success">‚úÖ Analysis stays in correct context</span>';
                        log('Analysis is handled correctly', 'success');
                    }
                } else {
                    log('AI endpoint error: ' + aiResponse.status, 'error');
                }

            } catch (error) {
                statusDiv.innerHTML = '<span class="error">‚ùå Test error: ' + error.message + '</span>';
                log('Test error: ' + error.message, 'error');
            }
        }

        // Initialize
        log('Test page loaded', 'success');
        log('Ready to test Opportunity Engine analysis behavior', 'info');
    </script>
</body>
</html>