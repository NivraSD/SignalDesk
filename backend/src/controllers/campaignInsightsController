// campaignInsightsController.js - New controller for insights-based campaigns
const claudeService = require("../../config/claude");
const pool = require("../../config/database");

// Generate insights report (informational only, not for approval)
const generateInsightsReport = async (req, res) => {
  try {
    const { brief, companyName, campaignType, budget, duration } = req.body;
    const userId = req.user.id;

    if (!brief) {
      return res.status(400).json({
        success: false,
        message: "Campaign brief is required",
      });
    }

    // Generate comprehensive insights report
    const insightsPrompt = `
      You are a senior marketing strategist creating an insights report for a campaign.
      
      Client: ${companyName}
      Campaign Type: ${campaignType}
      Budget: $${budget.toLocaleString()}
      Timeline: ${duration}
      
      Campaign Brief: ${brief}
      
      Create a comprehensive insights report with the following sections:
      
      1. EXECUTIVE SUMMARY
      - High-level overview of the opportunity
      - Key strategic considerations
      - Critical success factors
      
      2. MARKET ANALYSIS
      - Current market conditions and trends
      - Competitive landscape overview
      - Market opportunities and gaps
      - Industry benchmarks and best practices
      
      3. TARGET AUDIENCE INSIGHTS
      - Audience demographics and psychographics
      - Buyer journey and decision criteria
      - Pain points and motivations
      - Preferred channels and content types
      
      4. STRATEGIC CONSIDERATIONS
      - Positioning opportunities
      - Messaging frameworks
      - Differentiation strategies
      - Potential partnerships or alliances
      
      5. CHANNEL RECOMMENDATIONS
      - Most effective channels for this campaign
      - Channel-specific best practices
      - Budget allocation suggestions
      - Integration opportunities
      
      6. SUCCESS FACTORS & RISKS
      - Critical success factors
      - Potential challenges and risks
      - Mitigation strategies
      - Key performance indicators
      
      Format the response as a structured JSON object. Make insights specific to their industry and campaign type.
      Focus on actionable intelligence that will inform campaign development.
    `;

    const insightsResponse = await claudeService.sendMessage(insightsPrompt);

    // Parse the response
    let insights;
    try {
      insights = JSON.parse(insightsResponse);
    } catch (e) {
      // If not JSON, structure it
      insights = {
        executiveSummary: "Strategic insights for your campaign",
        marketAnalysis: {
          title: "Market Analysis",
          content: {
            trends: "Current market trends and dynamics",
            competitive: "Competitive landscape overview",
            opportunities: "Key opportunities identified",
            benchmarks: "Industry benchmarks to consider",
          },
        },
        audienceInsights: {
          title: "Target Audience Insights",
          content: {
            demographics: "Target audience profile",
            journey: "Buyer journey insights",
            painPoints: "Key pain points to address",
            preferences: "Channel and content preferences",
          },
        },
        strategicConsiderations: {
          title: "Strategic Considerations",
          content: {
            positioning: "Positioning recommendations",
            messaging: "Core messaging framework",
            differentiation: "Differentiation strategies",
            partnerships: "Partnership opportunities",
          },
        },
        channelRecommendations: {
          title: "Channel Recommendations",
          content: {
            primary: "Primary channels to prioritize",
            secondary: "Secondary channel opportunities",
            budget: "Budget allocation recommendations",
            integration: "Channel integration strategies",
          },
        },
        successFactors: {
          title: "Success Factors & Risks",
          content: {
            critical: "Critical success factors",
            challenges: "Potential challenges",
            mitigation: "Risk mitigation strategies",
            kpis: "Key performance indicators",
          },
        },
      };
    }

    res.json({
      success: true,
      insights,
      message: "Insights report generated successfully",
    });
  } catch (error) {
    console.error("Error in generateInsightsReport:", error);
    res.status(500).json({
      success: false,
      message: "Failed to generate insights report",
      error: error.message,
    });
  }
};

// Generate campaign based on insights
const generateCampaignFromInsights = async (req, res) => {
  try {
    const { templateId, template, brief, insights, customizations } = req.body;
    const userId = req.user.id;

    if (!template || !brief || !insights) {
      return res.status(400).json({
        success: false,
        message: "Template, brief, and insights are required",
      });
    }

    // Generate comprehensive campaign plan using insights
    const campaignPrompt = `
      Based on the insights report and template, create a detailed, actionable campaign plan.
      
      Template: ${JSON.stringify(template)}
      Insights: ${JSON.stringify(insights)}
      Brief: ${brief}
      Customizations: ${JSON.stringify(customizations)}
      
      Generate a comprehensive campaign with the following populated sections:
      
      1. CAMPAIGN OVERVIEW
      - Campaign name and description
      - Duration: ${customizations.timeline}
      - Total budget: $${customizations.budget}
      
      2. STRATEGIC OBJECTIVES (from insights report)
      - 3-5 specific, measurable objectives derived from the insights
      - Each objective should tie back to the brief and insights
      
      3. CAMPAIGN PHASES
      For each phase in the template (${template.phases.join(", ")}):
      - Phase name
      - Duration (specific weeks/dates)
      - Description of activities
      - Key deliverables
      - Budget allocation
      
      4. KEY ACTIVITIES
      Based on template activities and insights, provide:
      - Activity name
      - Description
      - Timeline
      - Resources needed
      - Expected outcomes
      
      5. CHANNEL STRATEGY
      Based on channel recommendations from insights:
      - Channel name
      - Strategy description
      - Specific tactics
      - Budget allocation
      - Performance expectations
      
      6. SUCCESS METRICS
      Based on the template metrics and insights KPIs:
      - Metric name
      - Target value (specific number)
      - Measurement method
      - Reporting frequency
      - Success benchmark
      
      7. CONTENT BRIEFS
      - At least 3-5 content pieces needed
      - Type of content
      - Purpose and audience
      - Key messages
      - Distribution channels
      
      8. BUDGET BREAKDOWN
      - Detailed allocation by category
      - Phase-wise distribution
      - Contingency planning
      
      Make everything specific, actionable, and tied to the insights provided.
      Format as a structured JSON object with populated data, not placeholders.
    `;

    const campaignResponse = await claudeService.sendMessage(campaignPrompt);

    // Parse and structure the campaign plan
    let campaign;
    try {
      campaign = JSON.parse(campaignResponse);
    } catch (e) {
      // Fallback structure with populated data
      campaign = {
        name: `${template.name} Campaign`,
        description: template.description,
        duration: customizations.timeline,
        budget: {
          total: customizations.budget,
          breakdown: {
            paidMedia: Math.round(customizations.budget * 0.4),
            content: Math.round(customizations.budget * 0.25),
            events: Math.round(customizations.budget * 0.2),
            tools: Math.round(customizations.budget * 0.1),
            contingency: Math.round(customizations.budget * 0.05),
          },
        },
        strategicObjectives: [
          `Generate ${Math.round(
            customizations.budget / 500
          )} qualified leads within ${customizations.timeline}`,
          `Achieve 25% brand awareness increase in target market`,
          `Establish thought leadership with 10+ media placements`,
          `Drive $${customizations.budget * 10} in pipeline value`,
        ],
        phases: template.phases.map((phase, index) => ({
          name: phase,
          duration: `Weeks ${index * 3 + 1}-${(index + 1) * 3}`,
          description: `Execute ${phase} activities and deliverables`,
          budget: Math.round(customizations.budget / template.phases.length),
        })),
        keyActivities: template.keyActivities.map((activity) => ({
          name: activity,
          description: `Implement ${activity} to drive campaign objectives`,
          timeline: "Throughout campaign",
          resources: "Internal team + external partners",
        })),
        channelStrategy: template.channels.reduce((acc, channel) => {
          acc[channel] = {
            description: `Leverage ${channel} for maximum reach and engagement`,
            tactics: [
              `${channel}-specific content creation`,
              `${channel} community engagement`,
              `${channel} paid promotion`,
            ],
            budget: Math.round(
              customizations.budget / template.channels.length
            ),
          };
          return acc;
        }, {}),
        metrics: template.metrics.map((metric) => ({
          metric: metric,
          target: "TBD based on benchmarks",
          measurement: "Weekly tracking",
          category: "Performance KPI",
        })),
        contentBriefs: [
          {
            type: "press-release",
            title: "Launch Announcement Press Release",
            brief: "Announce the campaign launch to media",
            audience: "Industry media and analysts",
          },
          {
            type: "social-posts",
            title: "Social Media Campaign Content",
            brief: "Series of social posts for campaign phases",
            audience: "Target customer segments",
          },
          {
            type: "thought-leadership",
            title: "Executive Thought Leadership Article",
            brief: "Position leadership on industry trends",
            audience: "Industry influencers and decision makers",
          },
        ],
      };
    }

    // Ensure campaign has all required fields populated
    if (!campaign.strategicObjectives) {
      campaign.strategicObjectives = [
        "Increase brand awareness and market presence",
        "Generate qualified leads and sales opportunities",
        "Establish thought leadership in the industry",
        "Build strategic partnerships and alliances",
      ];
    }

    res.json({
      success: true,
      campaign,
      message: "Campaign generated successfully",
    });
  } catch (error) {
    console.error("Error in generateCampaignFromInsights:", error);
    res.status(500).json({
      success: false,
      message: "Failed to generate campaign",
      error: error.message,
    });
  }
};

// Export all functions
module.exports = {
  generateInsightsReport,
  generateCampaignFromInsights,
};
