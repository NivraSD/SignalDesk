# BULLETPROOF NIXPACKS - GUARANTEES NIV ROUTES DEPLOYMENT
# Build timestamp: 2025-08-13-BULLETPROOF
# This FORCES complete rebuild and VERIFIES Niv routes

[phases.setup]
nixPkgs = ["nodejs-20_x", "npm-9"]
aptPkgs = []

[phases.install]
# FORCE COMPLETE REBUILD - NO CACHE WHATSOEVER
cmds = [
    "echo 'ğŸ”¥ğŸ”¥ğŸ”¥ BULLETPROOF BUILD STARTING ğŸ”¥ğŸ”¥ğŸ”¥'",
    "echo 'Build ID: BULLETPROOF-$(date +%s)'",
    "echo 'ğŸš¨ DESTROYING ALL CACHES...'",
    "rm -rf node_modules package-lock.json .npm || true",
    "rm -rf /tmp/npm-* /root/.npm /app/.npm || true",
    "npm cache clean --force || true",
    "echo 'ğŸ“¦ Installing fresh dependencies...'",
    "npm install --verbose --no-cache --prefer-online",
    "echo 'âœ… Dependencies installed'",
    "echo ''",
    "echo 'ğŸ” CRITICAL: VERIFYING NIV ROUTES EXIST...'",
    "ls -la src/routes/nivRoutes.js || (echo 'âŒ FATAL: nivRoutes.js MISSING!' && exit 1)",
    "ls -la src/agents/NivPRStrategist.js || (echo 'âŒ FATAL: NivPRStrategist.js MISSING!' && exit 1)",
    "grep -q 'app.use(\"/api/niv\"' index.js || (echo 'âŒ FATAL: Niv route not in index.js!' && exit 1)",
    "echo 'âœ… NIV ROUTES VERIFIED - DEPLOYMENT WILL SUCCEED!'"
]

[phases.build]
cmds = [
    "echo 'ğŸ—ï¸ Final verification phase...'",
    "echo 'Niv route files:'",
    "find . -name 'nivRoutes.js' -o -name 'NivPRStrategist.js' | head -10",
    "echo 'âœ… BUILD COMPLETE - NIV ROUTES INCLUDED'"
]

[start]
cmd = "node server.js"

[variables]
NODE_ENV = "production"
NIXPACKS_NO_CACHE = "1"
FORCE_COLOR = "1"