<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Niv Response</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #8b5cf6;
        }
        .test-button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .output {
            background: #000;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .debug { color: #8b5cf6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Niv Response</h1>
        
        <button class="test-button" onclick="testSimple()">
            Test Simple Request
        </button>
        
        <button class="test-button" onclick="testDirect()">
            Test Direct Creation
        </button>
        
        <button class="test-button" onclick="testWithContext()">
            Test With Context
        </button>
        
        <div id="output" class="output"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        async function callNiv(message, messages = []) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/niv-orchestrator`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    messages: messages,
                    context: {},
                    mode: 'strategic_orchestration'
                })
            });
            return await response.json();
        }

        async function testSimple() {
            log('=== Testing Simple Request ===', 'info');
            
            try {
                const message = "Create a media plan for our AI product launch";
                log(`Request: "${message}"`, 'debug');
                
                const response = await callNiv(message);
                
                log('\nüîç FULL RESPONSE OBJECT:', 'warning');
                log(JSON.stringify(response, null, 2), 'debug');
                
                log('\nüìù NIV SAYS:', 'info');
                log(response.response || 'NO RESPONSE', 'success');
                
                log('\nüì¶ WORK ITEMS:', 'info');
                if (response.workItems && response.workItems.length > 0) {
                    response.workItems.forEach((item, i) => {
                        log(`Item ${i + 1}: ${item.type} - ${item.title}`, 'success');
                    });
                } else {
                    log('No work items created', 'error');
                }
                
                // Check if response contains creation phrases
                log('\nüîç CHECKING FOR CREATION PHRASES:', 'info');
                const creationPhrases = ["I'll create", "let me create", "I'll generate", "I'm creating"];
                const responseText = (response.response || '').toLowerCase();
                
                creationPhrases.forEach(phrase => {
                    if (responseText.includes(phrase.toLowerCase())) {
                        log(`‚úÖ Found: "${phrase}"`, 'success');
                    } else {
                        log(`‚ùå Not found: "${phrase}"`, 'error');
                    }
                });
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function testDirect() {
            log('\n=== Testing Direct Creation Request ===', 'info');
            
            try {
                // Conversation history showing we've already discussed the project
                const messages = [
                    { type: 'user', content: 'I need help with PR for our AI coding assistant' },
                    { type: 'assistant', content: 'I can help with your AI coding assistant PR. What are your goals and timeline?' },
                    { type: 'user', content: 'Launching next month, targeting developers through tech media' }
                ];
                
                const message = "Perfect. Now please create a media plan and press release for the launch";
                log(`Request (with context): "${message}"`, 'debug');
                
                const response = await callNiv(message, messages);
                
                log('\nüìù NIV SAYS:', 'info');
                log(response.response || 'NO RESPONSE', 'success');
                
                log('\nüì¶ WORK ITEMS:', 'info');
                if (response.workItems && response.workItems.length > 0) {
                    response.workItems.forEach((item, i) => {
                        log(`Item ${i + 1}: ${item.type} - ${item.title}`, 'success');
                    });
                } else {
                    log('No work items created', 'error');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function testWithContext() {
            log('\n=== Testing With Full Context ===', 'info');
            
            try {
                const messages = [
                    { type: 'user', content: 'I need PR help for our AI product launch' },
                    { type: 'assistant', content: "I'd be happy to help with your AI product launch PR. To create the most effective materials, could you tell me more about your product, target audience, and timeline?" },
                    { type: 'user', content: "It's an AI coding assistant for developers, launching next month. We want to reach tech media and developer communities." },
                    { type: 'assistant', content: "Excellent! An AI coding assistant targeting developers is a compelling story. With your launch next month, we should focus on tier-1 tech media and developer-focused publications. I can create comprehensive PR materials for you." }
                ];
                
                const message = "Yes, please create everything we'll need: media plan, press release, strategic plan, and key messaging";
                log(`Request: "${message}"`, 'debug');
                log('With conversation history...', 'debug');
                
                const response = await callNiv(message, messages);
                
                log('\nüìù NIV SAYS:', 'info');
                log(response.response || 'NO RESPONSE', 'success');
                
                log('\nüì¶ WORK ITEMS:', 'info');
                if (response.workItems && response.workItems.length > 0) {
                    log(`Created ${response.workItems.length} items:`, 'success');
                    response.workItems.forEach((item, i) => {
                        log(`${i + 1}. ${item.type}: ${item.title}`, 'success');
                        if (item.generatedContent) {
                            log(`   ‚úÖ Has content`, 'debug');
                        } else {
                            log(`   ‚ùå No content`, 'error');
                        }
                    });
                } else {
                    log('No work items created', 'error');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>