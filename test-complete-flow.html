<!DOCTYPE html>
<html>
<head>
    <title>Test Complete Flow</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { background: #0f0; color: #000; padding: 10px 20px; margin: 10px; cursor: pointer; }
        .stage { margin: 10px 0; padding: 10px; border: 1px solid #0f0; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .data { color: #ff0; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Complete Intelligence Pipeline Flow</h1>
    <button onclick="testPipeline()">Run Complete Test</button>
    <div id="output"></div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';

        function log(message, type = 'data') {
            document.getElementById('output').innerHTML += `<div class="${type}">${message}</div>`;
        }

        async function testPipeline() {
            log('Starting pipeline test...', 'success');
            
            // Test Stage 1: Extraction
            log('\nüìä Stage 1: Extraction (Discovery)', 'stage');
            const stage1Response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-discovery-v3`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    organization: 'OpenAI',
                    organizationInfo: { industry: 'AI' }
                })
            });
            
            const stage1Data = await stage1Response.json();
            log(`Stage 1 Status: ${stage1Response.ok ? 'SUCCESS' : 'FAILED'}`, stage1Response.ok ? 'success' : 'error');
            log(`Intelligence signals: ${stage1Data.intelligence?.raw_signals?.length || 0}`);
            
            // Test Stage 2: Competitors with intelligence data
            log('\n‚öîÔ∏è Stage 2: Competitors', 'stage');
            const stage2Response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-stage-1-competitors`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    organization: { name: 'OpenAI', industry: 'AI' },
                    competitors: ['Anthropic', 'Google AI', 'Microsoft AI'],
                    intelligence: stage1Data.intelligence || {},
                    previousResults: { extraction: stage1Data }
                })
            });
            
            const stage2Data = await stage2Response.json();
            log(`Stage 2 Status: ${stage2Response.ok ? 'SUCCESS' : 'FAILED'}`, stage2Response.ok ? 'success' : 'error');
            log(`Has tabs: ${!!stage2Data.tabs}`);
            log(`Competitor actions in tabs: ${stage2Data.tabs?.competitive?.competitor_actions?.length || 0}`);
            
            // Show tabs structure
            if (stage2Data.tabs) {
                log('\nTabs structure:', 'data');
                log('<pre>' + JSON.stringify(stage2Data.tabs, null, 2) + '</pre>');
            }
            
            // Test Stage 4: Trends
            log('\nüìà Stage 4: Trends', 'stage');
            const stage4Response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-stage-4-trends`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    organization: { name: 'OpenAI', industry: 'AI' },
                    intelligence: stage1Data.intelligence || {},
                    previousResults: {
                        extraction: stage1Data,
                        competitive: stage2Data
                    }
                })
            });
            
            if (stage4Response.ok) {
                const stage4Data = await stage4Response.json();
                log(`Stage 4 Status: SUCCESS`, 'success');
                log(`Has tabs: ${!!stage4Data.tabs}`);
                log(`Market trends: ${stage4Data.tabs?.market?.market_trends?.length || 0}`);
            } else {
                log(`Stage 4 Status: FAILED - ${stage4Response.status}`, 'error');
                const errorText = await stage4Response.text();
                log(`Error: ${errorText}`, 'error');
            }
            
            log('\n‚úÖ Test complete!', 'success');
        }
    </script>
</body>
</html>