<!DOCTYPE html>
<html>
<head>
    <title>Complete Intelligence Flow Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { margin: 10px; padding: 10px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4f4dd; }
        .error { background: #fdd4d4; }
        .pending { background: #fff4d4; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Complete Intelligence Flow Test</h1>
    
    <div class="section">
        <h2>Test Configuration</h2>
        <p>Organization: <input id="org" value="Apple" /></p>
        <p>Industry: <input id="industry" value="technology" /></p>
        <button onclick="testAll()">Run Complete Test</button>
    </div>

    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
        }
        
        async function testFunction(name, endpoint, body) {
            log(`Testing ${name}...`, 'pending');
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ ${name} SUCCESS: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                    return data;
                } else {
                    log(`‚ùå ${name} FAILED: ${data.error || 'Unknown error'}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`‚ùå ${name} ERROR: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testAll() {
            const org = document.getElementById('org').value;
            const industry = document.getElementById('industry').value;
            
            log('Starting Complete Intelligence Flow Test', 'info');
            
            // 1. Test Discovery
            const discovery = await testFunction(
                'Intelligent Discovery',
                'intelligent-discovery',
                { organization: org, industry_hint: industry }
            );
            
            if (!discovery) {
                log('‚ùå Cannot continue without discovery', 'error');
                return;
            }
            
            // 2. Test Gathering
            log('Starting Intelligence Gathering (this may take 30-45 seconds)...', 'pending');
            const gathering = await testFunction(
                'Intelligence Gathering',
                'intelligence-gathering',
                {
                    organization: { name: org, industry: industry },
                    discovered_context: discovery.data
                }
            );
            
            if (!gathering) {
                log('‚ùå Gathering failed', 'error');
                return;
            }
            
            // 3. Test Synthesis
            log('Starting Intelligence Synthesis (this may take 30-45 seconds with new 60s timeout)...', 'pending');
            const synthesis = await testFunction(
                'Intelligence Synthesis',
                'intelligence-synthesis',
                {
                    gathering_data: gathering,
                    organization: { 
                        name: org, 
                        industry: discovery.data.primary_category || industry,
                        competitors: discovery.data.competitors || []
                    }
                }
            );
            
            if (!synthesis) {
                log('‚ùå Synthesis failed', 'error');
                return;
            }
            
            // 4. Analyze Results
            log('üéâ COMPLETE FLOW SUCCESS!', 'success');
            
            const stats = {
                'Discovery': {
                    'Competitors Found': discovery.data.competitors?.length || 0,
                    'Keywords': discovery.data.search_keywords?.length || 0,
                    'Scrape Targets': discovery.data.scrape_targets?.length || 0
                },
                'Gathering': {
                    'Sources': gathering.sources_attempted || 0,
                    'Successful': gathering.sources_successful || 0,
                    'Articles': gathering.statistics?.total_articles || 0
                },
                'Synthesis': {
                    'Complete': synthesis.synthesis_complete || false,
                    'Insights': synthesis.statistics?.total_insights || 0,
                    'Personas': synthesis.statistics?.personas_engaged || 0,
                    'Second Opinions': synthesis.statistics?.second_opinions || 0
                }
            };
            
            log(`<h3>Statistics:</h3><pre>${JSON.stringify(stats, null, 2)}</pre>`, 'success');
            
            // Check if we got actual intelligence
            if (synthesis.intelligence) {
                const hasContent = {
                    'Executive Summary': !!synthesis.intelligence.executive_summary,
                    'Key Insights': synthesis.intelligence.key_insights?.length > 0,
                    'Competitors': synthesis.intelligence.competitors?.length > 0,
                    'Has Synthesized Data': !!synthesis.intelligence.synthesized
                };
                
                log(`<h3>Intelligence Content Check:</h3><pre>${JSON.stringify(hasContent, null, 2)}</pre>`, 'success');
                
                // Show a sample of the actual intelligence
                if (synthesis.intelligence.synthesized?.overview) {
                    log(`<h3>Overview Tab Content:</h3><pre>${JSON.stringify(synthesis.intelligence.synthesized.overview, null, 2)}</pre>`, 'success');
                }
                
                if (synthesis.intelligence.synthesized?.competition) {
                    log(`<h3>Competition Tab Content:</h3><pre>${JSON.stringify(synthesis.intelligence.synthesized.competition, null, 2)}</pre>`, 'success');
                }
            }
        }
    </script>
</body>
</html>
