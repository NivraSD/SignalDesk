<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Complete SignalDesk Flow</title>
    <style>
        body {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .test-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .test-result {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #c6f6d5;
            border: 1px solid #48bb78;
            color: #22543d;
        }
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .pending {
            background: #fef5e7;
            border: 1px solid #f6e05e;
            color: #744210;
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SignalDesk Complete Flow Test</h1>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="firecrawl-count">0</div>
                <div class="stat-label">Firecrawl Actions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rss-count">0</div>
                <div class="stat-label">RSS Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="claude-status">‚è≥</div>
                <div class="stat-label">Claude Analysis</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="opportunity-status">‚è≥</div>
                <div class="stat-label">Opportunities</div>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="runCompleteTest()">üîÑ Run Complete Test</button>
            <button onclick="testAPIKey()">üîë Test API Key Access</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        const organization = {
            id: 'test-org-123',
            name: 'Zara',
            description: 'Fast fashion retailer competing with H&M, Forever 21, and Uniqlo'
        };

        const entities = [
            { name: 'Zara', type: 'brand', priority: 'high' },
            { name: 'H&M', type: 'competitor', priority: 'high' },
            { name: 'Inditex', type: 'company', priority: 'high' },
            { name: 'Fast Fashion', type: 'industry', priority: 'medium' },
            { name: 'Sustainable Fashion', type: 'trend', priority: 'medium' }
        ];

        function addTestResult(title, content, status = 'pending') {
            const container = document.getElementById('test-results');
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `
                <div class="test-title">${title}</div>
                <div class="test-result ${status}" id="${title.replace(/\s+/g, '-').toLowerCase()}">
                    ${content}
                </div>
            `;
            container.appendChild(section);
        }

        function updateTestResult(id, content, status) {
            const element = document.getElementById(id);
            if (element) {
                element.className = `test-result ${status}`;
                element.textContent = content;
            }
        }

        async function testAPIKey() {
            addTestResult('API Key Test', 'Testing ANTHROPIC_API_KEY access...', 'pending');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/test-api-key`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test: true })
                });
                
                const result = await response.json();
                if (result.hasApiKey) {
                    updateTestResult('api-key-test', 
                        `‚úÖ API Key Accessible!\nKey Length: ${result.keyLength}\nKey Prefix: ${result.keyPrefix}`,
                        'success'
                    );
                } else {
                    updateTestResult('api-key-test', 
                        '‚ùå API Key NOT accessible to Edge Functions',
                        'error'
                    );
                }
            } catch (error) {
                updateTestResult('api-key-test', `Error: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            clearResults();
            
            // Step 1: Intelligence Discovery
            addTestResult('Intelligence Discovery V3', 'Starting discovery phase...', 'pending');
            try {
                const discoveryResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-discovery-v3`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ organization, entities })
                });
                
                const discovery = await discoveryResponse.json();
                updateTestResult('intelligence-discovery-v3', 
                    `‚úÖ Discovery Complete\nEntities: ${discovery.entities?.length || 0}\nTopics: ${discovery.topics?.length || 0}`,
                    'success'
                );
                
                // Step 2: Intelligence Gathering
                addTestResult('Intelligence Gathering V3', 'Gathering intelligence from all sources...', 'pending');
                const gatheringResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-gathering-v3`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        entities: discovery.entities || entities,
                        topics: discovery.topics || [],
                        organization
                    })
                });
                
                const gathering = await gatheringResponse.json();
                
                // Update stats
                const firecrawlCount = gathering.entity_actions?.all?.filter(a => a.source?.includes('firecrawl')).length || 0;
                const rssCount = gathering.entity_actions?.all?.filter(a => a.source?.includes('rss')).length || 0;
                
                document.getElementById('firecrawl-count').textContent = firecrawlCount;
                document.getElementById('rss-count').textContent = rssCount;
                
                updateTestResult('intelligence-gathering-v3', 
                    `‚úÖ Gathering Complete\nTotal Actions: ${gathering.entity_actions?.total_count || 0}\nFirecrawl: ${firecrawlCount}\nRSS: ${rssCount}\nTopics: ${gathering.topic_trends?.total_monitored || 0}`,
                    'success'
                );
                
                // Step 3: Intelligence Synthesis with Claude
                addTestResult('Intelligence Synthesis V3', 'Synthesizing with Claude AI...', 'pending');
                const synthesisResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-synthesis-v3`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        intelligence: gathering,
                        organization
                    })
                });
                
                const synthesis = await synthesisResponse.json();
                
                if (synthesis.success && synthesis.tabs?.executive?.headline) {
                    document.getElementById('claude-status').textContent = '‚úÖ';
                    
                    // Check if this is a real analysis (not a fallback)
                    const isRealAnalysis = synthesis.tabs.executive.headline.length > 50 &&
                                         synthesis.tabs.executive.overview?.length > 100;
                    
                    updateTestResult('intelligence-synthesis-v3', 
                        `‚úÖ Claude Analysis Complete!\n\nHeadline: ${synthesis.tabs.executive.headline}\n\nOverview: ${synthesis.tabs.executive.overview || 'N/A'}\n\nAnalysis Type: ${isRealAnalysis ? 'üéØ REAL CLAUDE ANALYSIS' : '‚ö†Ô∏è POSSIBLE FALLBACK'}`,
                        isRealAnalysis ? 'success' : 'pending'
                    );
                } else {
                    document.getElementById('claude-status').textContent = '‚ùå';
                    updateTestResult('intelligence-synthesis-v3', 
                        `‚ùå Synthesis Failed or Using Fallback\nError: ${synthesis.error || 'No Claude analysis generated'}`,
                        'error'
                    );
                }
                
                // Step 4: Opportunity Detection
                addTestResult('Opportunity Orchestrator', 'Detecting opportunities with 5 personas...', 'pending');
                const opportunityResponse = await fetch(`${SUPABASE_URL}/functions/v1/opportunity-orchestrator`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        intelligence: gathering,
                        synthesis: synthesis.tabs || {},
                        organization
                    })
                });
                
                const opportunities = await opportunityResponse.json();
                
                if (opportunities.opportunities?.length > 0) {
                    document.getElementById('opportunity-status').textContent = '‚úÖ';
                    
                    // Check if these are real opportunities (not fallbacks)
                    const fallbackTitles = ['Quick Win', 'Market Gap', 'Strategic Move'];
                    const hasRealOpportunities = opportunities.opportunities.some(opp => 
                        !fallbackTitles.some(fallback => opp.title?.includes(fallback))
                    );
                    
                    const oppList = opportunities.opportunities.slice(0, 3).map(opp => 
                        `‚Ä¢ ${opp.title} (${opp.confidence}% confidence)\n  ${opp.description}`
                    ).join('\n\n');
                    
                    updateTestResult('opportunity-orchestrator', 
                        `‚úÖ Opportunities Detected!\n\n${oppList}\n\nType: ${hasRealOpportunities ? 'üéØ REAL MARKET OPPORTUNITIES' : '‚ö†Ô∏è USING FALLBACK OPPORTUNITIES'}`,
                        hasRealOpportunities ? 'success' : 'pending'
                    );
                } else {
                    document.getElementById('opportunity-status').textContent = '‚ùå';
                    updateTestResult('opportunity-orchestrator', 
                        '‚ùå No opportunities detected',
                        'error'
                    );
                }
                
                // Final summary
                addTestResult('System Status', 
                    `‚úÖ COMPLETE FLOW TEST FINISHED\n\nData Sources:\n‚Ä¢ Firecrawl: ${firecrawlCount} actions\n‚Ä¢ RSS: ${rssCount} articles\n‚Ä¢ Claude Analysis: ${synthesis.success ? 'Working' : 'Failed'}\n‚Ä¢ Opportunities: ${opportunities.opportunities?.length || 0} detected\n\n${
                        (firecrawlCount > 0 && rssCount > 0 && synthesis.success && opportunities.opportunities?.length > 0) 
                        ? 'üéâ SYSTEM FULLY OPERATIONAL - NO FALLBACKS!' 
                        : '‚ö†Ô∏è Some components may be using fallbacks'
                    }`,
                    'success'
                );
                
            } catch (error) {
                console.error('Test error:', error);
                addTestResult('Error', error.message, 'error');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('firecrawl-count').textContent = '0';
            document.getElementById('rss-count').textContent = '0';
            document.getElementById('claude-status').textContent = '‚è≥';
            document.getElementById('opportunity-status').textContent = '‚è≥';
        }
    </script>
</body>
</html>
