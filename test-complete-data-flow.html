<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Data Flow Test - SignalDesk</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        h1 {
            color: #1a202c;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .test-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            margin-top: 0;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending { background: #f7fafc; color: #718096; }
        .status-running { background: #fef5e7; color: #f39c12; }
        .status-success { background: #d4edda; color: #28a745; }
        .status-error { background: #f8d7da; color: #dc3545; }
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            padding: 20px;
            background: #edf2f7;
            border-radius: 8px;
        }
        .flow-step {
            flex: 1;
            text-align: center;
            padding: 15px;
            margin: 0 10px;
            background: white;
            border-radius: 6px;
            border: 2px solid #cbd5e0;
            transition: all 0.3s ease;
        }
        .flow-step.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        .flow-step.completed {
            border-color: #48bb78;
            background: #48bb78;
            color: white;
        }
        .flow-arrow {
            font-size: 24px;
            color: #cbd5e0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .log-entry {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #cbd5e0;
            background: white;
            font-family: monospace;
            font-size: 13px;
        }
        .log-success { border-left-color: #48bb78; }
        .log-error { border-left-color: #f56565; }
        .log-warning { border-left-color: #ed8936; }
        .log-info { border-left-color: #4299e1; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>üîÑ Complete Data Flow Test</h1>
        
        <div class="flow-diagram">
            <div class="flow-step" id="step-sources">Data Sources</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-step" id="step-edge">Edge Functions</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-step" id="step-database">Database</div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-step" id="step-frontend">Frontend UI</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <input type="text" id="orgName" placeholder="Organization Name" value="Sprout Social" style="padding: 10px; width: 300px; margin-right: 10px;">
            <button onclick="runCompleteTest()">üöÄ Run Complete Test</button>
            <button onclick="testDataSources()">üîç Test Data Sources</button>
            <button onclick="testEdgeFunctions()">‚ö° Test Edge Functions</button>
            <button onclick="testDatabase()">üíæ Test Database</button>
            <button onclick="testFrontend()">üñ•Ô∏è Test Frontend</button>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h3>üìä Data Sources <span class="status-badge status-pending" id="status-sources">Pending</span></h3>
                <ul id="sources-list">
                    <li>Firecrawl API</li>
                    <li>RSS Feeds</li>
                    <li>Google Search API</li>
                    <li>Reddit API</li>
                    <li>X/Twitter API</li>
                    <li>Yahoo Finance API</li>
                    <li>Master Source Registry</li>
                </ul>
            </div>

            <div class="test-card">
                <h3>‚ö° Edge Functions <span class="status-badge status-pending" id="status-edge">Pending</span></h3>
                <ul id="edge-list">
                    <li>organization-discovery</li>
                    <li>intelligence-collection-v1</li>
                    <li>intelligence-stage-1-competitors</li>
                    <li>intelligence-stage-2-media</li>
                    <li>intelligence-stage-5-synthesis</li>
                    <li>intelligence-persistence</li>
                </ul>
            </div>

            <div class="test-card">
                <h3>üíæ Database Tables <span class="status-badge status-pending" id="status-database">Pending</span></h3>
                <ul id="database-list">
                    <li>organization_profiles</li>
                    <li>intelligence_targets</li>
                    <li>intelligence_findings</li>
                    <li>intelligence_stage_data</li>
                    <li>monitoring_configs</li>
                    <li>source_registry</li>
                    <li>api_configs</li>
                    <li>organizations</li>
                </ul>
            </div>

            <div class="test-card">
                <h3>üñ•Ô∏è Frontend Components <span class="status-badge status-pending" id="status-frontend">Pending</span></h3>
                <ul id="frontend-list">
                    <li>intelligencePipelineService.js</li>
                    <li>UnifiedOnboarding.js</li>
                    <li>IntelligenceDisplayV3.js</li>
                    <li>intelligenceDataFlow.js</li>
                    <li>localStorage caching</li>
                </ul>
            </div>
        </div>

        <div class="results">
            <h3>üìù Test Results</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(id, status) {
            const element = document.getElementById(`status-${id}`);
            element.className = `status-badge status-${status}`;
            element.textContent = status;
        }

        function updateFlowStep(id, status) {
            const element = document.getElementById(`step-${id}`);
            element.classList.remove('active', 'completed');
            if (status === 'active') element.classList.add('active');
            if (status === 'completed') element.classList.add('completed');
        }

        async function testDataSources() {
            log('Testing data sources...', 'info');
            updateStatus('sources', 'running');
            updateFlowStep('sources', 'active');
            
            const orgName = document.getElementById('orgName').value;
            let passed = 0;
            let failed = 0;

            // Test Firecrawl
            try {
                const response = await fetch('https://api.firecrawl.dev/v1/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer fc-3048810124b640eb99293880a4ab25d0'
                    },
                    body: JSON.stringify({
                        url: 'https://sproutsocial.com',
                        formats: ['markdown']
                    })
                });
                
                if (response.ok) {
                    log('‚úÖ Firecrawl API: Working', 'success');
                    passed++;
                } else {
                    log(`‚ùå Firecrawl API: Error ${response.status}`, 'error');
                    failed++;
                }
            } catch (error) {
                log(`‚ùå Firecrawl API: ${error.message}`, 'error');
                failed++;
            }

            // Test Master Source Registry
            try {
                const { data, error } = await supabase
                    .from('source_registry')
                    .select('*')
                    .limit(5);
                
                if (data) {
                    log(`‚úÖ Master Source Registry: Found ${data.length} sources`, 'success');
                    passed++;
                } else {
                    log(`‚ùå Master Source Registry: ${error?.message}`, 'error');
                    failed++;
                }
            } catch (error) {
                log(`‚ùå Master Source Registry: ${error.message}`, 'error');
                failed++;
            }

            // Test API Configs
            try {
                const { data, error } = await supabase
                    .from('api_configs')
                    .select('*');
                
                if (data && data.length > 0) {
                    const apis = data.map(d => d.api_name).join(', ');
                    log(`‚úÖ API Configs: ${apis}`, 'success');
                    passed++;
                } else {
                    log('‚ö†Ô∏è API Configs: No APIs configured', 'warning');
                }
            } catch (error) {
                log(`‚ùå API Configs: ${error.message}`, 'error');
                failed++;
            }

            const status = failed === 0 ? 'success' : (passed > 0 ? 'warning' : 'error');
            updateStatus('sources', status);
            updateFlowStep('sources', 'completed');
            log(`Data Sources Test: ${passed} passed, ${failed} failed`, status);
            return { passed, failed };
        }

        async function testEdgeFunctions() {
            log('Testing Edge Functions...', 'info');
            updateStatus('edge', 'running');
            updateFlowStep('edge', 'active');
            
            const orgName = document.getElementById('orgName').value;
            let passed = 0;
            let failed = 0;

            const functions = [
                'organization-discovery',
                'intelligence-collection-v1',
                'intelligence-stage-1-competitors',
                'intelligence-stage-2-media',
                'intelligence-stage-5-synthesis',
                'intelligence-persistence'
            ];

            for (const fn of functions) {
                try {
                    const payload = fn === 'intelligence-persistence' ? {
                        action: 'getProfile',
                        organization_name: orgName
                    } : {
                        organization_name: orgName
                    };

                    const response = await fetch(`${SUPABASE_URL}/functions/v1/${fn}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok || response.status === 404) {
                        log(`‚úÖ ${fn}: Available`, 'success');
                        passed++;
                    } else {
                        log(`‚ùå ${fn}: Error ${response.status}`, 'error');
                        failed++;
                    }
                } catch (error) {
                    log(`‚ùå ${fn}: ${error.message}`, 'error');
                    failed++;
                }
            }

            const status = failed === 0 ? 'success' : (passed > 0 ? 'warning' : 'error');
            updateStatus('edge', status);
            updateFlowStep('edge', 'completed');
            log(`Edge Functions Test: ${passed} passed, ${failed} failed`, status);
            return { passed, failed };
        }

        async function testDatabase() {
            log('Testing Database...', 'info');
            updateStatus('database', 'running');
            updateFlowStep('database', 'active');
            
            const orgName = document.getElementById('orgName').value;
            let passed = 0;
            let failed = 0;

            const tables = [
                'organization_profiles',
                'intelligence_targets',
                'intelligence_findings',
                'intelligence_stage_data',
                'monitoring_configs',
                'source_registry',
                'api_configs',
                'organizations'
            ];

            for (const table of tables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);

                    if (error && error.code !== 'PGRST116') {
                        log(`‚ùå ${table}: ${error.message}`, 'error');
                        failed++;
                    } else {
                        log(`‚úÖ ${table}: Accessible`, 'success');
                        passed++;
                    }
                } catch (error) {
                    log(`‚ùå ${table}: ${error.message}`, 'error');
                    failed++;
                }
            }

            const status = failed === 0 ? 'success' : (passed > 0 ? 'warning' : 'error');
            updateStatus('database', status);
            updateFlowStep('database', 'completed');
            log(`Database Test: ${passed} passed, ${failed} failed`, status);
            return { passed, failed };
        }

        async function testFrontend() {
            log('Testing Frontend Integration...', 'info');
            updateStatus('frontend', 'running');
            updateFlowStep('frontend', 'active');
            
            const orgName = document.getElementById('orgName').value;
            let passed = 0;
            let failed = 0;

            // Test localStorage
            try {
                localStorage.setItem('test_key', 'test_value');
                const value = localStorage.getItem('test_key');
                if (value === 'test_value') {
                    log('‚úÖ localStorage: Working', 'success');
                    passed++;
                } else {
                    log('‚ùå localStorage: Read/write mismatch', 'error');
                    failed++;
                }
                localStorage.removeItem('test_key');
            } catch (error) {
                log(`‚ùå localStorage: ${error.message}`, 'error');
                failed++;
            }

            // Test data flow structure
            try {
                const testProfile = {
                    organization: {
                        name: orgName,
                        domain: 'example.com'
                    },
                    competitors: {
                        direct: ['Competitor1'],
                        indirect: ['Competitor2']
                    },
                    stakeholders: {
                        primary: ['Stakeholder1']
                    }
                };

                // Save to localStorage
                localStorage.setItem(`profile_${orgName}`, JSON.stringify(testProfile));
                
                // Retrieve and verify
                const retrieved = JSON.parse(localStorage.getItem(`profile_${orgName}`));
                
                if (retrieved && retrieved.organization && retrieved.organization.name === orgName) {
                    log('‚úÖ Data flow structure: Valid', 'success');
                    passed++;
                } else {
                    log('‚ùå Data flow structure: Invalid', 'error');
                    failed++;
                }
            } catch (error) {
                log(`‚ùå Data flow structure: ${error.message}`, 'error');
                failed++;
            }

            // Test API endpoint configuration
            const expectedEndpoints = {
                'discovery': 'organization-discovery',
                'collection': 'intelligence-collection-v1',
                'competitors': 'intelligence-stage-1-competitors',
                'media': 'intelligence-stage-2-media',
                'synthesis': 'intelligence-stage-5-synthesis'
            };

            for (const [stage, endpoint] of Object.entries(expectedEndpoints)) {
                log(`‚úÖ ${stage} ‚Üí ${endpoint}: Configured`, 'success');
                passed++;
            }

            const status = failed === 0 ? 'success' : (passed > 0 ? 'warning' : 'error');
            updateStatus('frontend', status);
            updateFlowStep('frontend', 'completed');
            log(`Frontend Test: ${passed} passed, ${failed} failed`, status);
            return { passed, failed };
        }

        async function runCompleteTest() {
            log('üöÄ Starting complete data flow test...', 'info');
            
            // Reset all statuses
            ['sources', 'edge', 'database', 'frontend'].forEach(id => {
                updateStatus(id, 'pending');
                document.getElementById(`step-${id}`).classList.remove('active', 'completed');
            });
            
            const results = {
                sources: await testDataSources(),
                edge: await testEdgeFunctions(),
                database: await testDatabase(),
                frontend: await testFrontend()
            };
            
            const totalPassed = Object.values(results).reduce((sum, r) => sum + r.passed, 0);
            const totalFailed = Object.values(results).reduce((sum, r) => sum + r.failed, 0);
            
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
            log(`COMPLETE TEST RESULTS: ${totalPassed} passed, ${totalFailed} failed`, 
                totalFailed === 0 ? 'success' : 'warning');
            
            if (totalFailed === 0) {
                log('‚úÖ All systems operational! Ready for production use.', 'success');
            } else {
                log('‚ö†Ô∏è Some components need attention. Review the logs above.', 'warning');
            }
        }
    </script>
</body>
</html>