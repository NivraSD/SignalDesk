<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toyota Intelligence Test - Automotive Competitors</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .data-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .competitor-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .competitor-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .competitor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .competitor-card.automotive {
            border-left: 4px solid #28a745;
        }
        .competitor-card.tech {
            border-left: 4px solid #dc3545;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .console-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-entry.error {
            color: #f48771;
            border-left-color: #f48771;
        }
        .log-entry.success {
            color: #89d185;
            border-left-color: #89d185;
        }
        .log-entry.info {
            color: #61afef;
            border-left-color: #61afef;
        }
        .log-entry.warning {
            color: #e5c07b;
            border-left-color: #e5c07b;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Toyota Intelligence Test - Automotive Competitors</h1>
        
        <div class="status info">
            Testing if Toyota now correctly receives automotive competitors instead of tech companies
        </div>

        <button class="btn" onclick="testToyotaIntelligence()">Run Intelligence Test for Toyota</button>

        <div id="results"></div>
        
        <div class="console-log" id="console"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';

        function addLog(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function testToyotaIntelligence() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">üîÑ Testing Toyota intelligence gathering...</div>';
            
            addLog('Starting Toyota intelligence test', 'info');

            // Toyota organization config
            const toyotaConfig = {
                organization: {
                    name: 'Toyota',
                    industry: 'automotive',
                    website: 'https://www.toyota.com',
                    competitors: [], // Let the system determine competitors
                    stakeholders: ['customers', 'regulators', 'suppliers'],
                    topics: ['electric vehicles', 'autonomous driving', 'sustainability']
                },
                goals: {
                    competitive_positioning: true,
                    media_coverage: true,
                    thought_leadership: true
                },
                intelligence: {
                    stakeholders: ['customers', 'regulators', 'media', 'investors'],
                    topics: ['EV strategy', 'hybrid technology', 'manufacturing innovation'],
                    keywords: ['Toyota', 'electric vehicles', 'automotive']
                }
            };

            addLog(`Organization: ${toyotaConfig.organization.name}`, 'success');
            addLog(`Industry: ${toyotaConfig.organization.industry}`, 'success');
            addLog(`Topics: ${toyotaConfig.organization.topics.join(', ')}`, 'info');

            try {
                // Step 1: Test organization enhancement
                addLog('Step 1: Testing organization enhancement with Claude', 'info');
                
                const enhancementResponse = await fetch(`${SUPABASE_URL}/functions/v1/claude-intelligence-synthesizer-v2`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        intelligence_type: 'enhance_organization',
                        organization: toyotaConfig.organization,
                        goals: toyotaConfig.goals,
                        prompt: `Enhance data for Toyota in the automotive industry. Focus on automotive competitors, not tech companies.`
                    })
                });

                if (enhancementResponse.ok) {
                    const enhanced = await enhancementResponse.json();
                    addLog('‚úÖ Organization enhanced successfully', 'success');
                    
                    if (enhanced.competitors && enhanced.competitors.length > 0) {
                        addLog(`Enhanced competitors: ${enhanced.competitors.join(', ')}`, 'success');
                        
                        // Check if we got automotive competitors
                        const automotiveCompetitors = ['Tesla', 'Volkswagen', 'General Motors', 'Ford', 'BMW', 'Mercedes-Benz', 'Honda', 'Nissan'];
                        const techCompetitors = ['Google', 'Microsoft', 'Apple', 'Amazon', 'Meta'];
                        
                        const hasAutomotive = enhanced.competitors.some(c => 
                            automotiveCompetitors.some(auto => c.toLowerCase().includes(auto.toLowerCase()))
                        );
                        const hasTech = enhanced.competitors.some(c => 
                            techCompetitors.some(tech => c.toLowerCase().includes(tech.toLowerCase()))
                        );
                        
                        if (hasAutomotive && !hasTech) {
                            addLog('‚úÖ CORRECT: Automotive competitors detected, no tech companies', 'success');
                        } else if (hasTech) {
                            addLog('‚ùå ERROR: Still getting tech companies as competitors', 'error');
                        }
                    }
                    
                    // Display enhanced data
                    resultsDiv.innerHTML += `
                        <div class="data-section">
                            <h3>Enhanced Organization Data</h3>
                            <p><strong>Competitors:</strong> ${enhanced.competitors?.join(', ') || 'None'}</p>
                            <p><strong>Stakeholders:</strong> ${enhanced.stakeholders?.join(', ') || 'None'}</p>
                            <p><strong>Topics:</strong> ${enhanced.topics?.join(', ') || 'None'}</p>
                            <p><strong>Keywords:</strong> ${enhanced.keywords?.join(', ') || 'None'}</p>
                        </div>
                    `;
                } else {
                    addLog(`Enhancement failed: ${enhancementResponse.status}`, 'error');
                }

                // Step 2: Test PR Intelligence
                addLog('Step 2: Testing PR Intelligence for competitors', 'info');
                
                const prResponse = await fetch(`${SUPABASE_URL}/functions/v1/pr-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        method: 'gather',
                        params: {
                            organization: toyotaConfig.organization,
                            timeframe: '24h',
                            focus: 'competitive_intelligence'
                        }
                    })
                });

                if (prResponse.ok) {
                    const prData = await prResponse.json();
                    addLog('‚úÖ PR Intelligence received', 'success');
                    
                    if (prData.competitors) {
                        const competitorNames = Object.keys(prData.competitors);
                        addLog(`PR tracking competitors: ${competitorNames.join(', ')}`, 'info');
                        
                        // Display competitor cards
                        const competitorHtml = competitorNames.map(name => {
                            const isAutomotive = ['Tesla', 'Volkswagen', 'Ford', 'GM', 'BMW', 'Mercedes', 'Honda', 'Nissan']
                                .some(auto => name.toLowerCase().includes(auto.toLowerCase()));
                            const cardClass = isAutomotive ? 'automotive' : 'tech';
                            const emoji = isAutomotive ? 'üöó' : 'üíª';
                            
                            return `
                                <div class="competitor-card ${cardClass}">
                                    <h4>${emoji} ${name}</h4>
                                    <small>${isAutomotive ? 'Automotive' : 'Tech'}</small>
                                </div>
                            `;
                        }).join('');
                        
                        resultsDiv.innerHTML += `
                            <div class="data-section">
                                <h3>Competitors Being Tracked</h3>
                                <div class="competitor-list">
                                    ${competitorHtml || '<p>No competitors found</p>'}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    addLog(`PR Intelligence failed: ${prResponse.status}`, 'error');
                }

                // Step 3: Test full synthesis
                addLog('Step 3: Testing full Claude synthesis', 'info');
                
                const synthesisResponse = await fetch(`${SUPABASE_URL}/functions/v1/claude-intelligence-synthesizer-v2`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        intelligence_type: 'competitor',
                        mcp_data: { competitive: { 'Tesla': {}, 'Volkswagen': {}, 'Ford': {} } },
                        organization: toyotaConfig.organization,
                        goals: toyotaConfig.goals,
                        timeframe: '24h'
                    })
                });

                if (synthesisResponse.ok) {
                    const synthesis = await synthesisResponse.json();
                    addLog('‚úÖ Claude synthesis completed', 'success');
                    
                    resultsDiv.innerHTML += `
                        <div class="data-section">
                            <h3>Claude Analysis</h3>
                            <pre>${JSON.stringify(synthesis.analysis, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    addLog(`Synthesis failed: ${synthesisResponse.status}`, 'error');
                }

                // Final verdict
                resultsDiv.innerHTML += `
                    <div class="status success">
                        ‚úÖ Test complete! Check the console log above for details.
                    </div>
                `;
                
            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Test failed: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>