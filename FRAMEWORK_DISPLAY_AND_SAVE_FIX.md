# Framework Display and Memory Vault Save Fix

## Critical Issues Identified

### Issue 1: Framework Display Shows "To be developed" or Incomplete Data
**Symptom:** Chat display shows incomplete framework even though data is generated correctly.

**Root Cause:** Display formatter (`formatStrategicResponse`) expects framework structure like:
```typescript
{
  strategy: {
    objective: "...",
    narrative: "...",
    proof_points: [...],
    keyMessages: [...],
    target_audiences: [...]
  },
  media_targets: { tier_1_targets: [...], tier_2_targets: [...] },
  executionPlan: { timeline: {...}, autoExecutableContent: {...} },
  contentStrategy: { kpis: [...] }
}
```

But framework saved to database had structure:
```typescript
{
  proof_points: [...],
  content_needs: {...},
  executionPlan: {...},  // Wrong format
  full_strategy: {...},
  media_targets: {...},
  contentStrategy: {...},
  timeline_execution: {...}
}
```

**Missing:** The critical `strategy` object containing `narrative`, `keyMessages`, `objective`, `target_audiences` was NOT in the saved framework.

### Issue 2: Memory Vault Not Saving Complete Framework Structure
**Symptom:** Database query shows `framework_data` missing the `strategy` key entirely.

**Root Cause:** In `/supabase/functions/niv-orchestrator-robust/index.ts` lines 3408-3461, the Memory Vault payload was constructed with:
- Individual flattened fields: `strategy_objective`, `strategy_approach`, `strategy_key_messages`, etc.
- Only `content_strategy` and `execution_plan` passed for auto-execution
- **NO `framework_data` field with complete framework structure**

The Memory Vault function at `/supabase/functions/niv-memory-vault/index.ts` lines 248-253 only saves:
```typescript
framework_data: {
  ...(strategy.framework_data || {}),
  contentStrategy: strategy.content_strategy || null,
  executionPlan: strategy.execution_plan || null
}
```

Since `strategy.framework_data` was NOT passed by orchestrator, the database received an empty object with only `contentStrategy` and `executionPlan`, losing the critical `strategy`, `media_targets`, and other fields.

## The Fix

### File: `/supabase/functions/niv-orchestrator-robust/index.ts`
**Line 3436:** Added `framework_data: structuredFramework` to Memory Vault payload

```typescript
// BEFORE (lines 3431-3433):
// NEW: Content-ready format for auto-execution
content_strategy: structuredFramework.contentStrategy || null,
execution_plan: structuredFramework.executionPlan || null,

// Metadata

// AFTER (lines 3431-3438):
// NEW: Content-ready format for auto-execution
content_strategy: structuredFramework.contentStrategy || null,
execution_plan: structuredFramework.executionPlan || null,

// CRITICAL: Save complete framework structure to framework_data
framework_data: structuredFramework,

// Metadata
```

## Why This Fixes Both Issues

### Display Issue Fixed
When `framework_data: structuredFramework` is saved to the database, the complete framework structure including:
- `strategy` object with `narrative`, `keyMessages`, `objective`, `proof_points`, `target_audiences`
- `media_targets` with `tier_1_targets`, `tier_2_targets`, `tier_3_targets`
- `executionPlan` with `timeline` and `autoExecutableContent`
- `contentStrategy` with `kpis`

Now when Memory Vault loads the strategy and the display formatter runs, it has access to `plan.strategy.narrative`, `plan.strategy.proof_points`, etc.

### Memory Vault Save Fixed
The `framework_data` column in `niv_strategies` table now contains the COMPLETE framework structure as generated by `niv-strategic-framework` edge function, not just the contentStrategy and executionPlan fragments.

This means:
1. ✅ Framework displays correctly in chat with all sections
2. ✅ Framework saves to Memory Vault with complete data
3. ✅ Memory Vault UI can read and display full framework
4. ✅ Framework can be reloaded and executed later with full context

## What Was Happening Before

1. **Strategic framework generated correctly** - `niv-strategic-framework` created complete structure
2. **Debug logs showed correct data** - Line 3367-3387 proved `structuredFramework` had all fields
3. **Display formatter ran on correct data** - `formatStrategicResponse` received complete framework
4. **Chat displayed correctly** - User saw full framework in conversation
5. **BUT Memory Vault payload was incomplete** - Only sent individual fields, not complete `framework_data`
6. **Database saved incomplete structure** - `framework_data` column had wrong schema
7. **Memory Vault UI couldn't display** - Hook loaded data with missing `strategy` object
8. **Reloading framework failed** - Later operations expecting `strategy.narrative` found nothing

## What Happens Now

1. **Strategic framework generates correctly** ✅ (unchanged)
2. **Display formatter receives correct data** ✅ (unchanged)
3. **Chat displays correctly** ✅ (unchanged)
4. **Memory Vault payload includes framework_data** ✅ (FIXED)
5. **Database saves complete structure** ✅ (FIXED)
6. **Memory Vault UI displays correctly** ✅ (FIXED)
7. **Framework can be reloaded** ✅ (FIXED)
8. **Execute button works with full context** ✅ (FIXED)

## Verification Steps

1. Create new strategic framework in NIV chat
2. Verify chat displays complete framework (objective, narrative, proof points, key messages, audiences, media targets, timeline, KPIs)
3. Check Memory Vault - strategy should appear within 5 seconds
4. Click on strategy in Memory Vault - should display complete framework
5. Query database directly:
```javascript
supabase.from('niv_strategies')
  .select('framework_data')
  .order('created_at', { ascending: false })
  .limit(1)
```

Should show:
```javascript
{
  strategy: {
    objective: "...",
    narrative: "...",
    proof_points: [...],
    keyMessages: [...],
    target_audiences: [...]
  },
  media_targets: { tier_1_targets: [...] },
  executionPlan: { ... },
  contentStrategy: { ... }
}
```

## Files Modified

1. `/supabase/functions/niv-orchestrator-robust/index.ts` - Added `framework_data: structuredFramework` to Memory Vault payload (line 3436)

## Deployment

```bash
npx supabase functions deploy niv-orchestrator-robust
# Result: Deploying Function: niv-orchestrator-robust (script size: 143.3kB)
```

## Summary

**One-line fix:** Added `framework_data: structuredFramework` to the Memory Vault payload so the complete framework structure (including `strategy`, `media_targets`, etc.) is saved to the database, not just the flattened individual fields.

**Impact:** This single change fixes both the display issue (data is now in database correctly) and the Memory Vault save issue (complete structure is persisted).

**Testing:** Create a new strategic framework and verify it displays correctly in chat AND appears in Memory Vault with complete data structure.
