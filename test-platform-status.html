<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SignalDesk Platform Status</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    .success { background: #d4edda; }
    .error { background: #f8d7da; }
    .pending { background: #fff3cd; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>SignalDesk Platform Status Check</h1>
  <div id="tests"></div>

  <script>
    const { createClient } = supabase;
    
    // Production credentials
    const supabaseUrl = 'https://zskaxjtyuaqazydouifp.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';
    
    const client = createClient(supabaseUrl, supabaseAnonKey);
    const testsDiv = document.getElementById('tests');
    
    async function runTest(name, testFn) {
      const testDiv = document.createElement('div');
      testDiv.className = 'test pending';
      testDiv.innerHTML = `<h3>${name}</h3><div class="result">Testing...</div>`;
      testsDiv.appendChild(testDiv);
      
      try {
        const result = await testFn();
        testDiv.className = 'test success';
        testDiv.querySelector('.result').innerHTML = `✅ ${result}`;
        return true;
      } catch (error) {
        testDiv.className = 'test error';
        testDiv.querySelector('.result').innerHTML = `❌ ${error.message}`;
        return false;
      }
    }
    
    async function runAllTests() {
      let passedTests = 0;
      let totalTests = 0;
      
      // Test 1: Supabase Connection
      totalTests++;
      if (await runTest('Supabase Connection', async () => {
        const { data, error } = await client.from('users').select('count').limit(0);
        if (error && !error.message.includes('permission')) throw error;
        return 'Connected to Supabase';
      })) passedTests++;
      
      // Test 2: Authentication
      totalTests++;
      if (await runTest('Authentication (Demo User)', async () => {
        const { data, error } = await client.auth.signInWithPassword({
          email: 'demo@signaldesk.com',
          password: 'password'
        });
        
        if (error) {
          // Try to create demo user
          const { data: signUpData, error: signUpError } = await client.auth.signUp({
            email: 'demo@signaldesk.com',
            password: 'password'
          });
          
          if (signUpError) throw signUpError;
          
          // Try login again
          const { data: retryData, error: retryError } = await client.auth.signInWithPassword({
            email: 'demo@signaldesk.com',
            password: 'password'
          });
          
          if (retryError) throw retryError;
          return 'Demo user created and logged in';
        }
        
        return `Logged in as ${data.user.email}`;
      })) passedTests++;
      
      // Test 3: API Key Test Function
      totalTests++;
      if (await runTest('Edge Function: test-api-key', async () => {
        const { data, error } = await client.functions.invoke('test-api-key');
        if (error) throw error;
        
        if (!data.api_key_exists) {
          throw new Error('API key not found in environment');
        }
        
        if (data.claude_test.includes('SUCCESS')) {
          return `API key valid - ${data.claude_test}`;
        } else {
          throw new Error(`API key test failed: ${data.claude_test}`);
        }
      })) passedTests++;
      
      // Test 4: Health Check Function
      totalTests++;
      if (await runTest('Edge Function: health-check', async () => {
        const { data, error } = await client.functions.invoke('health-check');
        if (error) throw error;
        return `Health check: ${JSON.stringify(data)}`;
      })) passedTests++;
      
      // Test 5: Intelligence Hub Function
      totalTests++;
      if (await runTest('Edge Function: intelligence-hub-realtime', async () => {
        const { data, error } = await client.functions.invoke('intelligence-hub-realtime', {
          body: {
            organization: { name: 'Test Org', industry: 'technology' },
            timeframe: '24h'
          }
        });
        
        if (error) throw error;
        
        if (data && data.success) {
          return 'Intelligence hub working';
        } else if (data && data.error) {
          throw new Error(data.error);
        } else {
          return 'Intelligence hub responded';
        }
      })) passedTests++;
      
      // Test 6: Opportunity Orchestrator
      totalTests++;
      if (await runTest('Edge Function: opportunity-orchestrator', async () => {
        const { data, error } = await client.functions.invoke('opportunity-orchestrator', {
          body: {
            organization: { name: 'Test Org', industry: 'technology' }
          }
        });
        
        if (error) throw error;
        return 'Opportunity orchestrator working';
      })) passedTests++;
      
      // Test 7: Frontend Deployment
      totalTests++;
      if (await runTest('Frontend Deployment', async () => {
        const response = await fetch('https://signaldesk.vercel.app/', { method: 'HEAD' });
        if (!response.ok) throw new Error(`Status ${response.status}`);
        return 'Frontend is live on Vercel';
      })) passedTests++;
      
      // Summary
      const summaryDiv = document.createElement('div');
      summaryDiv.className = passedTests === totalTests ? 'test success' : 'test error';
      summaryDiv.innerHTML = `
        <h2>Summary</h2>
        <p>${passedTests} of ${totalTests} tests passed</p>
        <p>Platform Status: ${passedTests === totalTests ? '✅ OPERATIONAL' : '⚠️ PARTIAL OUTAGE'}</p>
      `;
      testsDiv.appendChild(summaryDiv);
    }
    
    // Run all tests
    runAllTests();
  </script>
</body>
</html>