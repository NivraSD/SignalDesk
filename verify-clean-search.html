<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Verify Clean Search Flow</title>
    <style>
        body { 
            background: #0a0a0a; 
            color: #00ff88; 
            font-family: 'Courier New', monospace; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #00ffcc; text-shadow: 0 0 10px rgba(0,255,204,0.5); }
        button {
            background: linear-gradient(135deg, #00ff88, #00ffcc);
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: rgba(0,255,136,0.05);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
        }
        .success { color: #00ff88; font-weight: bold; }
        .error { color: #ff0088; font-weight: bold; }
        .warning { color: #ffcc00; }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
            max-height: 200px;
            font-size: 11px;
        }
        .status-item {
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #00ff88;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <h1>🔄 Clean Search Verification</h1>
    
    <div style="text-align: center; margin: 20px 0;">
        <button onclick="runSearch1()">Run Search 1: Microsoft</button>
        <button onclick="simulateNewSearch()">Simulate New Search</button>
        <button onclick="runSearch2()">Run Search 2: Apple</button>
        <button onclick="compareResults()">Compare Results</button>
    </div>

    <div class="grid">
        <div class="section">
            <h2>Search 1: Microsoft</h2>
            <div id="search1-results"></div>
        </div>
        
        <div class="section">
            <h2>Search 2: Apple</h2>
            <div id="search2-results"></div>
        </div>
    </div>

    <div class="section">
        <h2>Data Comparison</h2>
        <div id="comparison"></div>
    </div>

    <div class="section">
        <h2>Cache Status</h2>
        <div id="cache-status"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        let search1Data = null;
        let search2Data = null;

        async function runSearch1() {
            const results = document.getElementById('search1-results');
            results.innerHTML = '<div class="warning">Running search for Microsoft...</div>';
            
            const testData = {
                organization: { name: 'Microsoft', industry: 'technology' },
                stakeholders: {
                    competitors: ['Google', 'Amazon', 'Apple'],
                    regulators: ['FTC', 'SEC'],
                    media_outlets: ['TechCrunch', 'The Verge'],
                    activists: [],
                    investors: [],
                    analysts: []
                },
                monitoring_topics: ['cloud computing', 'AI']
            };
            
            try {
                // Run full flow
                const discovery = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-discovery-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const discoveryData = await discovery.json();
                
                const gathering = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-gathering-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        entities: discoveryData.entities,
                        organization: testData.organization
                    })
                });
                
                search1Data = await gathering.json();
                
                // Display results
                let html = '<div class="success">✅ Search Complete</div>';
                html += `<div class="status-item">Actions: ${search1Data.entity_actions?.all?.length || 0}</div>`;
                html += `<div class="status-item">Topics: ${search1Data.topic_trends?.all?.length || 0}</div>`;
                
                // Show first few actions
                if (search1Data.entity_actions?.all?.length > 0) {
                    html += '<h4>Sample Actions:</h4>';
                    search1Data.entity_actions.all.slice(0, 3).forEach(action => {
                        html += `<div class="status-item">• ${action.entity}: ${action.action?.substring(0, 50)}...</div>`;
                    });
                }
                
                // Save to cache
                localStorage.setItem('signaldesk_last_synthesis', JSON.stringify(search1Data));
                
                results.innerHTML = html;
                updateCacheStatus();
                
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function simulateNewSearch() {
            // Clear intelligence caches
            localStorage.removeItem('signaldesk_intelligence_cache');
            localStorage.removeItem('signaldesk_last_synthesis');
            localStorage.removeItem('signaldesk_intelligence_hub');
            
            // Clear any other intelligence keys
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if ((key.includes('intelligence') || 
                     key.includes('synthesis') || 
                     key.includes('gathering') ||
                     key.includes('opportunity') ||
                     key.includes('cache')) && 
                    !key.includes('organization') && 
                    !key.includes('profile')) {
                    localStorage.removeItem(key);
                }
            });
            
            document.getElementById('comparison').innerHTML = '<div class="success">✅ Cleared intelligence cache - ready for new search</div>';
            updateCacheStatus();
        }

        async function runSearch2() {
            const results = document.getElementById('search2-results');
            results.innerHTML = '<div class="warning">Running search for Apple...</div>';
            
            const testData = {
                organization: { name: 'Apple', industry: 'technology' },
                stakeholders: {
                    competitors: ['Samsung', 'Microsoft', 'Meta'],
                    regulators: ['EU Commission', 'DOJ'],
                    media_outlets: ['9to5Mac', 'MacRumors'],
                    activists: [],
                    investors: [],
                    analysts: []
                },
                monitoring_topics: ['privacy', 'app store']
            };
            
            try {
                // Run full flow
                const discovery = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-discovery-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const discoveryData = await discovery.json();
                
                const gathering = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-gathering-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        entities: discoveryData.entities,
                        organization: testData.organization
                    })
                });
                
                search2Data = await gathering.json();
                
                // Display results
                let html = '<div class="success">✅ Search Complete</div>';
                html += `<div class="status-item">Actions: ${search2Data.entity_actions?.all?.length || 0}</div>`;
                html += `<div class="status-item">Topics: ${search2Data.topic_trends?.all?.length || 0}</div>`;
                
                // Show first few actions
                if (search2Data.entity_actions?.all?.length > 0) {
                    html += '<h4>Sample Actions:</h4>';
                    search2Data.entity_actions.all.slice(0, 3).forEach(action => {
                        html += `<div class="status-item">• ${action.entity}: ${action.action?.substring(0, 50)}...</div>`;
                    });
                }
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function compareResults() {
            const comparison = document.getElementById('comparison');
            
            if (!search1Data || !search2Data) {
                comparison.innerHTML = '<div class="warning">Run both searches first</div>';
                return;
            }
            
            // Check for data overlap
            const search1Entities = new Set(search1Data.entity_actions?.all?.map(a => a.entity) || []);
            const search2Entities = new Set(search2Data.entity_actions?.all?.map(a => a.entity) || []);
            
            const overlap = [...search1Entities].filter(e => search2Entities.has(e));
            
            let html = '<h3>Comparison Results:</h3>';
            
            if (overlap.length > 0) {
                html += `<div class="error">⚠️ DATA CONTAMINATION DETECTED!</div>`;
                html += `<div>Overlapping entities: ${overlap.join(', ')}</div>`;
            } else {
                html += '<div class="success">✅ Clean separation - no data contamination</div>';
            }
            
            html += `<div class="status-item">Search 1 entities: ${[...search1Entities].join(', ') || 'none'}</div>`;
            html += `<div class="status-item">Search 2 entities: ${[...search2Entities].join(', ') || 'none'}</div>`;
            
            comparison.innerHTML = html;
        }

        function updateCacheStatus() {
            const status = document.getElementById('cache-status');
            const keys = Object.keys(localStorage).filter(k => 
                k.includes('signaldesk') || 
                k.includes('intelligence')
            );
            
            let html = '<h3>Current Cache Keys:</h3>';
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                const size = value ? value.length : 0;
                const isIntel = key.includes('intelligence') || key.includes('synthesis');
                html += `<div class="status-item ${isIntel ? 'warning' : ''}">${key} (${size} bytes)</div>`;
            });
            
            status.innerHTML = html;
        }

        // Initial load
        updateCacheStatus();
    </script>
</body>
</html>