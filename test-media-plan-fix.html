<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Media Plan Fix</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #8b5cf6;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(30, 30, 45, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            opacity: 0.9;
        }
        .output {
            background: #000;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .debug { color: #8b5cf6; }
        .highlight { background: rgba(139, 92, 246, 0.2); padding: 2px 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Test Media Plan Improvements</h1>
        
        <div class="test-section">
            <h2>Expected Improvements</h2>
            <p style="color: #9ca3af;">
                ‚úÖ Uses "Media Plan" terminology (not "Media List")<br>
                ‚úÖ Only creates ONE media plan per request<br>
                ‚úÖ Content appears properly in work items<br>
                ‚úÖ No duplicate work items generated
            </p>
        </div>

        <div class="test-section">
            <h2>Test 1: Verify Terminology Change</h2>
            <button class="test-button" onclick="testTerminology()">
                Test Media Plan Terminology
            </button>
            <div id="terminology-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: No Duplicate Generation</h2>
            <button class="test-button" onclick="testNoDuplicates()">
                Test Single Media Plan Creation
            </button>
            <div id="duplicate-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Content in Work Items</h2>
            <button class="test-button" onclick="testContentInWorkItems()">
                Test Content Appears in Work Items
            </button>
            <div id="content-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Test 4: Full Conversation Flow</h2>
            <button class="test-button" onclick="testFullFlow()">
                Test Complete Flow
            </button>
            <div id="flow-output" class="output"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';

        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        async function callNiv(message, messages = []) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/niv-orchestrator`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    messages: messages,
                    context: {},
                    mode: 'strategic_orchestration'
                })
            });
            return await response.json();
        }

        async function testTerminology() {
            const outputId = 'terminology-output';
            log(outputId, '=== Testing Media Plan Terminology ===', 'info');
            
            try {
                const message = "Create a media plan for our AI product launch";
                log(outputId, `Sending: "${message}"`, 'debug');
                
                const response = await callNiv(message);
                
                // Check response text
                if (response.response?.includes('media plan')) {
                    log(outputId, '‚úÖ Niv uses "media plan" terminology', 'success');
                } else if (response.response?.includes('media list')) {
                    log(outputId, '‚ö†Ô∏è Still using "media list" in response', 'warning');
                }
                
                // Check work items
                if (response.workItems && response.workItems.length > 0) {
                    const mediaItem = response.workItems.find(item => item.type === 'media-list');
                    if (mediaItem) {
                        log(outputId, `\nWork Item Title: <span class="highlight">${mediaItem.title}</span>`, 'info');
                        
                        if (mediaItem.title?.includes('Media Plan')) {
                            log(outputId, '‚úÖ Title uses "Media Plan"', 'success');
                        } else {
                            log(outputId, '‚ùå Title does not use "Media Plan"', 'error');
                        }
                        
                        if (mediaItem.description?.includes('strategy') || mediaItem.description?.includes('strategic')) {
                            log(outputId, '‚úÖ Description emphasizes strategy', 'success');
                        }
                    }
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }

        async function testNoDuplicates() {
            const outputId = 'duplicate-output';
            log(outputId, '=== Testing No Duplicate Generation ===', 'info');
            
            try {
                const messages = [];
                
                // First message
                let userMsg = "I need help with PR for our AI startup launch";
                log(outputId, `\n1Ô∏è‚É£ USER: ${userMsg}`, 'debug');
                let response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                log(outputId, `   Work items: ${response.workItems?.length || 0}`, 'info');
                
                // Second message
                userMsg = "We're launching next month. Can you create a media plan?";
                log(outputId, `\n2Ô∏è‚É£ USER: ${userMsg}`, 'debug');
                response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                log(outputId, `   Work items: ${response.workItems?.length || 0}`, 'info');
                
                if (response.workItems && response.workItems.length > 0) {
                    const mediaPlans = response.workItems.filter(item => item.type === 'media-list');
                    log(outputId, `\nüìä Media Plans Created: ${mediaPlans.length}`, 'info');
                    
                    if (mediaPlans.length === 1) {
                        log(outputId, '‚úÖ SUCCESS: Only ONE media plan created', 'success');
                    } else if (mediaPlans.length > 1) {
                        log(outputId, `‚ùå FAIL: ${mediaPlans.length} media plans created (should be 1)`, 'error');
                        mediaPlans.forEach((plan, i) => {
                            log(outputId, `   ${i+1}. ${plan.title}`, 'error');
                        });
                    }
                }
                
                // Third message - should not create another
                userMsg = "Tell me more about the journalists you'll target";
                log(outputId, `\n3Ô∏è‚É£ USER: ${userMsg}`, 'debug');
                response = await callNiv(userMsg, messages);
                log(outputId, `   Work items: ${response.workItems?.length || 0}`, 'info');
                
                if (response.workItems && response.workItems.length > 0) {
                    log(outputId, '‚ö†Ô∏è WARNING: New work items created on follow-up question', 'warning');
                } else {
                    log(outputId, '‚úÖ No additional work items on follow-up', 'success');
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }

        async function testContentInWorkItems() {
            const outputId = 'content-output';
            log(outputId, '=== Testing Content in Work Items ===', 'info');
            
            try {
                const message = "I'll create a strategic media plan for your AI product launch targeting tier-1 tech journalists";
                log(outputId, `Simulating Niv saying: "${message.substring(0, 60)}..."`, 'debug');
                
                const response = await callNiv(message);
                
                if (response.workItems && response.workItems.length > 0) {
                    const mediaItem = response.workItems.find(item => item.type === 'media-list');
                    if (mediaItem) {
                        log(outputId, '\nüìÑ Media Plan Work Item Found:', 'success');
                        log(outputId, `Title: ${mediaItem.title}`, 'info');
                        log(outputId, `Description: ${mediaItem.description}`, 'info');
                        
                        if (mediaItem.generatedContent) {
                            log(outputId, '\n‚úÖ Has generatedContent', 'success');
                            const content = mediaItem.generatedContent;
                            
                            // Check structure
                            log(outputId, '\nContent Structure:', 'info');
                            log(outputId, `  - title: ${content.title ? '‚úÖ' : '‚ùå'}`, content.title ? 'success' : 'error');
                            log(outputId, `  - journalists: ${content.journalists ? '‚úÖ' : '‚ùå'} (${content.journalists?.length || 0} items)`, content.journalists ? 'success' : 'error');
                            log(outputId, `  - totalContacts: ${content.totalContacts || 'N/A'}`, 'info');
                            
                            if (content.journalists && content.journalists.length > 0) {
                                log(outputId, '\nFirst Journalist Details:', 'debug');
                                const j = content.journalists[0];
                                log(outputId, `  Name: ${j.name}`, 'debug');
                                log(outputId, `  Outlet: ${j.outlet}`, 'debug');
                                log(outputId, `  Beat: ${j.beat}`, 'debug');
                                log(outputId, `  Tier: ${j.tier}`, 'debug');
                            }
                            
                            // Check if content is detailed
                            if (content.journalists && content.journalists.length >= 3) {
                                log(outputId, '\n‚úÖ Content appears detailed and complete', 'success');
                            } else {
                                log(outputId, '\n‚ö†Ô∏è Content seems minimal', 'warning');
                            }
                        } else {
                            log(outputId, '‚ùå No generatedContent in work item', 'error');
                        }
                    }
                } else {
                    log(outputId, '‚ùå No work items generated', 'error');
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            const outputId = 'flow-output';
            log(outputId, '=== Testing Complete Flow ===', 'info');
            
            try {
                const messages = [];
                
                // Step 1: Initial greeting
                log(outputId, '\n--- Step 1: Initial Request ---', 'info');
                let userMsg = "I need help with PR for our AI coding assistant launch";
                log(outputId, `USER: ${userMsg}`, 'debug');
                let response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                
                if (response.workItems?.length > 0) {
                    log(outputId, '‚ö†Ô∏è Work items created on first message (should converse first)', 'warning');
                } else {
                    log(outputId, '‚úÖ No work items yet (conversation first)', 'success');
                }
                
                // Step 2: Provide details
                log(outputId, '\n--- Step 2: Providing Details ---', 'info');
                userMsg = "It's launching next month. We want to reach developers through tier-1 tech media.";
                log(outputId, `USER: ${userMsg}`, 'debug');
                response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                
                // Step 3: Request creation
                log(outputId, '\n--- Step 3: Request Creation ---', 'info');
                userMsg = "Yes, please create a strategic media plan for the launch";
                log(outputId, `USER: ${userMsg}`, 'debug');
                response = await callNiv(userMsg, messages);
                
                if (response.response?.toLowerCase().includes("i'll create") || 
                    response.response?.toLowerCase().includes("let me create")) {
                    log(outputId, '‚úÖ Niv says they\'ll create the media plan', 'success');
                }
                
                if (response.workItems && response.workItems.length > 0) {
                    log(outputId, `\n‚úÖ Created ${response.workItems.length} work item(s)`, 'success');
                    
                    const mediaPlans = response.workItems.filter(item => item.type === 'media-list');
                    if (mediaPlans.length === 1) {
                        log(outputId, '‚úÖ Exactly ONE media plan created', 'success');
                        
                        const plan = mediaPlans[0];
                        log(outputId, `\nMedia Plan: "${plan.title}"`, 'info');
                        
                        if (plan.generatedContent?.journalists?.length > 0) {
                            log(outputId, `‚úÖ Contains ${plan.generatedContent.journalists.length} journalists`, 'success');
                        }
                    } else if (mediaPlans.length > 1) {
                        log(outputId, `‚ùå Multiple media plans created: ${mediaPlans.length}`, 'error');
                    }
                } else {
                    log(outputId, '‚ùå No work items created', 'error');
                }
                
                log(outputId, '\nüéØ Flow test complete!', 'success');
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>