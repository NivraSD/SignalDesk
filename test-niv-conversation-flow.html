<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Niv Conversation Flow (Claude-like)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #8b5cf6;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(30, 30, 45, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            opacity: 0.9;
        }
        .output {
            background: #000;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .debug { color: #8b5cf6; }
        .user { color: #06b6d4; }
        .assistant { color: #8b5cf6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Test Niv Conversation Flow (Claude-like)</h1>
        
        <div class="test-section">
            <h2>Expected Behavior</h2>
            <p style="color: #9ca3af;">
                ‚úÖ Niv should have a conversation first<br>
                ‚úÖ Ask clarifying questions to understand needs<br>
                ‚úÖ Only create materials when explicitly stating "I'll create..."<br>
                ‚úÖ Work items appear only when Niv creates them<br>
                ‚ùå NO automatic generation on first message<br>
                ‚ùå NO work items without explicit creation
            </p>
        </div>

        <div class="test-section">
            <h2>Test 1: Initial Greeting (Should NOT Create)</h2>
            <button class="test-button" onclick="testInitialGreeting()">
                Test: "I need help with PR for my AI startup"
            </button>
            <div id="greeting-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Full Conversation Flow</h2>
            <button class="test-button" onclick="testFullConversation()">
                Test Complete Conversation ‚Üí Creation
            </button>
            <div id="conversation-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Direct Creation Request</h2>
            <button class="test-button" onclick="testDirectRequest()">
                Test: "Create a media list for AI product launch"
            </button>
            <div id="direct-output" class="output"></div>
        </div>

        <div class="test-section">
            <h2>Live Frontend Test</h2>
            <button class="test-button" onclick="window.open('http://localhost:3000', '_blank')">
                Open Frontend
            </button>
            <p style="color: #9ca3af; font-size: 14px;">
                Expected flow in frontend:
                <br>1. Say: "I need help with PR for my AI startup"
                <br>2. Niv should ask questions (NO work items yet)
                <br>3. Answer Niv's questions
                <br>4. Niv says "I'll create..." ‚Üí Work items appear
            </p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3Nzk5MjgsImV4cCI6MjA1MTM1NTkyOH0.MJgH4j8wXJhZgfvMOpViiCyxT-BlLCIIqVMJsE_lXG0';

        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        async function callNiv(message, messages = []) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/niv-orchestrator`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    messages: messages,
                    context: {},
                    mode: 'strategic_orchestration'
                })
            });
            return await response.json();
        }

        async function testInitialGreeting() {
            const outputId = 'greeting-output';
            log(outputId, '=== Testing Initial Greeting ===', 'info');
            
            try {
                const message = "I need help with PR for my AI startup";
                log(outputId, `USER: ${message}`, 'user');
                
                const response = await callNiv(message);
                
                log(outputId, `NIV: ${response.response?.substring(0, 200)}...`, 'assistant');
                
                // Check for work items
                if (response.workItems && response.workItems.length > 0) {
                    log(outputId, `‚ùå FAIL: Generated ${response.workItems.length} work items on greeting`, 'error');
                    response.workItems.forEach(item => {
                        log(outputId, `  - ${item.type}: ${item.title}`, 'error');
                    });
                } else {
                    log(outputId, '‚úÖ SUCCESS: No work items generated (correct behavior)', 'success');
                }
                
                // Check if Niv is asking questions
                const isAsking = response.response?.includes('?') || 
                                response.response?.toLowerCase().includes('could you') ||
                                response.response?.toLowerCase().includes('what');
                
                if (isAsking) {
                    log(outputId, '‚úÖ Niv is asking clarifying questions', 'success');
                } else {
                    log(outputId, '‚ö†Ô∏è Niv should be asking questions', 'warning');
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }

        async function testFullConversation() {
            const outputId = 'conversation-output';
            log(outputId, '=== Testing Full Conversation Flow ===', 'info');
            
            try {
                const messages = [];
                
                // Step 1: Initial request
                log(outputId, '\n--- Step 1: Initial Request ---', 'info');
                let userMsg = "I need help with PR for our AI product launch";
                log(outputId, `USER: ${userMsg}`, 'user');
                
                let response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                
                log(outputId, `NIV: ${response.response?.substring(0, 150)}...`, 'assistant');
                log(outputId, `Work items: ${response.workItems?.length || 0}`, 'debug');
                
                // Step 2: Answer questions
                log(outputId, '\n--- Step 2: Providing Details ---', 'info');
                userMsg = "We're launching next month. It's an AI coding assistant for developers. We want tier-1 tech media coverage.";
                log(outputId, `USER: ${userMsg}`, 'user');
                
                response = await callNiv(userMsg, messages);
                messages.push({ type: 'user', content: userMsg });
                messages.push({ type: 'assistant', content: response.response });
                
                log(outputId, `NIV: ${response.response?.substring(0, 150)}...`, 'assistant');
                log(outputId, `Work items: ${response.workItems?.length || 0}`, 'debug');
                
                // Step 3: Request creation
                log(outputId, '\n--- Step 3: Requesting Creation ---', 'info');
                userMsg = "Yes, please create a media list and strategic plan for the launch";
                log(outputId, `USER: ${userMsg}`, 'user');
                
                response = await callNiv(userMsg, messages);
                log(outputId, `NIV: ${response.response?.substring(0, 150)}...`, 'assistant');
                
                // Check if Niv created materials
                if (response.workItems && response.workItems.length > 0) {
                    log(outputId, '\n‚úÖ SUCCESS: Materials created after conversation!', 'success');
                    response.workItems.forEach(item => {
                        log(outputId, `  üìÑ ${item.type}: ${item.title}`, 'success');
                    });
                } else {
                    // Check if Niv said they'll create
                    if (response.response?.toLowerCase().includes("i'll create") || 
                        response.response?.toLowerCase().includes("let me create")) {
                        log(outputId, '‚úÖ Niv said they\'ll create (check if items appear)', 'success');
                    } else {
                        log(outputId, '‚ùå No materials created', 'error');
                    }
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }

        async function testDirectRequest() {
            const outputId = 'direct-output';
            log(outputId, '=== Testing Direct Creation Request ===', 'info');
            
            try {
                const message = "Create a media list for our AI product launch next month";
                log(outputId, `USER: ${message}`, 'user');
                
                const response = await callNiv(message);
                
                log(outputId, `NIV: ${response.response?.substring(0, 200)}...`, 'assistant');
                
                // Niv might ask for more info or create directly
                if (response.workItems && response.workItems.length > 0) {
                    log(outputId, 'üìù Materials created:', 'info');
                    response.workItems.forEach(item => {
                        log(outputId, `  - ${item.type}: ${item.title}`, 'success');
                    });
                } else {
                    // Check if Niv is gathering more context
                    if (response.response?.includes('?')) {
                        log(outputId, 'üí¨ Niv is asking for more details (good!)', 'info');
                    } else if (response.response?.toLowerCase().includes("i'll create")) {
                        log(outputId, '‚úÖ Niv says they\'ll create it', 'success');
                    } else {
                        log(outputId, '‚ö†Ô∏è Unexpected response', 'warning');
                    }
                }
                
            } catch (error) {
                log(outputId, `Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>