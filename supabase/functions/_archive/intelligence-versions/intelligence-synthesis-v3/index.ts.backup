// Intelligence Synthesis V3 - Clean Entity-Focused Analysis
// Uses Claude Sonnet 4 to analyze WHO did WHAT and provide strategic insights

import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { corsHeaders } from "../_shared/cors.ts"

async function synthesizeWithClaude(intelligence: any, organization: any) {
  // Get API key at runtime, not module load time
  const ANTHROPIC_API_KEY = Deno.env.get('ANTHROPIC_API_KEY')
  console.log('üîë Synthesis V3 - ANTHROPIC_API_KEY exists:', !!ANTHROPIC_API_KEY)
  console.log('üîë API Key length:', ANTHROPIC_API_KEY?.length || 0)
  
  console.log(`üß† V3 Synthesis: Analyzing intelligence for ${organization.name}`)
  console.log(`üìä Data to synthesize: ${intelligence.entity_actions?.all?.length || 0} actions, ${intelligence.topic_trends?.all?.length || 0} trends`)
  
  const entityActions = intelligence.entity_actions?.all?.slice(0, 15) || []  // Top 15 for richer analysis
  const topicTrends = intelligence.topic_trends?.all?.slice(0, 15) || []  // Top 15 for better patterns
  
  console.log('üîç Entity Actions (top 15):', entityActions.length)
  console.log('üìà Topic Trends (top 15):', topicTrends.length)
  
  if (entityActions.length === 0 && topicTrends.length === 0) {
    console.log('‚ö†Ô∏è No intelligence data to synthesize')
    throw new Error('No intelligence data available for synthesis')
  }
  
  // Make 2 parallel calls for better completion
  const [offensiveIntel, defensiveIntel] = await Promise.all([
    synthesizeOffensiveIntel(entityActions, topicTrends, organization),
    synthesizeDefensiveIntel(entityActions, topicTrends, organization)
  ])
  
  console.log('üéØ Offensive Intel Keys:', Object.keys(offensiveIntel))
  console.log('üõ°Ô∏è Defensive Intel Keys:', Object.keys(defensiveIntel))
  
  // Combine both responses
  return {
    ...offensiveIntel,
    ...defensiveIntel
  }
}

async function synthesizeOffensiveIntel(entityActions: any[], topicTrends: any[], organization: any) {
  const prompt = `You are a real-time intelligence analyst for ${organization.name}. Focus on WHAT JUST HAPPENED in the last 48 hours and WHAT IT MEANS RIGHT NOW.

RECENT ENTITY ACTIONS (Last 48 hours):
${JSON.stringify(entityActions, null, 2)}

EMERGING TOPICS (Last 48 hours):
${JSON.stringify(topicTrends, null, 2)}

YOUR MISSION: Find what's GENUINELY INTERESTING in these events. Tell me:
1. What just happened that's SURPRISING or UNEXPECTED
2. The WEIRD coincidence or timing that catches your eye
3. The HUMAN story - who's under pressure, who's taking risks
4. The connection nobody else is making
5. What made you go "wait, what?" when you saw it

Be a detective finding clues, not a consultant writing reports.
Look for: Plot twists, strange bedfellows, broken patterns, desperate moves, bold gambles.
Ask yourself: What would make someone lean forward and say "tell me more"?

Return this JSON with REAL-TIME EVENT ANALYSIS:
{
  "executive_summary": {
    "headline": "The BIGGEST thing that happened in the last 48 hours - be VERY specific with WHO did WHAT WHEN",
    "overview": "In 4-6 sentences, explain these SPECIFIC recent events. Not trends - actual things that happened. Name names, cite specific actions, quote actual statements.",
    "competitive_highlight": "EXACTLY what [competitor name] did [specific action] on [date] and immediate impact",
    "market_highlight": "The specific event/announcement that just shifted market dynamics",
    "regulatory_highlight": "What regulator/government just did/said specifically",
    "media_highlight": "The specific story/article that's driving conversation right now",
    "immediate_watch_points": [
      "What to watch for in next 24 hours based on these events",
      "Expected reactions/responses to these specific events",
      "Potential escalation of these specific situations"
    ]
  },
  "competitive_positioning": {
    "your_position": "Based on THESE SPECIFIC EVENTS from the last 48 hours, what's ${organization.name}'s immediate position? Not general strategy - where you stand RIGHT NOW given what just happened",
    "competitor_moves": [
      {"competitor": "Specific name", "action": "EXACTLY what they did (date, specifics)", "timing": "Why they did it NOW", "immediate_impact": "What changed because of this", "your_response_window": "How long ${organization.name} has to respond"}
    ],
    "immediate_opportunities": "What ${organization.name} could do TODAY/TOMORROW based on these specific events",
    "response_options": "Specific actions ${organization.name} could take in response to these events",
    "timing_considerations": "Why timing matters for these specific situations"
  },
  "between_the_lines": {
    "hidden_signals": [
      {"signal": "Subtle development", "source": "Executive comment/personnel move/small announcement", "why_it_matters": "What this really indicates", "strategic_implication": "How ${organization.name} should interpret this"}
    ],
    "the_interesting_connection": "FIND THE STORY: What's the most INTERESTING connection between these events? Not obvious - something that makes you go 'huh, that's weird/fascinating'. Connect dots others might miss.",
    "the_plot_twist": "What's the SURPRISE in these events? What breaks the expected pattern? What would make someone do a double-take?",
    "the_human_story": "Behind the corporate speak - what's the HUMAN drama here? Who's under pressure? Who's making a bold move? What personal stakes are at play?",
    "the_question_nobody_asks": "What's the uncomfortable question these events raise that nobody wants to talk about?"
  },
  "market_dynamics": {
    "trend_narratives": [
      // Show ALL ${topicTrends.length} trends and their narrative impact
      {"trend": "Trend name", "narrative": "EXPANSIVE analysis of the story this trend tells, who's involved, what perceptions it creates", "momentum": "accelerating/stable/declining", "attention_level": "How much mindshare this has"}
    ],
    "narrative_analysis": "DETAILED NARRATIVE (500+ words): What story do these ${topicTrends.length} trends tell together? How is the market narrative evolving? What new perceptions are taking hold? How does this affect ${organization.name}'s narrative position?",
    "perception_opportunities": "EXPANSIVE analysis of how ${organization.name} could be perceived given these narrative trends",
    "narrative_evolution": "Where the market narrative is heading in 6-12 months based on current momentum",
    "reputation_landscape": "How the reputational landscape is shifting for ${organization.name} and the industry"
  }
}`

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 4000,
        temperature: 0.3,
        messages: [{
          role: 'user',
          content: prompt
        }]
      })
    })

    if (!response.ok) {
      throw new Error(`Claude API error: ${response.status}`)
    }

    const result = await response.json()
    const content = result.content[0].text
    const parsed = JSON.parse(content.match(/\{[\s\S]*\}/)?.[0] || '{}')
    console.log('‚úÖ Offensive intel synthesized')
    return parsed
  } catch (error) {
    console.error('Offensive synthesis error:', error)
    return {}
  }
}

async function synthesizeDefensiveIntel(entityActions: any[], topicTrends: any[], organization: any) {
  const prompt = `You are a pattern recognition analyst for ${organization.name}. Look for WEAK SIGNALS and SUBTLE SHIFTS in recent events.

RECENT ENTITY ACTIONS (Last 48 hours):
${JSON.stringify(entityActions, null, 2)}

EMERGING TOPICS (Last 48 hours):
${JSON.stringify(topicTrends, null, 2)}

Your mission: Find the SMALL things that might matter:
- Minor regulatory comments that hint at future direction
- Small partnerships that could signal bigger alliances
- Subtle language changes in official statements
- New voices entering the conversation
- Quiet moves by usually loud players
- Unusual timing or sequencing of events

Return this JSON with PATTERN ANALYSIS:
{
  "regulatory_policy": {
    "regulatory_narrative": "Analysis of regulatory movements in last 48 hours - focus on PATTERNS and SUBTLE SHIFTS, not just big announcements",
    "regulatory_developments": [
      {"regulator": "Agency/official name", "development": "What they did/said", "perception_impact": "How this affects industry perception", "reputation_effect": "Impact on ${organization.name}'s standing"}
    ],
    "narrative_implications": "What do these regulatory signals mean for ${organization.name}? Look for patterns, not just individual actions",
    "perception_landscape": "How is the regulatory perception shifting based on these recent developments?"
  },
  "thought_leadership": {
    "influencer_signals": [
      {"influencer": "Name/Role", "signal": "What they said/did", "platform": "Conference/podcast/social", "subtext": "What they're really signaling", "impact": "How this shapes industry narrative"}
    ],
    "executive_commentary": "Key quotes and remarks from executives that reveal strategic thinking - focus on informal comments, not press releases",
    "thought_leader_consensus": "What opinion leaders agree on vs where they diverge",
    "narrative_momentum": "Which ideas are gaining traction among influencers",
    "contrarian_voices": "Important dissenting opinions that could reshape the narrative"
  },
  "forward_look": {
    "future_narratives": "WEAK SIGNALS ANALYSIS: Look at the SMALL developments from the last 48 hours. What subtle patterns are emerging? Not big predictions - what small things feel different?",
    "narrative_predictions": [
      {"timeframe": "Next 7 days", "narrative_shift": "Small shift you're noticing based on weak signals", "likelihood": 60, "signals": "The minor events that suggest this", "reputation_impact": "How this subtle shift affects ${organization.name}"}
    ],
    "perception_scenarios": "Based on WEAK SIGNALS: What different scenarios could emerge from these small developments? Focus on subtle shifts, not major changes",
    "narrative_preparation": "What ${organization.name} should watch for - not big events, but small indicators that something is shifting",
    "reputation_considerations": "How these subtle patterns and weak signals might affect ${organization.name}'s standing"
  }
}`

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 4000,
        temperature: 0.3,
        messages: [{
          role: 'user',
          content: prompt
        }]
      })
    })

    if (!response.ok) {
      throw new Error(`Claude API error: ${response.status}`)
    }

    const result = await response.json()
    const content = result.content[0].text
    const parsed = JSON.parse(content.match(/\{[\s\S]*\}/)?.[0] || '{}')
    console.log('‚úÖ Defensive intel synthesized')
    return parsed
  } catch (error) {
    console.error('Defensive synthesis error:', error)
    return {}
  }
}

serve(async (req) => {
  console.log('üöÄ Intelligence Synthesis V3 - Request received:', req.method)
  
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  try {
    if (!ANTHROPIC_API_KEY) {
      throw new Error('ANTHROPIC_API_KEY not configured in environment')
    }
    
    const { intelligence, organization } = await req.json()
    console.log('üìã Synthesis V3 - Organization:', organization?.name)
    
    if (!intelligence || !organization?.name) {
      throw new Error('Intelligence data and organization are required')
    }
    
    console.log(`üîç V3 Synthesis starting for ${organization.name}`)
    console.log(`üìä Processing ${intelligence.entity_actions?.total_count || 0} entity actions`)
    console.log(`üìà Processing ${intelligence.topic_trends?.total_monitored || 0} topic trends`)
    
    const analysis = await synthesizeWithClaude(intelligence, organization)
    console.log('üîë Analysis keys:', Object.keys(analysis));
    
    // Build the final response optimized for frontend display
    const response = {
      success: true,
      organization: organization.name,
      timestamp: new Date().toISOString(),
      
      // Direct tab structure for frontend - ALL tabs from Claude's actual analysis
      tabs: {
        executive: analysis.executive_summary || {},
        positioning: analysis.competitive_positioning || {},
        between: analysis.between_the_lines || {},
        thought: analysis.thought_leadership || {},
        market: analysis.market_dynamics || {},
        regulatory: analysis.regulatory_policy || {},
        forward: analysis.forward_look || {},
        
        // Keep PR-focused structure as additional data
        narrative: { dominant_narratives: [], narrative_threats: [] },
        response: { immediate_responses: [], monitor_only: [] },
        messaging: { opportunities: [] },
        stakeholders: { stakeholder_groups: [] },
        tomorrow: { anticipated_headlines: [] }
      },
      
      // Quick access to critical items
      alerts: intelligence.entity_actions?.critical || [],
      
      // Statistics for display
      statistics: {
        entities_tracked: intelligence.statistics?.entities_tracked || 0,
        actions_captured: intelligence.statistics?.actions_captured || 0,
        topics_monitored: intelligence.statistics?.topics_monitored || 0,
        critical_items: intelligence.statistics?.critical_items || 0
      }
    }
    
    return new Response(
      JSON.stringify(response),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      }
    )
  } catch (error) {
    console.error('‚ùå Synthesis V3 error:', error)
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      hasApiKey: !!ANTHROPIC_API_KEY
    })
    
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message
      }),
      { 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      }
    )
  }
})