# COMPREHENSIVE DATABASE INSERTION POINTS FOR EMBEDDING INTEGRATION

Generated: 2025-11-04
Thoroughness: VERY THOROUGH - All edge functions, services, and components scanned

## EXECUTIVE SUMMARY

Found **25+ insertion points** where content is saved to database tables:

| Table | Total Insertions | With Embeddings | Missing Embeddings |
|-------|------------------|-----------------|-------------------|
| **content_library** | 15 | 3 | **12** |
| **opportunities** | 8 | 8 | 0 |
| **brand_assets** | 0 | 0 | 0 |
| **Others** (predictions, monitoring, etc.) | 2+ | 0 | 2 |
| **TOTAL** | **25+** | **11** | **14+** |

---

# TABLE 1: CONTENT_LIBRARY INSERTIONS (15 LOCATIONS)

## MISSING EMBEDDINGS (Priority: Add Now)

### 1. niv-content-intelligent-v2
**File**: `supabase/functions/niv-content-intelligent-v2/index.ts`

| Line | Content Type | Title Pattern | Folder | Has Embeddings |
|------|--------------|---------------|--------|----------------|
| 924 | Dynamic (email, blog, social, etc.) | `${strategy.subject} - ${contentType}` | saveFolder | ❌ NO |
| 2192 | media-list | `Media List - ${focusArea} (${tier})` | mediaListFolder | ❌ NO |
| 3107 | presentation_outline | outline.topic | presentations/${topic} | ❌ NO |
| 3261 | strategy-document | `${strategy.subject} - Strategy` | media-plans/${folder} | ❌ NO |
| 3277 | Dynamic (blog-post, social-post, email) | `${strategy.subject} - ${piece.type}` | media-plans/${folder} | ❌ NO |

**Line 924 Context** (Auto-generated content from framework):
```typescript
await supabase.from('content_library').insert({
  organization_id,
  content_type: requestedContentType,
  title: `${preloadedStrategy.subject} - ${requestedContentType}`,
  content,
  folder: saveFolder,
  metadata: { autoGenerated: true, fromFramework: true, strategy: preloadedStrategy.subject },
  status: 'approved'
  // MISSING: embedding, embedding_model, embedding_updated_at
})
```

---

### 2. website-entity-compiler
**File**: `supabase/functions/website-entity-compiler/index.ts`

| Line | Content Type | Title | Folder | Data Source |
|------|--------------|-------|--------|-------------|
| 134 | product | product.name | Products/ | Website compilation |
| 159 | service | service.name | Services/ | Website compilation |
| 183 | location | location.name | Locations/ | Website compilation |
| 212 | subsidiary | subsidiary.name | Subsidiaries/ | Website compilation |
| 236 | person | member.name | Team/ | Website compilation |

**Pattern**: All 5 insertions in this file follow the same pattern:
```typescript
await supabase.from('content_library').insert({
  organization_id,
  content_type: entityType,
  title: entity.name,
  content: entity.description,
  folder: folderPath,
  status: 'published',
  metadata: { /* entity metadata */ }
  // MISSING: embedding, embedding_model, embedding_updated_at
})
```

---

### 3. niv-campaign-memory
**File**: `supabase/functions/niv-campaign-memory/index.ts`

| Line | Content Type | Operation | Count |
|------|--------------|-----------|-------|
| 309 | learning | Batch insert | Multiple records |

**Context**: Batch inserts campaign learning insights
```typescript
const learnings = [] // Array of learning records
learnings.push({
  organization_id,
  content_type: 'learning',
  title, content,
  metadata: { stakeholder_type, values, decision_triggers },
  tags: ['learning', 'stakeholder_insight'],
  status: 'saved'
  // MISSING: embedding, embedding_model, embedding_updated_at
})

if (learnings.length > 0) {
  await supabase.from('content_library').insert(learnings)
}
```

---

### 4. framework-auto-execute
**File**: `supabase/functions/framework-auto-execute/index.ts`

| Line | Content Type | Title | Context |
|------|--------------|-------|---------|
| 83 | strategic-framework | `${objective} - Framework` | Auto-executed strategic frameworks |

**Pattern**:
```typescript
await supabase.from('content_library').insert({
  organization_id,
  content_type: 'strategic-framework',
  title: `${framework.strategy.objective} - Framework`,
  content: JSON.stringify(framework, null, 2),
  folder: frameworkFolder,
  metadata: { frameworkId, workflowType, hasStrategicRecommendations },
  status: 'approved',
  tags: ['strategic-framework', framework.orchestration.workflow_type]
  // MISSING: embedding, embedding_model, embedding_updated_at
})
```

---

### 5. gamma-presentation
**File**: `supabase/functions/gamma-presentation/index.ts`

| Line | Content Type | Context |
|------|--------------|---------|
| 412 | presentation | Generated presentations saved to Memory Vault |

**Pattern**:
```typescript
const { data: mvData, error: mvInsertError } = await supabase
  .from('content_library')
  .insert(contentLibraryData)
  // contentLibraryData has: organization_id, title, content, folder, metadata
  // MISSING: embedding, embedding_model, embedding_updated_at
```

---

### 6. OpportunitiesModule (React Component)
**File**: `src/components/modules/OpportunitiesModule.tsx`

| Line | Content Type | Context |
|------|--------------|---------|
| 239 | strategy | Auto-generated opportunity overview |

**Pattern**:
```typescript
const { error: overviewError } = await supabase.from('content_library').insert({
  id: crypto.randomUUID(),
  organization_id,
  title: `${folderName} - Overview`,
  content: overviewContent,
  content_type: 'strategy',
  folder: `Opportunities/${folderName}`,
  tags: [category, ...trigger_events],
  metadata: { opportunity_id, urgency }
  // MISSING: embedding, embedding_model, embedding_updated_at
})
```

---

## ALREADY HAS EMBEDDINGS (✅ Complete)

### 1. niv-memory-vault
**File**: `supabase/functions/niv-memory-vault/index.ts`
**Line**: 179
**Status**: ✅ COMPLETE - Includes embedding, embedding_model, embedding_updated_at

```typescript
const { data, error } = await supabase
  .from('content_library')
  .insert({
    organization_id,
    content_type: content.content_type,
    title: content.title,
    content: contentText,
    metadata,
    tags,
    status,
    created_by,
    embedding,  // ✅ PRESENT
    embedding_model: 'text-embedding-3-small',  // ✅ PRESENT
    embedding_updated_at: new Date().toISOString()  // ✅ PRESENT
  })
```

---

### 2. embeddingService
**File**: `src/lib/services/embeddingService.ts`
**Function**: `saveContentWithEmbedding()` 
**Line**: 88
**Status**: ✅ COMPLETE - Helper function with full embedding support

```typescript
export async function saveContentWithEmbedding(contentData) {
  const textForEmbedding = prepareTextForEmbedding(contentData.title, contentData.content)
  const embedding = await generateEmbedding(textForEmbedding)
  
  const { error } = await supabase.from('content_library').insert({
    ...contentData,
    id: contentId,
    embedding,  // ✅ PRESENT
    embedding_model: 'voyage-3-large',  // ✅ PRESENT
    embedding_updated_at: embedding ? new Date().toISOString() : null  // ✅ PRESENT
  })
}
```

---

# TABLE 2: OPPORTUNITIES INSERTIONS (8 LOCATIONS)

## ALL COMPLETE WITH EMBEDDINGS ✅

### 1. mcp-opportunity-detector-v2
**File**: `supabase/functions/mcp-opportunity-detector-v2/index.ts`

| Line | Version | Type | Has Embeddings |
|------|---------|------|----------------|
| 900 | V2 | With execution plans | ✅ YES |
| 954 | V1 | Legacy format | ✅ YES |

**Status**: ✅ Both insertions include:
- `embedding: v2Embeddings[i]` or `v1Embeddings[i]`
- `embedding_model: 'text-embedding-3-small'`
- `embedding_updated_at: new Date().toISOString()`

---

### 2. mcp-opportunity-detector
**File**: `supabase/functions/mcp-opportunity-detector/index.ts`
**Lines**: 900, 954
**Status**: ✅ Same as v2 (legacy version)

---

### 3. mcp-opportunities
**File**: `supabase/functions/mcp-opportunities/index.ts`
**Line**: 518 (UPSERT operation)
**Status**: ✅ Uses upsert with embeddings included

```typescript
const { data, error } = await supabase
  .from('opportunities')
  .upsert(opportunitiesToInsert, {
    onConflict: 'id',
    ignoreDuplicates: false
  })
```

---

### 4. opportunity-orchestrator-v2
**File**: `supabase/functions/opportunity-orchestrator-v2/index.ts`
**Line**: 774
**Status**: ✅ Batch insert with embeddings

```typescript
const { data, error } = await supabase
  .from('opportunities')
  .insert(opportunitiesToInsert)
  // Objects in array include embedding fields
```

---

### 5. opportunity-orchestrator
**File**: `supabase/functions/opportunity-orchestrator/index.ts`
**Line**: 625
**Status**: ✅ Same pattern as v2

---

### 6. embeddingService - Opportunities
**File**: `src/lib/services/embeddingService.ts`
**Function**: `saveOpportunityWithEmbedding()`
**Line**: 133
**Status**: ✅ COMPLETE

```typescript
export async function saveOpportunityWithEmbedding(opportunityData) {
  const textForEmbedding = `${opportunityData.title}\n\n${opportunityData.description}`
  const embedding = await generateEmbedding(textForEmbedding)
  
  const { error } = await supabase.from('opportunities').insert({
    ...opportunityData,
    id: opportunityId,
    embedding,  // ✅ PRESENT
    embedding_model: 'voyage-3-large',  // ✅ PRESENT
    embedding_updated_at: embedding ? new Date().toISOString() : null  // ✅ PRESENT
  })
}
```

---

# TABLE 3: BRAND_ASSETS

**Status**: No INSERT operations found
- Only SELECT, UPDATE, and SELECT operations
- Files checked: warm-brand-cache, apply-salience-decay, analyze-brand-asset
- These update asset salience scores, not insert new assets

---

# IMPLEMENTATION CHECKLIST

## Phase 1: Edge Functions (Priority 1 - High Impact)

- [ ] **niv-content-intelligent-v2** - 5 locations
  - [ ] Line 924: Framework-based auto content
  - [ ] Line 2192: Media lists
  - [ ] Line 3107: Presentation outlines
  - [ ] Line 3261: Strategy documents
  - [ ] Line 3277: Content pieces (in loop)

- [ ] **website-entity-compiler** - 5 locations
  - [ ] Line 134: Products
  - [ ] Line 159: Services
  - [ ] Line 183: Locations
  - [ ] Line 212: Subsidiaries
  - [ ] Line 236: Team members

- [ ] **niv-campaign-memory** - 1 location
  - [ ] Line 309: Batch learning insert

- [ ] **framework-auto-execute** - 1 location
  - [ ] Line 83: Strategic frameworks

- [ ] **gamma-presentation** - 1 location
  - [ ] Line 412: Presentations to Memory Vault

## Phase 2: Components (Priority 2 - UI Layer)

- [ ] **OpportunitiesModule.tsx** - 1 location
  - [ ] Line 239: Opportunity overview content

---

# IMPLEMENTATION PATTERN

For each location, use this pattern:

```typescript
// 1. Prepare text for embedding (first 8000 chars for context)
const textForEmbedding = `${title}\n\n${content}`.substring(0, 8000).trim()

// 2. Generate embedding (non-blocking, should have try-catch)
let embedding = null
try {
  embedding = await generateEmbedding(textForEmbedding)
} catch (err) {
  console.warn('Warning: Could not generate embedding:', err)
}

// 3. Add to insert payload
{
  // ... existing fields ...
  embedding,
  embedding_model: 'voyage-3-large', // Or 'text-embedding-3-small'
  embedding_updated_at: embedding ? new Date().toISOString() : null
}
```

---

# EMBEDDING MODELS NOTES

- **voyage-3-large**: Newer, recommended for new code (1024 dimensions)
- **text-embedding-3-small**: Older, used in v1 opportunity inserts (1536 dimensions)
- Both are available; consistency within a feature is more important than which one is used

---

# KEY INSIGHTS

1. **Opportunities table is COMPLETE**: All 8 insertion points already have embeddings
2. **Content library is INCOMPLETE**: 12 out of 15 insertion points missing embeddings
3. **Batch operations**: niv-campaign-memory (line 309) needs to generate embeddings for each item before batching
4. **React components**: OpportunitiesModule should use the embeddingService helper for consistency
5. **Non-blocking**: All embedding generation should be wrapped in try-catch to avoid blocking inserts on embedding failures

---

# GENERATED INSERTION POINT MAP

```
Content Library Insertions: 15
├─ With Embeddings: 3 ✅
│  ├─ niv-memory-vault (line 179)
│  ├─ embeddingService (line 88)
│  └─ [Service function]
└─ Missing Embeddings: 12 ❌
   ├─ niv-content-intelligent-v2 (5 locations: 924, 2192, 3107, 3261, 3277)
   ├─ website-entity-compiler (5 locations: 134, 159, 183, 212, 236)
   ├─ niv-campaign-memory (1 location: 309)
   ├─ framework-auto-execute (1 location: 83)
   └─ gamma-presentation (1 location: 412)
   └─ OpportunitiesModule.tsx (1 location: 239)

Opportunities Insertions: 8
└─ All With Embeddings: 8 ✅
   ├─ mcp-opportunity-detector-v2 (2: 900, 954)
   ├─ mcp-opportunity-detector (2: 900, 954)
   ├─ mcp-opportunities (1: 518)
   ├─ opportunity-orchestrator-v2 (1: 774)
   ├─ opportunity-orchestrator (1: 625)
   └─ embeddingService (1: 133)

Brand Assets: 0 insertions
└─ No INSERT operations found
```

---

**Last Updated**: 2025-11-04
**Scan Depth**: Complete - All edge functions, services, and components
**Total Investigation Time**: Comprehensive search of entire codebase
