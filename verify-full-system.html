<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full System Verification</title>
    <style>
        body { 
            background: #0a0a0a; 
            color: #00ff88; 
            font-family: 'Courier New', monospace; 
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #00ffcc; text-shadow: 0 0 10px rgba(0,255,204,0.5); }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .section {
            background: rgba(0,255,136,0.05);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
        }
        .success { color: #00ff88; font-weight: bold; }
        .error { color: #ff0088; font-weight: bold; }
        .warning { color: #ffcc00; font-weight: bold; }
        pre { 
            background: rgba(0,0,0,0.5); 
            padding: 10px; 
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
        }
        button {
            background: linear-gradient(135deg, #00ff88, #00ffcc);
            color: #0a0a0a;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .status-item {
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #00ff88;
            padding-left: 10px;
        }
        .status-item.fail {
            border-left-color: #ff0088;
        }
        .status-item.partial {
            border-left-color: #ffcc00;
        }
    </style>
</head>
<body>
    <h1>üîç SignalDesk Full System Verification</h1>
    
    <div style="text-align: center; margin: 20px 0;">
        <button onclick="runFullTest()">Run Complete Test</button>
        <button onclick="checkCaches()">Check Caches</button>
        <button onclick="clearAllCaches()">Clear All Caches</button>
    </div>

    <div class="grid">
        <div class="section">
            <h2>üì° Phase 1: Discovery</h2>
            <div id="discovery-status"></div>
        </div>
        
        <div class="section">
            <h2>üìä Phase 2: Gathering</h2>
            <div id="gathering-status"></div>
        </div>
        
        <div class="section">
            <h2>üß† Phase 3: Synthesis</h2>
            <div id="synthesis-status"></div>
        </div>
        
        <div class="section">
            <h2>üìë Tab Population</h2>
            <div id="tabs-status"></div>
        </div>
        
        <div class="section">
            <h2>üéØ Opportunities</h2>
            <div id="opportunities-status"></div>
        </div>
        
        <div class="section">
            <h2>üíæ Cache Status</h2>
            <div id="cache-status"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìù Detailed Results</h2>
        <div id="detailed-results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';

        async function runFullTest() {
            // Clear previous results
            document.getElementById('discovery-status').innerHTML = '<p>Testing...</p>';
            document.getElementById('gathering-status').innerHTML = '<p>Testing...</p>';
            document.getElementById('synthesis-status').innerHTML = '<p>Testing...</p>';
            document.getElementById('tabs-status').innerHTML = '<p>Testing...</p>';
            document.getElementById('opportunities-status').innerHTML = '<p>Testing...</p>';
            
            const testData = {
                organization: { name: 'Microsoft', industry: 'technology' },
                stakeholders: {
                    competitors: ['Google', 'Amazon', 'Apple', 'Oracle', 'Salesforce'],
                    regulators: ['FTC', 'SEC', 'EU Commission'],
                    activists: ['EFF'],
                    media_outlets: ['TechCrunch', 'The Verge', 'Wired', 'Reuters'],
                    investors: ['Vanguard', 'BlackRock'],
                    analysts: ['Gartner', 'Forrester']
                },
                monitoring_topics: ['AI regulation', 'cloud computing', 'cybersecurity', 'quantum computing']
            };

            try {
                // 1. DISCOVERY
                const discoveryResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-discovery-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const discoveryData = await discoveryResponse.json();
                
                let discoveryHtml = '';
                if (discoveryData.success) {
                    discoveryHtml = '<div class="status-item success">‚úÖ Discovery Success</div>';
                    discoveryHtml += `<div class="status-item">Competitors: ${discoveryData.entities?.competitors?.length || 0}</div>`;
                    discoveryHtml += `<div class="status-item">Media: ${discoveryData.entities?.media?.length || 0}</div>`;
                    discoveryHtml += `<div class="status-item">Regulators: ${discoveryData.entities?.regulators?.length || 0}</div>`;
                    discoveryHtml += `<div class="status-item">Total: ${discoveryData.statistics?.total_entities || 0}</div>`;
                } else {
                    discoveryHtml = '<div class="status-item fail">‚ùå Discovery Failed</div>';
                }
                document.getElementById('discovery-status').innerHTML = discoveryHtml;

                if (!discoveryData.success) return;

                // 2. GATHERING
                const gatheringResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-gathering-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        entities: discoveryData.entities,
                        organization: testData.organization
                    })
                });
                
                const gatheringData = await gatheringResponse.json();
                
                let gatheringHtml = '';
                if (gatheringData.success) {
                    const realActions = gatheringData.entity_actions?.all?.filter(a => a.url && a.url !== '#') || [];
                    gatheringHtml = '<div class="status-item success">‚úÖ Gathering Success</div>';
                    gatheringHtml += `<div class="status-item">Total Actions: ${gatheringData.entity_actions?.all?.length || 0}</div>`;
                    gatheringHtml += `<div class="status-item">Real Actions: ${realActions.length}</div>`;
                    gatheringHtml += `<div class="status-item">Topics: ${gatheringData.topic_trends?.all?.length || 0}</div>`;
                } else {
                    gatheringHtml = '<div class="status-item fail">‚ùå Gathering Failed</div>';
                }
                document.getElementById('gathering-status').innerHTML = gatheringHtml;

                if (!gatheringData.success) return;

                // 3. SYNTHESIS
                const synthesisResponse = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-synthesis-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        intelligence: {
                            entity_actions: gatheringData.entity_actions || { all: [] },
                            topic_trends: gatheringData.topic_trends || { all: [] }
                        },
                        organization: testData.organization
                    })
                });
                
                const synthesisData = await synthesisResponse.json();
                console.log('Full synthesis response:', synthesisData);
                
                let synthesisHtml = '';
                if (synthesisData.success) {
                    synthesisHtml = '<div class="status-item success">‚úÖ Synthesis Success</div>';
                    synthesisHtml += `<div class="status-item">Tabs: ${Object.keys(synthesisData.tabs || {}).length}</div>`;
                    synthesisHtml += `<div class="status-item">Alerts: ${synthesisData.alerts?.length || 0}</div>`;
                    synthesisHtml += `<div class="status-item">Opportunities: ${synthesisData.opportunities?.length || 0}</div>`;
                    
                    // Save to cache for other components
                    localStorage.setItem('signaldesk_last_synthesis', JSON.stringify(synthesisData));
                    localStorage.setItem('signaldesk_intelligence_cache', JSON.stringify({
                        data: synthesisData,
                        timestamp: new Date().toISOString()
                    }));
                } else {
                    synthesisHtml = '<div class="status-item fail">‚ùå Synthesis Failed</div>';
                }
                document.getElementById('synthesis-status').innerHTML = synthesisHtml;

                // CHECK TABS
                if (synthesisData.tabs) {
                    let tabsHtml = '';
                    const expectedTabs = ['executive', 'competitive', 'market', 'positioning', 'between', 'regulatory', 'media', 'thought'];
                    
                    expectedTabs.forEach(tabName => {
                        const tab = synthesisData.tabs[tabName];
                        if (tab) {
                            const hasContent = Object.keys(tab).length > 0;
                            tabsHtml += `<div class="status-item ${hasContent ? '' : 'partial'}">${hasContent ? '‚úÖ' : '‚ö†Ô∏è'} ${tabName}</div>`;
                        } else {
                            tabsHtml += `<div class="status-item fail">‚ùå ${tabName} (missing)</div>`;
                        }
                    });
                    
                    document.getElementById('tabs-status').innerHTML = tabsHtml;
                }

                // CHECK OPPORTUNITIES
                if (synthesisData.opportunities) {
                    let oppHtml = `<div class="status-item success">‚úÖ ${synthesisData.opportunities.length} opportunities</div>`;
                    synthesisData.opportunities.slice(0, 3).forEach(opp => {
                        oppHtml += `<div class="status-item">- ${opp.title}</div>`;
                    });
                    document.getElementById('opportunities-status').innerHTML = oppHtml;
                } else {
                    document.getElementById('opportunities-status').innerHTML = '<div class="status-item fail">‚ùå No opportunities</div>';
                }

                // DETAILED RESULTS
                document.getElementById('detailed-results').innerHTML = `
                    <h3>Sample Intelligence Item:</h3>
                    <pre>${JSON.stringify(gatheringData.entity_actions?.all?.[0] || {}, null, 2)}</pre>
                    <h3>Executive Tab Content:</h3>
                    <pre>${JSON.stringify(synthesisData.tabs?.executive || {}, null, 2)}</pre>
                `;

            } catch (error) {
                document.getElementById('detailed-results').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function checkCaches() {
            const cacheStatus = document.getElementById('cache-status');
            let html = '';
            
            const cacheKeys = [
                'signaldesk_last_synthesis',
                'signaldesk_intelligence_cache',
                'signaldesk_intelligence_hub',
                'signaldesk_organization',
                'signaldesk_complete_profile'
            ];
            
            cacheKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const data = JSON.parse(value);
                        html += `<div class="status-item">‚úÖ ${key} (${JSON.stringify(value).length} bytes)</div>`;
                    } catch {
                        html += `<div class="status-item partial">‚ö†Ô∏è ${key} (invalid JSON)</div>`;
                    }
                } else {
                    html += `<div class="status-item fail">‚ùå ${key} (empty)</div>`;
                }
            });
            
            cacheStatus.innerHTML = html;
        }

        function clearAllCaches() {
            const keys = Object.keys(localStorage).filter(k => k.includes('signaldesk'));
            keys.forEach(key => localStorage.removeItem(key));
            document.getElementById('cache-status').innerHTML = '<div class="success">‚úÖ All caches cleared</div>';
        }

        // Check caches on load
        checkCaches();
    </script>
</body>
</html>