<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rich Claude Analysis Pipeline</title>
    <style>
        body {
            font-family: 'SF Pro Text', -apple-system, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0;
            font-size: 28px;
            color: white;
        }
        .stage {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }
        .status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.pending { background: #444; color: #999; }
        .status.running { background: #2563eb; color: white; }
        .status.success { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .data-section {
            margin-top: 15px;
            padding: 15px;
            background: #0f0f0f;
            border-radius: 6px;
            border: 1px solid #222;
        }
        .data-title {
            font-size: 14px;
            font-weight: 600;
            color: #999;
            margin-bottom: 10px;
        }
        .claude-analysis {
            background: #1e293b;
            border: 1px solid #334155;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .opportunity-card {
            background: #1e293b;
            border: 1px solid #475569;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .opportunity-title {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .opportunity-detail {
            color: #cbd5e1;
            font-size: 14px;
            margin: 3px 0;
        }
        .json-view {
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .highlight { color: #fbbf24; font-weight: 600; }
        .error-msg { color: #ef4444; }
        .success-msg { color: #10b981; }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .summary-box {
            background: linear-gradient(135deg, #065f46, #064e3b);
            border: 1px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .metric {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 10px;
        }
        .metric-label {
            color: #6ee7b7;
            font-size: 12px;
            text-transform: uppercase;
        }
        .metric-value {
            color: white;
            font-size: 24px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Rich Claude Analysis Pipeline Test</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0;">
            Testing if each stage generates rich, elite-level Claude analysis (not generic fallback)
        </p>
    </div>

    <div class="summary-box" id="summary" style="display: none;">
        <h2 style="margin-top: 0; color: white;">Pipeline Summary</h2>
        <div>
            <div class="metric">
                <div class="metric-label">Total Stages</div>
                <div class="metric-value" id="totalStages">5</div>
            </div>
            <div class="metric">
                <div class="metric-label">Claude Success</div>
                <div class="metric-value" id="claudeSuccess">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Opportunities Found</div>
                <div class="metric-value" id="totalOpportunities">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Rich Content %</div>
                <div class="metric-value" id="richContentPercent">0%</div>
            </div>
        </div>
    </div>

    <button onclick="runPipeline()">üöÄ Run Intelligence Pipeline</button>

    <div id="stages"></div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        const stages = [
            { name: 'Stage 1: Competitive Intelligence', endpoint: 'intelligence-stage-1-competitors', key: 'competitive' },
            { name: 'Stage 2: Media Analysis', endpoint: 'intelligence-stage-2-media', key: 'media' },
            { name: 'Stage 3: Regulatory Intelligence', endpoint: 'intelligence-stage-3-regulatory', key: 'regulatory' },
            { name: 'Stage 4: Trend Analysis', endpoint: 'intelligence-stage-4-trends', key: 'trends' },
            { name: 'Stage 5: Synthesis & PR Implications', endpoint: 'intelligence-stage-5-synthesis', key: 'synthesis' }
        ];

        let previousResults = {};
        let stageResults = {};

        function createStageElement(stage, index) {
            return `
                <div class="stage" id="stage-${index}">
                    <div class="stage-header">
                        <div class="stage-title">${stage.name}</div>
                        <div class="status pending" id="status-${index}">Pending</div>
                    </div>
                    <div id="content-${index}"></div>
                </div>
            `;
        }

        function analyzeClaudeContent(data) {
            // Check if this is Claude-generated content or fallback
            const indicators = {
                hasClaudeMetadata: data?.metadata?.claude_enhanced === true,
                hasAnalystPersonality: !!data?.metadata?.analyst_personality,
                hasRichContent: false,
                hasOpportunities: false,
                opportunityCount: 0,
                specificDetails: []
            };

            // Check for rich content patterns
            if (data?.competitors?.direct?.length > 0) {
                const hasSpecificNames = data.competitors.direct.some(c => 
                    c.name && c.name !== 'Competitor 1' && c.name !== 'Unknown');
                if (hasSpecificNames) {
                    indicators.hasRichContent = true;
                    indicators.specificDetails.push('Named competitors');
                }
            }

            if (data?.media_landscape?.outlets?.length > 0) {
                const hasRealOutlets = data.media_landscape.outlets.some(o => 
                    o.name && !o.name.includes('outlet'));
                if (hasRealOutlets) {
                    indicators.hasRichContent = true;
                    indicators.specificDetails.push('Real media outlets');
                }
            }

            if (data?.opportunities?.length > 0) {
                indicators.hasOpportunities = true;
                indicators.opportunityCount = data.opportunities.length;
                const hasSpecificOpps = data.opportunities.some(o => 
                    o.headline && o.headline.length > 20);
                if (hasSpecificOpps) {
                    indicators.hasRichContent = true;
                    indicators.specificDetails.push(`${data.opportunities.length} opportunities`);
                }
            }

            if (data?.consolidated_opportunities?.prioritized_list?.length > 0) {
                indicators.hasOpportunities = true;
                indicators.opportunityCount = data.consolidated_opportunities.prioritized_list.length;
                indicators.hasRichContent = true;
                indicators.specificDetails.push(`${data.consolidated_opportunities.prioritized_list.length} consolidated opportunities`);
            }

            return indicators;
        }

        async function runStage(stage, index) {
            const statusEl = document.getElementById(`status-${index}`);
            const contentEl = document.getElementById(`content-${index}`);
            
            statusEl.className = 'status running';
            statusEl.textContent = 'Running...';
            
            try {
                const organization = {
                    name: 'Acme Corp',
                    industry: 'Technology',
                    description: 'Leading AI and cloud computing company'
                };

                const requestBody = {
                    organization,
                    previousResults,
                    intelligence: previousResults.extraction?.intelligence || {}
                };

                // For synthesis, pass all previous stage data
                if (stage.key === 'synthesis') {
                    requestBody.stage1 = stageResults.stage1;
                    requestBody.stage2 = stageResults.stage2;
                    requestBody.stage3 = stageResults.stage3;
                    requestBody.stage4 = stageResults.stage4;
                }

                console.log(`üöÄ Calling ${stage.name}...`);
                const response = await fetch(`${SUPABASE_URL}/functions/v1/${stage.endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                console.log(`üì¶ ${stage.name} response:`, result);

                // Store results for next stages
                previousResults[stage.key] = result;
                stageResults[`stage${index + 1}`] = result.data;

                // Analyze the Claude content
                const analysis = analyzeClaudeContent(result.data);
                
                let html = '<div class="data-section">';
                
                // Status indicators
                html += '<div class="data-title">Claude Analysis Status</div>';
                html += '<div class="claude-analysis">';
                
                if (analysis.hasClaudeMetadata) {
                    html += `<div class="success-msg">‚úÖ Claude Enhanced: YES</div>`;
                    html += `<div>ü§ñ Analyst: ${result.data?.metadata?.analyst_personality || 'Unknown'}</div>`;
                } else {
                    html += `<div class="error-msg">‚ùå Claude Enhanced: NO (Using Fallback)</div>`;
                }

                if (analysis.hasRichContent) {
                    html += `<div class="success-msg">‚úÖ Rich Content Detected</div>`;
                    html += `<div>üìä Details: ${analysis.specificDetails.join(', ')}</div>`;
                } else {
                    html += `<div class="error-msg">‚ö†Ô∏è Generic/Fallback Content</div>`;
                }

                if (analysis.hasOpportunities) {
                    html += `<div class="success-msg">üéØ ${analysis.opportunityCount} Opportunities Found</div>`;
                }

                html += '</div>';

                // Show key data points
                if (result.data) {
                    html += '<div class="data-title" style="margin-top: 15px;">Key Intelligence Data</div>';
                    
                    // Show opportunities if present
                    if (result.data.opportunities?.length > 0) {
                        html += '<div class="data-title">PR Opportunities</div>';
                        result.data.opportunities.slice(0, 3).forEach(opp => {
                            html += `<div class="opportunity-card">
                                <div class="opportunity-title">${opp.headline || opp.opportunity || 'Opportunity'}</div>
                                <div class="opportunity-detail">Type: ${opp.type || 'Unknown'}</div>
                                <div class="opportunity-detail">Impact: ${opp.impact || 'Unknown'}</div>
                                <div class="opportunity-detail">Timing: ${opp.timing || 'Unknown'}</div>
                            </div>`;
                        });
                    }

                    if (result.data.consolidated_opportunities?.prioritized_list?.length > 0) {
                        html += '<div class="data-title">Consolidated Opportunities</div>';
                        result.data.consolidated_opportunities.prioritized_list.slice(0, 3).forEach(opp => {
                            html += `<div class="opportunity-card">
                                <div class="opportunity-title">${opp.opportunity}</div>
                                <div class="opportunity-detail">Confidence: ${opp.confidence}%</div>
                                <div class="opportunity-detail">Urgency: ${opp.urgency}</div>
                                <div class="opportunity-detail">${opp.quick_summary || ''}</div>
                            </div>`;
                        });
                    }

                    // Show raw JSON for debugging
                    html += '<div class="data-title" style="margin-top: 15px;">Raw Response (First 1000 chars)</div>';
                    html += `<div class="json-view">${JSON.stringify(result.data, null, 2).substring(0, 1000)}...</div>`;
                }
                
                html += '</div>';
                contentEl.innerHTML = html;
                
                statusEl.className = 'status success';
                statusEl.textContent = analysis.hasClaudeMetadata ? 'Claude Success' : 'Fallback Used';
                
                return analysis;
                
            } catch (error) {
                console.error(`Error in ${stage.name}:`, error);
                statusEl.className = 'status error';
                statusEl.textContent = 'Error';
                contentEl.innerHTML = `<div class="error-msg">Error: ${error.message}</div>`;
                return { hasClaudeMetadata: false, hasRichContent: false };
            }
        }

        async function runPipeline() {
            // Reset
            previousResults = {};
            stageResults = {};
            document.getElementById('stages').innerHTML = stages.map((s, i) => createStageElement(s, i)).join('');
            
            let claudeSuccessCount = 0;
            let totalOpportunities = 0;
            let richContentCount = 0;

            // First, get monitoring data
            console.log('üìä Fetching initial monitoring data...');
            try {
                const monitorResponse = await fetch(`${SUPABASE_URL}/functions/v1/monitor-intelligence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        organization: {
                            name: 'Acme Corp',
                            industry: 'Technology'
                        }
                    })
                });
                
                const monitorData = await monitorResponse.json();
                if (monitorData.success) {
                    previousResults.extraction = {
                        intelligence: monitorData.intelligence || {}
                    };
                    console.log('‚úÖ Monitoring data collected:', monitorData.intelligence?.raw_count || 0, 'signals');
                }
            } catch (error) {
                console.error('Failed to get monitoring data:', error);
            }

            // Run stages sequentially
            for (let i = 0; i < stages.length; i++) {
                const analysis = await runStage(stages[i], i);
                
                if (analysis.hasClaudeMetadata) claudeSuccessCount++;
                if (analysis.hasRichContent) richContentCount++;
                totalOpportunities += analysis.opportunityCount;
                
                // Wait a bit between stages
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Show summary
            document.getElementById('summary').style.display = 'block';
            document.getElementById('claudeSuccess').textContent = claudeSuccessCount;
            document.getElementById('totalOpportunities').textContent = totalOpportunities;
            document.getElementById('richContentPercent').textContent = 
                Math.round((richContentCount / stages.length) * 100) + '%';
        }
    </script>
</body>
</html>