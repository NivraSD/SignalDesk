<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SignalDesk Complete Pipeline Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            position: relative;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .stage-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            padding: 8px 16px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.pending { background: #f0f0f0; color: #666; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .result-card h4 {
            margin-top: 0;
            color: #667eea;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .org-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SignalDesk Complete Pipeline Test</h1>
        <p>Test your entire intelligence pipeline from organization discovery through opportunity detection</p>
        
        <div class="test-controls">
            <input type="text" 
                   id="orgName" 
                   class="org-input" 
                   placeholder="Enter organization name (e.g., OpenAI)"
                   value="OpenAI">
            <button onclick="runCompletePipeline()">‚ñ∂Ô∏è Run Complete Pipeline</button>
            <button onclick="runQuickTest()">‚ö° Quick Test (Skip Discovery)</button>
            <button onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
        </div>

        <!-- Stage 0: Organization Discovery -->
        <div class="test-section" id="stage-discovery">
            <div class="test-header">
                <h3>üîç Organization Discovery</h3>
                <span class="stage-number">Stage 0</span>
            </div>
            <div class="status pending" id="status-discovery">Pending</div>
            <div class="log" id="log-discovery" style="display:none;"></div>
        </div>

        <!-- Stage 1: Data Collection -->
        <div class="test-section" id="stage-collection">
            <div class="test-header">
                <h3>üì° Data Collection (RSS + Firecrawl + Monitoring)</h3>
                <span class="stage-number">Stage 1</span>
            </div>
            <div class="status pending" id="status-collection">Pending</div>
            <div class="log" id="log-collection" style="display:none;"></div>
        </div>

        <!-- Stage 2-6: Intelligence Analysis -->
        <div class="test-section" id="stage-analysis">
            <div class="test-header">
                <h3>üß† 5-Stage Intelligence Analysis</h3>
                <span class="stage-number">Stages 2-6</span>
            </div>
            <div class="status pending" id="status-analysis">Pending</div>
            <div class="results" id="analysis-stages"></div>
            <div class="log" id="log-analysis" style="display:none;"></div>
        </div>

        <!-- Stage 7: Opportunity Detection -->
        <div class="test-section" id="stage-opportunities">
            <div class="test-header">
                <h3>üí° Opportunity Detection</h3>
                <span class="stage-number">Stage 7</span>
            </div>
            <div class="status pending" id="status-opportunities">Pending</div>
            <div class="log" id="log-opportunities" style="display:none;"></div>
        </div>

        <!-- Final Results -->
        <div class="test-section" id="final-results" style="display:none;">
            <h3>üìä Pipeline Results</h3>
            <div class="results" id="results-container"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zskaxjtyuaqazydouifp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpza2F4anR5dWFxYXp5ZG91aWZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjk2MzcsImV4cCI6MjA3MDcwNTYzN30.5PhMVptHk3n-1dTSwGF-GvTwrVM0loovkHGUBDtBOe8';
        
        let organizationProfile = null;
        let collectionData = null;
        let stageResults = {};
        
        function updateStatus(stage, status, message) {
            const statusEl = document.getElementById(`status-${stage}`);
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
            
            const logEl = document.getElementById(`log-${stage}`);
            if (message && status !== 'pending') {
                logEl.style.display = 'block';
                logEl.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            }
        }
        
        function updateProgress(percent) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
        }
        
        async function runCompletePipeline() {
            const orgName = document.getElementById('orgName').value;
            if (!orgName) {
                alert('Please enter an organization name');
                return;
            }
            
            clearAll();
            updateProgress(0);
            
            try {
                // Stage 0: Organization Discovery
                updateStatus('discovery', 'running', 'Discovering organization profile...');
                organizationProfile = await discoverOrganization(orgName);
                updateStatus('discovery', 'success', `‚úÖ Discovered: ${organizationProfile.name} (${organizationProfile.industry})`);
                updateProgress(15);
                
                // Stage 1: Data Collection
                updateStatus('collection', 'running', 'Collecting intelligence data...');
                collectionData = await collectIntelligence(organizationProfile);
                updateStatus('collection', 'success', `‚úÖ Collected ${collectionData.raw_signals?.length || 0} signals from ${collectionData.metadata?.sources?.length || 0} sources`);
                updateProgress(30);
                
                // Stages 2-6: Intelligence Analysis
                updateStatus('analysis', 'running', 'Running 5-stage analysis...');
                await runIntelligenceAnalysis(organizationProfile, collectionData);
                updateStatus('analysis', 'success', '‚úÖ Completed 5-stage analysis');
                updateProgress(80);
                
                // Stage 7: Opportunity Detection
                updateStatus('opportunities', 'running', 'Detecting opportunities...');
                const opportunities = await detectOpportunities(stageResults);
                updateStatus('opportunities', 'success', `‚úÖ Detected ${opportunities.length || 0} opportunities`);
                updateProgress(100);
                
                // Show final results
                showFinalResults();
                
            } catch (error) {
                console.error('Pipeline error:', error);
                alert(`Pipeline failed: ${error.message}`);
            }
        }
        
        async function runQuickTest() {
            const orgName = document.getElementById('orgName').value;
            if (!orgName) {
                alert('Please enter an organization name');
                return;
            }
            
            clearAll();
            
            // Use a mock organization profile for quick testing
            organizationProfile = {
                name: orgName,
                industry: 'Technology',
                competitors: ['Microsoft', 'Google', 'Anthropic'],
                stakeholders: {
                    regulators: ['FTC', 'EU Commission'],
                    media: ['TechCrunch', 'The Verge'],
                    analysts: ['Gartner', 'Forrester']
                }
            };
            
            updateStatus('discovery', 'success', '‚úÖ Using mock profile for quick test');
            updateProgress(15);
            
            // Continue with collection and analysis
            await collectIntelligence(organizationProfile);
            await runIntelligenceAnalysis(organizationProfile, collectionData);
        }
        
        async function discoverOrganization(orgName) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/organization-discovery`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({ organizationName: orgName })
            });
            
            if (!response.ok) {
                throw new Error(`Discovery failed: ${response.status}`);
            }
            
            const result = await response.json();
            return result.organization;
        }
        
        async function collectIntelligence(organization) {
            const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-collection-v1`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                },
                body: JSON.stringify({
                    organization,
                    entities: {
                        competitors: organization.competitors || [],
                        regulators: organization.stakeholders?.regulators || [],
                        media: organization.stakeholders?.media || [],
                        analysts: organization.stakeholders?.analysts || []
                    }
                })
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Collection failed: ${text}`);
            }
            
            const result = await response.json();
            collectionData = result.intelligence || result;
            return collectionData;
        }
        
        async function runIntelligenceAnalysis(organization, intelligence) {
            const stages = [
                { num: 1, name: 'competitors', label: 'Competitive Analysis' },
                { num: 2, name: 'media', label: 'Media Analysis' },
                { num: 3, name: 'regulatory', label: 'Regulatory Analysis' },
                { num: 4, name: 'trends', label: 'Trend Analysis' },
                { num: 5, name: 'synthesis', label: 'Intelligence Synthesis' }
            ];
            
            const stagesContainer = document.getElementById('analysis-stages');
            stagesContainer.innerHTML = '';
            
            for (const stage of stages) {
                const stageCard = document.createElement('div');
                stageCard.className = 'result-card';
                stageCard.innerHTML = `
                    <h4>Stage ${stage.num}: ${stage.label}</h4>
                    <div class="status running">Running...</div>
                `;
                stagesContainer.appendChild(stageCard);
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligence-stage-${stage.num}-${stage.name}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({
                            organization,
                            previousResults: stageResults,
                            intelligence: collectionData
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        stageResults[stage.name] = result;
                        stageCard.querySelector('.status').className = 'status success';
                        stageCard.querySelector('.status').textContent = '‚úÖ Complete';
                    } else {
                        stageCard.querySelector('.status').className = 'status error';
                        stageCard.querySelector('.status').textContent = '‚ùå Failed';
                    }
                } catch (error) {
                    stageCard.querySelector('.status').className = 'status error';
                    stageCard.querySelector('.status').textContent = `‚ùå ${error.message}`;
                }
                
                updateProgress(30 + (stage.num * 10));
            }
        }
        
        async function detectOpportunities(stageResults) {
            // Extract opportunities from stage results
            const opportunities = [];
            
            if (stageResults.media?.opportunities) {
                opportunities.push(...stageResults.media.opportunities);
            }
            if (stageResults.regulatory?.risks_and_opportunities?.opportunities) {
                opportunities.push(...stageResults.regulatory.risks_and_opportunities.opportunities);
            }
            if (stageResults.trends?.emerging_opportunities) {
                opportunities.push(...stageResults.trends.emerging_opportunities);
            }
            if (stageResults.synthesis?.consolidated_opportunities?.prioritized_list) {
                opportunities.push(...stageResults.synthesis.consolidated_opportunities.prioritized_list);
            }
            
            return opportunities;
        }
        
        function showFinalResults() {
            const resultsSection = document.getElementById('final-results');
            resultsSection.style.display = 'block';
            
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            
            // Summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'result-card';
            summaryCard.innerHTML = `
                <h4>üìä Pipeline Summary</h4>
                <p><strong>Organization:</strong> ${organizationProfile?.name}</p>
                <p><strong>Industry:</strong> ${organizationProfile?.industry}</p>
                <p><strong>Signals Collected:</strong> ${collectionData?.raw_signals?.length || 0}</p>
                <p><strong>Stages Completed:</strong> ${Object.keys(stageResults).length}/5</p>
            `;
            container.appendChild(summaryCard);
            
            // Stage results
            for (const [stage, data] of Object.entries(stageResults)) {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <h4>${stage.charAt(0).toUpperCase() + stage.slice(1)}</h4>
                    <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                `;
                container.appendChild(card);
            }
        }
        
        function clearAll() {
            ['discovery', 'collection', 'analysis', 'opportunities'].forEach(stage => {
                updateStatus(stage, 'pending', 'Pending');
                const logEl = document.getElementById(`log-${stage}`);
                if (logEl) {
                    logEl.style.display = 'none';
                    logEl.innerHTML = '';
                }
            });
            
            document.getElementById('analysis-stages').innerHTML = '';
            document.getElementById('final-results').style.display = 'none';
            updateProgress(0);
            
            organizationProfile = null;
            collectionData = null;
            stageResults = {};
        }
    </script>
</body>
</html>